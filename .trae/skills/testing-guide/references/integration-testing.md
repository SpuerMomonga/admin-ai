# 集成测试策略

## 目标

- 验证模块协作是否符合契约（输入/输出/事务/一致性）
- 覆盖真实 I/O 交互（数据库、HTTP、消息队列）及其失败模式
- 为发布提供回归防线（尤其是关键链路）

## 选择集成测试的信号

- 需要验证 SQL/ORM 映射、事务、索引约束
- 需要验证与外部系统的协议（HTTP 状态码、重试、超时）
- 需要验证跨模块编排（多个 Repository/Client 的组合行为）

## 环境原则

- 测试环境与生产尽量一致（同版本数据库、同配置关键项）
- 隔离性优先：每个测试用例独立数据空间（事务回滚、独立 schema、测试库）
- 可重复：种子数据固定，外部依赖可控（容器/本地 stub）

## 数据库集成测试建议

- 数据准备：
  - 工厂/fixture 创建最小数据集
  - 避免依赖“共享的全量 seed”，防止耦合与不稳定
- 清理策略：
  - 事务包裹后回滚
  - 或每用例后清空相关表/重建 schema
- 断言策略：
  - 断言关键字段、行数、约束行为（唯一性、外键、非空）
  - 避免断言无关列或自动生成字段的精确值（可使用模式匹配）

## 外部 HTTP/消息系统

- 优先契约化验证：请求方法/路径/头/签名/响应码/重试语义
- 分层替身策略：
  - 单元测试：mock client
  - 集成测试：本地 stub server 或容器化依赖
  - 端到端：尽量少量，覆盖关键冒烟路径

## 并发与一致性

- 涉及幂等/重试/并发写入的逻辑必须有集成覆盖
- 用例至少包含：
  - 幂等键重复请求
  - 重试导致的重复写入防护
  - 并发更新冲突（乐观锁/版本号/唯一约束）

