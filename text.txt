<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wxwy.intelligentOptimization.dao.postgresql.despoilStart.AppIoStarRankMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.wxwy.intelligentOptimization.moudle.entity.despoilStar.AppIoStarRank">
        <result column="area" property="area"/>
        <result column="area_name" property="areaName"/>
        <result column="voice_quality" property="voiceQuality"/>
        <result column="internet_quality" property="internetQuality"/>
        <result column="network_quality_dx" property="networkQualityDx"/>
        <result column="network_quality_yd" property="networkQualityYd"/>
        <result column="network_quality_lt" property="networkQualityLt"/>
        <result column="quarter_lead" property="quarterLead"/>
        <result column="local_rank" property="localRank"/>
        <result column="satisfaction_score" property="satisfactionScore"/>
        <result column="satisfaction_quarter" property="satisfactionQuarter"/>
        <result column="satisfaction_month" property="satisfactionMonth"/>
        <result column="in_deal_rate" property="inDealRate"/>
        <result column="repetition_rate" property="repetitionRate"/>
        <result column="in_deal_score" property="inDealScore"/>
        <result column="repetition_score" property="repetitionScore"/>
        <result column="barrier_score" property="barrierScore"/>
        <result column="barrier_month" property="barrierMonth"/>
        <result column="deal_complaint_rate" property="dealComplaintRate"/>
        <result column="complaint_score" property="complaintScore"/>
        <result column="complaint_month" property="complaintMonth"/>
        <result column="friendly_cover_rate" property="friendlyCoverRate"/>
        <result column="friendly_cover_score" property="friendlyCoverScore"/>
        <result column="bad_cover_rate" property="badCoverRate"/>
        <result column="bad_cover_score" property="badCoverScore"/>
        <result column="cover_month" property="coverMonth"/>
        <result column="four_high_load_rate" property="fourHighLoadRate"/>
        <result column="five_high_load_rate" property="fiveHighLoadRate"/>
        <result column="high_load_rate" property="highLoadRate"/>
        <result column="two_single_rate" property="twoSingleRate"/>
        <result column="high_load_rate_score" property="highLoadRateScore"/>
        <result column="two_single_score" property="twoSingleScore"/>
        <result column="high_load_score" property="highLoadScore"/>
        <result column="high_load_month" property="highLoadMonth"/>
        <result column="four_zero_flow_rate" property="fourZeroFlowRate"/>
        <result column="five_zero_flow_rate" property="fiveZeroFlowRate"/>
        <result column="zero_flow_rate" property="zeroFlowRate"/>
        <result column="four_zero_flow_score" property="fourZeroFlowScore"/>
        <result column="five_zero_flow_score" property="fiveZeroFlowScore"/>
        <result column="zero_flow_score" property="zeroFlowScore"/>
        <result column="zero_score" property="zeroScore"/>
        <result column="zero_flow_month" property="zeroFlowMonth"/>
        <result column="four_quality_difference_rate" property="fourQualityDifferenceRate"/>
        <result column="five_quality_difference_rate" property="fiveQualityDifferenceRate"/>
        <result column="quality_difference_rate" property="qualityDifferenceRate"/>
        <result column="four_quality_difference_score" property="fourQualityDifferenceScore"/>
        <result column="five_quality_difference_score" property="fiveQualityDifferenceScore"/>
        <result column="quality_difference_score" property="qualityDifferenceScore"/>
        <result column="quality_score" property="qualityScore"/>
        <result column="quality_month" property="qualityMonth"/>
        <result column="cel_avg_duration" property="celAvgDuration"/>
        <result column="cel_avg_duration_score" property="celAvgDurationScore"/>
        <result column="maintain_month" property="maintainMonth"/>
        <result column="over_length_rate" property="overLengthRate"/>
        <result column="over_length_score" property="overLengthScore"/>
        <result column="over_length_month" property="overLengthMonth"/>
        <result column="data_full_rate" property="dataFullRate"/>
        <result column="data_exact_rate" property="dataExactRate"/>
        <result column="data_full_score" property="dataFullScore"/>
        <result column="data_exact_score" property="dataExactScore"/>
        <result column="data_govern_score" property="dataGovernScore"/>
        <result column="data_govern_month" property="dataGovernMonth"/>
        <result column="test_kilometre" property="testKilometre"/>
        <result column="test_analyse_score" property="testAnalyseScore"/>
        <result column="base_optimize_num" property="baseOptimizeNum"/>
        <result column="base_optimize_score" property="baseOptimizeScore"/>
        <result column="data_test_analyse_score" property="dataTestAnalyseScore"/>
        <result column="data_test_analyse_month" property="dataTestAnalyseMonth"/>
        <result column="order_close_rate" property="orderCloseRate"/>
        <result column="strict_close_rate" property="strictCloseRate"/>
        <result column="order_close_score" property="orderCloseScore"/>
        <result column="strict_close_score" property="strictCloseScore"/>
        <result column="close_score" property="closeScore"/>
        <result column="order_close_month" property="orderCloseMonth"/>
        <result column="appraisal_list_deduction" property="appraisalListDeduction"/>
        <result column="appraisal_deduction_of_points" property="appraisalDeductionOfPoints"/>
        <result column="appraisal_month" property="appraisalMonth"/>
        <result column="out_serve_times_month" property="outServeTimesMonth"/>
        <result column="out_serve_month" property="outServeMonth"/>
        <result column="out_serve_times_quarter" property="outServeTimesQuarter"/>
        <result column="out_serve_quarter" property="outServeQuarter"/>
        <result column="out_serve_deduction_of_points" property="outServeDeductionOfPoints"/>
        <result column="often_break_rate" property="oftenBreakRate"/>
        <result column="often_break_deduction_of_points" property="oftenBreakDeductionOfPoints"/>
        <result column="often_break_month" property="oftenBreakMonth"/>
        <result column="score" property="score"/>
        <result column="star" property="star"/>
        <result column="rank" property="rank"/>
        <result column="color_card" property="colorCard"/>
        <result column="month" property="month"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        area
        , area_name, voice_quality, internet_quality, network_quality_dx, network_quality_yd, network_quality_lt, quarter_lead, local_rank, satisfaction_score, satisfaction_quarter, satisfaction_month, in_deal_rate, repetition_rate, in_deal_score, repetition_score, barrier_score, barrier_month, deal_complaint_rate, complaint_score, complaint_month, friendly_cover_rate, friendly_cover_score, bad_cover_rate, bad_cover_score, cover_month, four_high_load_rate, five_high_load_rate, high_load_rate, two_single_rate, high_load_rate_score, two_single_score, high_load_score, high_load_month, four_zero_flow_rate, five_zero_flow_rate, zero_flow_rate, four_zero_flow_score, five_zero_flow_score, zero_flow_score, zero_score, zero_flow_month, four_quality_difference_rate, five_quality_difference_rate, quality_difference_rate, four_quality_difference_score, five_quality_difference_score, quality_difference_score, quality_score, quality_month, cel_avg_duration, cel_avg_duration_score, maintain_month, over_length_rate, over_length_score, over_length_month, data_full_rate, data_exact_rate, data_full_score, data_exact_score, data_govern_score, data_govern_month, test_kilometre, test_analyse_score, base_optimize_num, base_optimize_score, data_test_analyse_score, data_test_analyse_month, order_close_rate, strict_close_rate, order_close_score, strict_close_score, close_score, order_close_month, appraisal_list_deduction, appraisal_deduction_of_points, appraisal_month, out_serve_times_month, out_serve_month, out_serve_times_quarter, out_serve_quarter, out_serve_deduction_of_points, often_break_rate, often_break_deduction_of_points, often_break_month, score, star, rank, color_card, month
    </sql>
    <insert id="saveData">
        insert into app_io_star_rank (
            area,
            area_name,
            voice_quality,
            internet_quality,
            network_quality_dx,
            network_quality_yd,
            network_quality_lt,
            quarter_lead,
            local_rank,
            satisfaction_score,
            satisfaction_quarter,
            satisfaction_month,
            in_deal_rate,
            repetition_rate,
            in_deal_score,
            repetition_score,
            barrier_score,
            barrier_month,
            deal_complaint_rate,
            complaint_score,
            complaint_month,
            friendly_cover_rate,
            friendly_cover_score,
            bad_cover_rate,
            bad_cover_score,
            cover_month,
            four_high_load_rate,
            five_high_load_rate,
            high_load_rate,
            two_single_rate,
            high_load_rate_score,
            two_single_score,
            high_load_score,
            high_load_month,
            four_zero_flow_rate,
            five_zero_flow_rate,
            zero_flow_rate,
            four_zero_flow_score,
            five_zero_flow_score,
            zero_flow_score,
            zero_score,
            zero_flow_month,
            four_quality_difference_rate,
            five_quality_difference_rate,
            quality_difference_rate,
            four_quality_difference_score,
            five_quality_difference_score,
            quality_difference_score,
            quality_score,
            quality_month,
            cel_avg_duration,
            cel_avg_duration_score,
            maintain_month,
            over_length_rate,
            over_length_score,
            over_length_month,
            data_full_rate,
            data_exact_rate,
            data_full_score,
            data_exact_score,
            data_govern_score,
            data_govern_month,
            test_kilometre,
            test_analyse_score,
            base_optimize_num,
            base_optimize_score,
            data_test_analyse_score,
            data_test_analyse_month,
            order_close_rate,
            strict_close_rate,
            order_close_score,
            strict_close_score,
            close_score,
            order_close_month,
            appraisal_list_deduction,
            appraisal_deduction_of_points,
            appraisal_month,
            out_serve_times_month,
            out_serve_month,
            out_serve_times_quarter,
            out_serve_quarter,
            out_serve_deduction_of_points,
            often_break_rate,
            often_break_deduction_of_points,
            often_break_month,
            score,
            star,
            rank,
            color_card,
            month,
            gmt_create,
            new_long_break_rate,
            new_long_break_score,
            new_often_break_rate,
            new_often_break_score,
            base_break_score,
            base_break_month,
            new_order_close_rate,
            new_strict_order_close_rate,
            new_maintain_order_close_rate,
            new_order_close_score,
            new_strict_order_close_score,
            new_maintain_order_close_score,
            new_close_score,
            new_order_close_month,
            pressure_drop_rate,
            pressure_drop_deduction_of_points,
            pressure_drop_month,
            repetition_order_rate,
            repetition_order_deduction_of_points,
            repetition_order_month,
            poor_benefit_rate,
            poor_benefit_deduction_of_points,
            poor_benefit_month,
            builder,
            move_barrier_favorable_rate,
            move_barrier_favorable_score,
            move_barrier_favorable_month,
            fault_out_serve_times_month,
            fault_out_serve_times_quarter,
            fault_out_serve_times_score,
            fault_out_serve_month,
            fault_often_break_rate,
            fault_often_break_score,
            fault_often_break_month,
            four_key_scene_quality_rate,
            pressure_drop_value,
            four_key_scene_quality_score,
            pressure_drop_value_score,
            key_scene_quality_score,
            key_scene_quality_month,
            four_weak_cover_rate,
            five_weak_cover_rate,
            four_weak_cover_score,
            five_weak_cover_score,
            weak_cover_score,
            weak_cover_month,
            four_instability_rate,
            four_deduction_of_points,
            five_instability_rate,
            five_deduction_of_points,
            feedback_system_instability_month,
            new_poor_benefit_average,
            new_poor_benefit_reach,
            new_poor_benefit_score,
            new_poor_benefit_month,
            in_response_rate,
            in_response_score,
            three_fault_score
        )
        select area,
               area_name,
               voice_quality,
               internet_quality,
               network_quality_dx,
               network_quality_yd,
               network_quality_lt,
               quarter_lead,
               local_rank,
               satisfaction_score,
               satisfaction_quarter,
               satisfaction_month,
               in_deal_rate,
               repetition_rate,
               in_deal_score,
               repetition_score,
               barrier_score,
               barrier_month,
               deal_complaint_rate,
               complaint_score,
               complaint_month,
               friendly_cover_rate,
               friendly_cover_score,
               bad_cover_rate,
               bad_cover_score,
               cover_month,
               four_high_load_rate,
               five_high_load_rate,
               high_load_rate,
               two_single_rate,
               high_load_rate_score,
               two_single_score,
               high_load_score,
               high_load_month,
               four_zero_flow_rate,
               five_zero_flow_rate,
               zero_flow_rate,
               four_zero_flow_score,
               five_zero_flow_score,
               zero_flow_score,
               zero_score,
               zero_flow_month,
               four_quality_difference_rate,
               five_quality_difference_rate,
               quality_difference_rate,
               four_quality_difference_score,
               five_quality_difference_score,
               quality_difference_score,
               quality_score,
               quality_month,
               cel_avg_duration,
               cel_avg_duration_score,
               maintain_month,
               over_length_rate,
               over_length_score,
               over_length_month,
               data_full_rate,
               data_exact_rate,
               data_full_score,
               data_exact_score,
               data_govern_score,
               data_govern_month,
               test_kilometre,
               test_analyse_score,
               base_optimize_num,
               base_optimize_score,
               data_test_analyse_score,
               data_test_analyse_month,
               order_close_rate,
               strict_close_rate,
               order_close_score,
               strict_close_score,
               close_score,
               order_close_month,
               appraisal_list_deduction,
               appraisal_deduction_of_points,
               appraisal_month,
               out_serve_times_month,
               out_serve_month,
               out_serve_times_quarter,
               out_serve_quarter,
               out_serve_deduction_of_points,
               often_break_rate,
               often_break_deduction_of_points,
               often_break_month,
               score,
               star,
               RANK ( ) OVER ( PARTITION BY area ORDER BY star DESC ) as rank,
                color_card,
                month,
                gmt_create,
                new_long_break_rate,
                new_long_break_score,
                new_often_break_rate,
                new_often_break_score,
                base_break_score,
                base_break_month,
                new_order_close_rate,
                new_strict_order_close_rate,
                new_maintain_order_close_rate,
                new_order_close_score,
                new_strict_order_close_score,
                new_maintain_order_close_score,
                new_close_score,
                new_order_close_month,
                pressure_drop_rate,
                pressure_drop_deduction_of_points,
                pressure_drop_month,
                repetition_order_rate,
                repetition_order_deduction_of_points,
                repetition_order_month,
                poor_benefit_rate,
                poor_benefit_deduction_of_points,
                poor_benefit_month,
                builder,
                move_barrier_favorable_rate,
                move_barrier_favorable_score,
                move_barrier_favorable_month,
                fault_out_serve_times_month,
                fault_out_serve_times_quarter,
                fault_out_serve_times_score,
                fault_out_serve_month,
                fault_often_break_rate,
                fault_often_break_score,
                fault_often_break_month,
                four_key_scene_quality_rate,
                pressure_drop_value,
                four_key_scene_quality_score,
                pressure_drop_value_score,
                key_scene_quality_score,
                key_scene_quality_month,
                four_weak_cover_rate,
                five_weak_cover_rate,
                four_weak_cover_score,
                five_weak_cover_score,
                weak_cover_score,
                weak_cover_month,
                four_instability_rate,
                four_deduction_of_points,
                five_instability_rate,
                five_deduction_of_points,
                feedback_system_instability_month,
                new_poor_benefit_average,
                new_poor_benefit_reach,
                new_poor_benefit_score,
                new_poor_benefit_month,
                in_response_rate,
                in_response_score,
                three_fault_score
        from app_io_star_rank_item
        where task_id = #{taskId}
    </insert>
    <update id="updateRank">
        <foreach collection="list" separator=";" item="item">
            update app_io_star_rank set color_card = #{item.color} where area = #{item.area} and month = #{item.month} and is_system = 0
        </foreach>
    </update>

    <select id="getMaxMonth" resultType="java.lang.Integer">
        select max(month)
        from app_io_star_rank
    </select>
    <select id="areaGeneralSituation" resultType="com.wxwy.intelligentOptimization.moudle.vo.despoilStar.StartBaseVO">
        with tba as (select
        r.area as area,
        r.area_name as areaName,
        array_agg(round(r.score,0) order by r.month,',') as score,
        array_agg(r.star order by r.month,',')as star,
        array_agg(coalesce(r.color_card,c.color) order by r.month,',') as cardColor,
        array_agg(r.month order by r.month,',') as month,
        max(r.gmt_create) as gmt_create
        from app_io_star_rank r
        left join app_io_star_card_color c on r.area_name = c.area_name and r.month = c.month
        where r.month in
        <foreach collection="list" open="(" close=")" separator="," item="item" index="index">
            #{item}
        </foreach>
        group by r.area,r.area_name ),
        tbb as (
        select area,area_name ,
        array_agg(rank_by_score order by r.month,',')as rank_by_score,
        array_agg(r.month order by r.month,',') as month
        from (
        select area,
        area_name,
        score,
        dense_rank() OVER (partition by area,month ORDER BY score DESC) AS rank_by_score,
        month
        from app_io_star_rank
        where month in
        <foreach collection="list" open="(" close=")" separator="," item="item" index="index">
            #{item}
        </foreach>
        ) r
        group by area,area_name
        )
        SELECT
        tba.area,
        areaName,
        case when array_length(cardColor,1)=1 then cardColor [1] else cardColor [2] end AS cardColor,
        case when tbb.rank_by_score [ 2 ] is null then tbb.rank_by_score [ 1 ] else tbb.rank_by_score [ 2 ] end RANK,
        case when tbb.rank_by_score [ 2 ] is null then 0 when tbb.rank_by_score [ 1 ] is null then null else
        -(tbb.rank_by_score [ 2 ]- tbb.rank_by_score [ 1 ]) end AS rankUpOrDown,
        case when tba.score [ 2 ] is null then (tba.score [ 1 ])::numeric else (tba.score [ 2 ])::numeric end AS score,
        case when tba.star [ 2 ] is null then tba.star [ 1 ] else tba.star [ 2 ] end AS star,
        case when tba.MONTH [ 2 ] is null then tba.MONTH [ 1 ] else tba.MONTH [ 2 ] end AS MONTH,
        tba.gmt_create AS gmtCreate
        FROM
        tba
        LEFT JOIN tbb ON tba.areaName = tbb.area_name
    </select>
    <select id="getStarTendencyChart"
            resultType="com.wxwy.intelligentOptimization.moudle.vo.despoilStar.TendencyChartBaseVO">
        with tba as (select
        r.area as area,
        r.area_name as areaName,
        array_agg(r.score order by r.month,',') as score,
        array_agg(r.month order by r.month,',') as month
        from app_io_star_rank r
        where r.month in
        <foreach collection="list" open="(" close=")" separator="," item="item" index="index">
            #{item}
        </foreach>
        group by r.area,r.area_name)
        select area,
        areaName,
        score[1] as scoreFirst,
        score[2] as scoreSecond,
        concat(month[1]::varchar,',',month[2]::varchar) as month
        from tba
    </select>
    <select id="indicatorTop" resultType="com.wxwy.intelligentOptimization.moudle.vo.IndicatorTopVO">
        with tba as (SELECT * FROM "app_io_star_rank" where month = #{month}),
            result as (
        select
            '满意度测评' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where satisfaction_score = 0
        union all
        select
            '移动障碍工单处理质量' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where barrier_score = 0
        union all
        select
            'TOP栅格投诉处置率' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where complaint_score = 0
        union all
        select
            '4/5G竞对友商覆盖率' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where friendly_cover_score = 0
        union all
        select
            '4/5G弱覆盖且劣于竞对物业点占比' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where bad_cover_score = 0
        union all
        select
            '4/5G高负荷小区比例' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where high_load_score = 0
        union all
        select
            '4/5G零流量小区比例' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where zero_score = 0
        union all
        select
            '4/5G质差小区比例' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where quality_score = 0
        union all
        select
            '4/5G基站AB类小区平均退服时长' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where cel_avg_duration_score = 0
        <choose>
            <when test="month &lt; 202408">
                union all
                select
                '超长断站率' as indicatorName,
                count (*) as num,
                string_agg(area_name, '、') as areaNameList
                from tba
                where over_length_score = 0
            </when>
            <otherwise>
                union all
                select
                '基站断站率' as indicatorName,
                count (*) as num,
                string_agg(area_name, '、') as areaNameList
                from tba
                where base_break_score = 0
            </otherwise>
        </choose>

        union all
        select
            '基础数据治理' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where data_govern_score = 0
        union all
        select
            '数据测试分析及基站优化' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where data_test_analyse_score = 0
        <choose>
            <when test="month &lt; 202408">
                union all
                select
                '工单闭环率' as indicatorName,
                count (*) as num,
                string_agg(area_name, '、') as areaNameList
                from tba
                where close_score = 0
            </when>
            <otherwise>
                union all
                select
                '工单闭环率' as indicatorName,
                count (*) as num,
                string_agg(area_name, '、') as areaNameList
                from tba
                where new_close_score = 0
            </otherwise>
        </choose>
        )
        select rank() over(order by num desc) as sort, num,
               indicatorName,
               areaNameList
        from (
                 select indicatorName,
                        num,
                        areaNameList
                 from result
                 order by num desc limit 3) a
    </select>
    <select id="deductionOfPoints"
            resultType="com.wxwy.intelligentOptimization.moudle.vo.despoilStar.DeductionOfPointsVO">
        with tba as (SELECT * FROM "app_io_star_rank" where month = #{month}),
            result as (


            <choose>
                <when test="month &lt; 202408">
                    select
                    '批量退服次数' as indicatorName,
                    coalesce (string_agg(area_name, '、'),'') as areaNameList
                    from tba
                    where out_serve_deduction_of_points != 0 and out_serve_deduction_of_points is not null
                    union all
                    select
                    '集团测评清单扣罚' as indicatorName,
                    coalesce (string_agg(area_name, '、'),'') as areaNameList
                    from tba
                    where appraisal_deduction_of_points != 0 and appraisal_deduction_of_points is not null
                    union all
                    select
                    '频繁断站' as indicatorName,
                    coalesce (string_agg(area_name, '、'),'') as areaNameList
                    from tba
                    where often_break_deduction_of_points != 0 and often_break_deduction_of_points is not null
                </when>
                <when test="month &lt; 202501">
                    select
                    '批量退服次数' as indicatorName,
                    coalesce (string_agg(area_name, '、'),'') as areaNameList
                    from tba
                    where out_serve_deduction_of_points != 0 and out_serve_deduction_of_points is not null
                    union all
                    select
                    '"三超"压降' as indicatorName,
                    coalesce (string_agg(area_name, '、'),'') as areaNameList
                    from tba
                    where pressure_drop_deduction_of_points != 0 and pressure_drop_deduction_of_points is not null
                    union all
                    select
                    '重复工单压降' as indicatorName,
                    coalesce (string_agg(area_name, '、'),'') as areaNameList
                    from tba
                    where repetition_order_deduction_of_points != 0 and repetition_order_deduction_of_points is not null
                    union all
                    select
                    '低效益站址压降' as indicatorName,
                    coalesce (string_agg(area_name, '、'),'') as areaNameList
                    from tba
                    where poor_benefit_deduction_of_points != 0 and poor_benefit_deduction_of_points is not null
                </when>
                <otherwise>
                    select
                    '4G BBU GNSS天馈系统不稳定率扣分' as indicatorName,
                    coalesce (string_agg(area_name, '、'),'') as areaNameList
                    from tba
                    where  four_deduction_of_points != 0 and four_deduction_of_points is not null
                    union all
                    select
                    '5G BBU GNSS天馈系统不稳定率扣分' as indicatorName,
                    coalesce (string_agg(area_name, '、'),'') as areaNameList
                    from tba
                    where five_deduction_of_points != 0 and five_deduction_of_points is not null
                </otherwise>
            </choose>
        )

        select *
        from result
    </select>
    <select id="downLoadDetailInfo"
            resultType="com.wxwy.intelligentOptimization.moudle.vo.despoilStar.AppIoStarRankAllVO">
        select area,
        area_name,
        quarter_lead,
        local_rank,
        satisfaction_score,
        satisfaction_quarter,
        satisfaction_month,
        in_deal_rate,
        repetition_rate,
        in_deal_score,
        repetition_score,
        barrier_score,
        barrier_month,
        deal_complaint_rate,
        complaint_score,
        complaint_month,
        friendly_cover_rate,
        friendly_cover_score,
        bad_cover_rate,
        bad_cover_score,
        cover_month,
        four_high_load_rate,
        five_high_load_rate,
        high_load_rate,
        two_single_rate,
        high_load_rate_score,
        two_single_score,
        high_load_score,
        high_load_month,
        four_zero_flow_rate,
        five_zero_flow_rate,
        zero_flow_rate,
        four_zero_flow_score,
        five_zero_flow_score,
        zero_flow_score,
        zero_score,
        zero_flow_month,
        four_quality_difference_rate,
        five_quality_difference_rate,
        quality_difference_rate,
        four_quality_difference_score,
        five_quality_difference_score,
        quality_difference_score,
        quality_score,
        quality_month,
        cel_avg_duration,
        cel_avg_duration_score,
        maintain_month,
        over_length_rate,
        over_length_score,
        over_length_month,
        data_full_rate,
        data_exact_rate,
        data_full_score,
        data_exact_score,
        data_govern_score,
        data_govern_month,
        test_kilometre,
        test_analyse_score,
        base_optimize_num,
        base_optimize_score,
        data_test_analyse_score,
        data_test_analyse_month,
        order_close_rate,
        strict_close_rate,
        order_close_score,
        strict_close_score,
        close_score,
        order_close_month,
        appraisal_list_deduction,
        appraisal_deduction_of_points,
        appraisal_month,
        out_serve_times_month,
        out_serve_month,
        out_serve_times_quarter,
        out_serve_quarter,
        out_serve_deduction_of_points,
        often_break_rate,
        often_break_deduction_of_points,
        often_break_month,
        score,
        star,
        rank,
        color_card,
        month,
        new_long_break_rate,
        new_long_break_score,
        new_often_break_rate,
        new_often_break_score,
        base_break_score,
        base_break_month,
        new_order_close_rate,
        new_strict_order_close_rate,
        new_maintain_order_close_rate,
        new_order_close_score,
        new_strict_order_close_score,
        new_maintain_order_close_score,
        new_close_score,
        new_order_close_month,
        pressure_drop_rate,
        pressure_drop_deduction_of_points,
        pressure_drop_month,
        repetition_order_rate,
        repetition_order_deduction_of_points,
        repetition_order_month,
        poor_benefit_rate,
        poor_benefit_deduction_of_points,
        poor_benefit_month
        from app_io_star_rank
        where month = #{month}
        <if test="areaName!=null and areaName != ''">
            and area_name = #{areaName}
        </if>
    </select>
    <select id="generateRankTable"
            resultType="com.wxwy.intelligentOptimization.moudle.vo.despoilStar.GenerateStarRankCardVO">
        WITH area as(
        select area,area_name from dim_io_star_area_conf
        ),
        appraisal AS ( SELECT area, area_name, appraisal_list_deduction, deduction_of_points, MONTH, gmt_create FROM
        app_io_star_appraisal_deduction
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_appraisal_deduction)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        cover AS (
        SELECT
        area,
        area_name,
        friendly_cover_rate,
        friendly_cover_score,
        bad_cover_rate,
        bad_cover_score,
        ( friendly_cover_score + bad_cover_score ) AS score,
        MONTH,
        gmt_create
        FROM
        app_io_star_cover
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_cover)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>

        ),
        data_govern AS ( SELECT area, area_name, data_full_rate, data_exact_rate, data_full_score, data_exact_score,
        score, MONTH, gmt_create FROM app_io_star_data_govern WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_data_govern)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        data_test AS ( SELECT area, area_name, test_kilometre, test_analyse_score, base_optimize_num,
        base_optimize_score, score, MONTH, gmt_create FROM app_io_star_data_test_analyse WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_data_test_analyse)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        deal_complaint AS ( SELECT area, area_name, deal_complaint_rate, score, MONTH, gmt_create FROM
        app_io_star_deal_complaint WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_deal_complaint)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        high_load AS (
        SELECT
        area,
        area_name,
        four_high_load_rate,
        five_high_load_rate,
        high_load_rate,
        rate,
        MONTH,
        high_load_score,
        rate_score,
        score,
        gmt_create
        FROM
        app_io_star_high_load
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_high_load)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        maintain AS ( SELECT area, area_name, cel_avg_duration, cel_avg_duration_score, MONTH, gmt_create FROM
        app_io_star_maintain WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_maintain)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        move_barrier AS ( SELECT area, area_name, in_deal_rate, repetition_rate, in_deal_score, repetition_score, score,
        MONTH, gmt_create FROM app_io_star_move_barrier WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_move_barrier)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        often_break AS ( SELECT area, area_name, often_break_rate, deduction_of_points, MONTH, gmt_create FROM
        app_io_star_often_break WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_often_break)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        order_close AS ( SELECT area, area_name, order_close_rate, strict_close_rate, order_close_score,
        strict_close_score, score, MONTH, gmt_create FROM app_io_star_order_close WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_order_close)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        out_serve AS ( SELECT area, area_name, out_serve_times_month, MONTH, out_serve_times_quarter,
        deduction_of_points, quarter, gmt_create FROM app_io_star_out_serve WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_out_serve)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        over_length AS ( SELECT area, area_name, over_length_rate, score, MONTH, gmt_create FROM app_io_star_over_length
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_over_length)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        quality_difference AS (
        SELECT
        area,
        area_name,
        four_quality_difference_rate,
        five_quality_difference_rate,
        quality_difference_rate,
        four_quality_difference_score,
        five_quality_difference_score,
        quality_difference_score,
        score,
        MONTH,
        gmt_create
        FROM
        app_io_star_quality_difference
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_quality_difference)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        satisfaction AS (
        SELECT
        area,
        area_name,
        voice_quality,
        internet_quality,
        network_quality_dx,
        network_quality_yd,
        network_quality_lt,
        quarter_lead,
        local_rank,
        score,
        quarter,
        MONTH,
        gmt_create
        FROM
        app_io_star_satisfaction
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_satisfaction)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        zero_flow AS (
        SELECT
        area,
        area_name,
        four_zero_flow_rate,
        five_zero_flow_rate,
        zero_flow_rate,
        four_zero_flow_score,
        five_zero_flow_score,
        zero_flow_score,
        score,
        MONTH,
        gmt_create
        FROM
        app_io_star_zero_flow
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_zero_flow)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        lastScore AS ( SELECT area, area_name, score, color_card FROM app_io_star_rank WHERE MONTH = #{lastMonth} ),
        lastScoreAfter AS ( SELECT area, area_name, score, color_card FROM app_io_star_rank WHERE MONTH =
        #{lastMonthAfter} ),
        RESULT AS (
        SELECT
        area.area AS area,
        area.area_name AS area_name,
        satisfaction.voice_quality AS voice_quality,
        satisfaction.internet_quality AS internet_quality,
        satisfaction.network_quality_dx AS network_quality_dx,
        satisfaction.network_quality_yd AS network_quality_yd,
        satisfaction.network_quality_lt AS network_quality_lt,
        satisfaction.quarter_lead AS quarter_lead,
        satisfaction.local_rank AS local_rank,
        satisfaction.score AS satisfaction_score,
        satisfaction.quarter AS satisfaction_quarter,
        satisfaction.MONTH AS satisfaction_month,
        move_barrier.in_deal_rate AS in_deal_rate,
        move_barrier.repetition_rate AS repetition_rate,
        move_barrier.in_deal_score AS in_deal_score,
        move_barrier.repetition_score AS repetition_score,
        move_barrier.score AS barrier_score,
        move_barrier.MONTH AS barrier_month,
        deal_complaint.deal_complaint_rate AS deal_complaint_rate,
        deal_complaint.score AS complaint_score,
        deal_complaint.MONTH AS complaint_month,
        cover.friendly_cover_rate AS friendly_cover_rate,
        cover.friendly_cover_score AS friendly_cover_score,
        cover.bad_cover_rate AS bad_cover_rate,
        cover.bad_cover_score AS bad_cover_score,
        cover.MONTH AS cover_month,
        high_load.four_high_load_rate AS four_high_load_rate,
        high_load.five_high_load_rate AS five_high_load_rate,
        high_load.high_load_rate AS high_load_rate,
        high_load.rate AS two_single_rate,
        high_load.high_load_score AS high_load_rate_score,
        high_load.rate_score AS two_single_score,
        high_load.score AS high_load_score,
        high_load.MONTH AS high_load_month,
        zero_flow.four_zero_flow_rate AS four_zero_flow_rate,
        zero_flow.five_zero_flow_rate AS five_zero_flow_rate,
        zero_flow.zero_flow_rate AS zero_flow_rate,
        zero_flow.four_zero_flow_score AS four_zero_flow_score,
        zero_flow.five_zero_flow_score AS five_zero_flow_score,
        zero_flow.zero_flow_score AS zero_flow_score,
        zero_flow.score AS zero_score,
        zero_flow.MONTH AS zero_flow_month,
        quality_difference.four_quality_difference_rate AS four_quality_difference_rate,
        quality_difference.five_quality_difference_rate AS five_quality_difference_rate,
        quality_difference.quality_difference_rate AS quality_difference_rate,
        quality_difference.four_quality_difference_score AS four_quality_difference_score,
        quality_difference.five_quality_difference_score AS five_quality_difference_score,
        quality_difference.quality_difference_score AS quality_difference_score,
        quality_difference.score AS quality_score,
        quality_difference.MONTH AS quality_month,
        maintain.cel_avg_duration AS cel_avg_duration,
        maintain.cel_avg_duration_score AS cel_avg_duration_score,
        maintain.MONTH AS maintain_month,
        over_length.over_length_rate AS over_length_rate,
        over_length.score AS over_length_score,
        over_length.MONTH AS over_length_month,
        data_govern.data_full_rate AS data_full_rate,
        data_govern.data_exact_rate AS data_exact_rate,
        data_govern.data_full_score AS data_full_score,
        data_govern.data_exact_score AS data_exact_score,
        data_govern.score AS data_govern_score,
        data_govern.MONTH AS data_govern_month,
        data_test.test_kilometre AS test_kilometre,
        data_test.test_analyse_score AS test_analyse_score,
        data_test.base_optimize_num AS base_optimize_num,
        data_test.base_optimize_score AS base_optimize_score,
        data_test.score AS data_test_analyse_score,
        data_test.MONTH AS data_test_analyse_month,
        order_close.order_close_rate AS order_close_rate,
        order_close.strict_close_rate AS strict_close_rate,
        order_close.order_close_score AS order_close_score,
        order_close.strict_close_score AS strict_close_score,
        order_close.score AS close_score,
        order_close.MONTH AS order_close_month,
        appraisal.appraisal_list_deduction AS appraisal_list_deduction,
        appraisal.deduction_of_points AS appraisal_deduction_of_points,
        appraisal.MONTH AS appraisal_month,
        out_serve.out_serve_times_month AS out_serve_times_month,
        out_serve.MONTH AS out_serve_month,
        out_serve.out_serve_times_quarter AS out_serve_times_quarter,
        out_serve.quarter AS out_serve_quarter,
        out_serve.deduction_of_points AS out_serve_deduction_of_points,
        often_break.often_break_rate AS often_break_rate,
        often_break.deduction_of_points AS often_break_deduction_of_points,
        often_break.MONTH AS often_break_month,
        (
        - COALESCE(appraisal.deduction_of_points,0) - COALESCE(often_break.deduction_of_points,0) -
        COALESCE(out_serve.deduction_of_points,0) + COALESCE(cover.score,0) + COALESCE(data_govern.score,0) +
        COALESCE(data_test.score,0) + COALESCE(deal_complaint.score,0) + COALESCE(high_load.score,0) +
        COALESCE(maintain.cel_avg_duration_score,0) + COALESCE(move_barrier.score,0) + COALESCE(order_close.score,0) +
        COALESCE(over_length.score,0) + COALESCE(quality_difference.score,0) + COALESCE(satisfaction.score,0) +
        COALESCE(zero_flow.score,0)
        ) AS score,
        CASE

        WHEN (
        (
        (
        - COALESCE(appraisal.deduction_of_points,0) - COALESCE(often_break.deduction_of_points,0) -
        COALESCE(out_serve.deduction_of_points,0) + COALESCE(cover.score,0) + COALESCE(data_govern.score,0) +
        COALESCE(data_test.score,0) + COALESCE(deal_complaint.score,0) + COALESCE(high_load.score,0) +
        COALESCE(maintain.cel_avg_duration_score,0) + COALESCE(move_barrier.score,0) + COALESCE(order_close.score,0) +
        COALESCE(over_length.score,0) + COALESCE(quality_difference.score,0) + COALESCE(satisfaction.score,0) +
        COALESCE(zero_flow.score,0)
        ) / 10
        ) :: INT
        ) > 10 THEN
        10 ELSE (
        (
        - COALESCE(appraisal.deduction_of_points,0) - COALESCE(often_break.deduction_of_points,0) -
        COALESCE(out_serve.deduction_of_points,0) + COALESCE(cover.score,0) + COALESCE(data_govern.score,0) +
        COALESCE(data_test.score,0) + COALESCE(deal_complaint.score,0) + COALESCE(high_load.score,0) +
        COALESCE(maintain.cel_avg_duration_score,0) + COALESCE(move_barrier.score,0) + COALESCE(order_close.score,0) +
        COALESCE(over_length.score,0) + COALESCE(quality_difference.score,0) + COALESCE(satisfaction.score,0) +
        COALESCE(zero_flow.score,0)
        ) / 10
        ) :: INT
        END star,
        lastScore.score AS lastScore,
        lastScore.color_card AS lastColorCard,
        lastScoreAfter.score AS lastScoreAfter,
        lastScoreAfter.color_card AS lastColorCardAfter
        FROM area
        left join appraisal on area.area = appraisal.area
        and area.area_name = appraisal.area_name
        LEFT JOIN cover ON area.area = cover.area
        AND area.area_name = cover.area_name
        LEFT JOIN data_govern ON area.area = data_govern.area
        AND area.area_name = data_govern.area_name
        LEFT JOIN data_test ON area.area = data_test.area
        AND area.area_name = data_test.area_name
        LEFT JOIN deal_complaint ON area.area = deal_complaint.area
        AND area.area_name = deal_complaint.area_name
        LEFT JOIN high_load ON area.area = high_load.area
        AND area.area_name = high_load.area_name
        LEFT JOIN maintain ON area.area = maintain.area
        AND area.area_name = maintain.area_name
        LEFT JOIN move_barrier ON area.area = move_barrier.area
        AND area.area_name = move_barrier.area_name
        LEFT JOIN often_break ON area.area = often_break.area
        AND area.area_name = often_break.area_name
        LEFT JOIN order_close ON area.area = order_close.area
        AND area.area_name = order_close.area_name
        LEFT JOIN out_serve ON area.area = out_serve.area
        AND area.area_name = out_serve.area_name
        LEFT JOIN over_length ON area.area = over_length.area
        AND area.area_name = over_length.area_name
        LEFT JOIN quality_difference ON area.area = quality_difference.area
        AND area.area_name = quality_difference.area_name
        LEFT JOIN satisfaction ON area.area = satisfaction.area
        AND area.area_name = satisfaction.area_name
        LEFT JOIN zero_flow ON area.area = zero_flow.area
        AND area.area_name = zero_flow.area_name
        LEFT JOIN lastScore ON area.area = lastScore.area
        AND area.area_name = lastScore.area_name
        LEFT JOIN lastScoreAfter ON area.area = lastScoreAfter.area
        AND area.area_name = lastScoreAfter.area_name
        ) SELECT RESULT
        .area AS area,
        RESULT.area_name AS areaName,
        RESULT.voice_quality AS voiceQuality,
        RESULT.internet_quality AS internetQuality,
        RESULT.network_quality_dx AS networkQualityDx,
        RESULT.network_quality_yd AS networkQualityYd,
        RESULT.network_quality_lt AS networkQualityLt,
        RESULT.quarter_lead AS quarterLead,
        RESULT.local_rank AS localRank,
        RESULT.satisfaction_score AS satisfactionScore,
        RESULT.satisfaction_quarter AS satisfactionQuarter,
        RESULT.satisfaction_month AS satisfactionMonth,
        RESULT.in_deal_rate AS inDealRate,
        RESULT.repetition_rate AS repetitionRate,
        RESULT.in_deal_score AS inDealScore,
        RESULT.repetition_score AS repetitionScore,
        RESULT.barrier_score AS barrierScore,
        RESULT.barrier_month AS barrierMonth,
        RESULT.deal_complaint_rate AS dealComplaintRate,
        RESULT.complaint_score AS complaintScore,
        RESULT.complaint_month AS complaintMonth,
        RESULT.friendly_cover_rate AS friendlyCoverRate,
        RESULT.friendly_cover_score AS friendlyCoverScore,
        RESULT.bad_cover_rate AS badCoverRate,
        RESULT.bad_cover_score AS badCoverScore,
        RESULT.cover_month AS coverMonth,
        RESULT.four_high_load_rate AS fourHighLoadRate,
        RESULT.five_high_load_rate AS fiveHighLoadRate,
        RESULT.high_load_rate AS highLoadRate,
        RESULT.two_single_rate AS twoSingleRate,
        RESULT.high_load_rate_score AS highLoadRateScore,
        RESULT.two_single_score AS twoSingleScore,
        RESULT.high_load_score AS highLoadScore,
        RESULT.high_load_month AS highLoadMonth,
        RESULT.four_zero_flow_rate AS fourZeroFlowRate,
        RESULT.five_zero_flow_rate AS fiveZeroFlowRate,
        RESULT.zero_flow_rate AS zeroFlowRate,
        RESULT.four_zero_flow_score AS fourZeroFlowScore,
        RESULT.five_zero_flow_score AS fiveZeroFlowScore,
        RESULT.zero_flow_score AS zeroFlowScore,
        RESULT.zero_score AS zeroScore,
        RESULT.zero_flow_month AS zeroFlowMonth,
        RESULT.four_quality_difference_rate AS fourQualityDifferenceRate,
        RESULT.five_quality_difference_rate AS fiveQualityDifferenceRate,
        RESULT.quality_difference_rate AS qualityDifferenceRate,
        RESULT.four_quality_difference_score AS fourQualityDifferenceScore,
        RESULT.five_quality_difference_score AS fiveQualityDifferenceScore,
        RESULT.quality_difference_score AS qualityDifferenceScore,
        RESULT.quality_score AS qualityScore,
        RESULT.quality_month AS qualityMonth,
        RESULT.cel_avg_duration AS celAvgDuration,
        RESULT.cel_avg_duration_score AS celAvgDurationScore,
        RESULT.maintain_month AS maintainMonth,
        RESULT.over_length_rate AS overLengthRate,
        RESULT.over_length_score AS overLengthScore,
        RESULT.over_length_month AS overLengthMonth,
        RESULT.data_full_rate AS dataFullRate,
        RESULT.data_exact_rate AS dataExactRate,
        RESULT.data_full_score AS dataFullScore,
        RESULT.data_exact_score AS dataExactScore,
        RESULT.data_govern_score AS dataGovernScore,
        RESULT.data_govern_month AS dataGovernMonth,
        RESULT.test_kilometre AS testKilometre,
        RESULT.test_analyse_score AS testAnalyseScore,
        RESULT.base_optimize_num AS baseOptimizeNum,
        RESULT.base_optimize_score AS baseOptimizeScore,
        RESULT.data_test_analyse_score AS dataTestAnalyseScore,
        RESULT.data_test_analyse_month AS dataTestAnalyseMonth,
        RESULT.order_close_rate AS orderCloseRate,
        RESULT.strict_close_rate AS strictCloseRate,
        RESULT.order_close_score AS orderCloseScore,
        RESULT.strict_close_score AS strictCloseScore,
        RESULT.close_score AS closeScore,
        RESULT.order_close_month AS orderCloseMonth,
        RESULT.appraisal_list_deduction AS appraisalListDeduction,
        RESULT.appraisal_deduction_of_points AS appraisalDeductionOfPoints,
        RESULT.appraisal_month AS appraisalMonth,
        RESULT.out_serve_times_month AS outServeTimesMonth,
        RESULT.out_serve_month AS outServeMonth,
        RESULT.out_serve_times_quarter AS outServeTimesQuarter,
        RESULT.out_serve_quarter AS outServeQuarter,
        RESULT.out_serve_deduction_of_points AS outServeDeductionOfPoints,
        RESULT.often_break_rate AS oftenBreakRate,
        RESULT.often_break_deduction_of_points AS oftenBreakDeductionOfPoints,
        RESULT.often_break_month AS oftenBreakMonth,
        RESULT.score AS score,
        RESULT.star AS star,
        RANK ( ) OVER ( PARTITION BY area ORDER BY star DESC ) AS RANK,
        RESULT.lastScore AS lastScore,
        RESULT.lastColorCard AS lastColorCard,
        ( RESULT.score - RESULT.lastScore ) AS lastScoreUpOrDown,
        RESULT.lastScoreAfter AS lastScoreAfter,
        RESULT.lastColorCardAfter AS lastColorCardAfter,
        ( RESULT.lastScore - RESULT.lastScoreAfter ) AS lastScoreAfterUpOrDown,
        ${month} AS MONTH
        FROM
        RESULT
    </select>
    <select id="getAreaStarChart"
            resultType="com.wxwy.intelligentOptimization.moudle.vo.despoilStar.AreaStarChartVO">

        select SUBSTRING ( CAST (month AS TEXT ), 1, 4 ) || '-' || SUBSTRING ( CAST ( month AS TEXT ), 5, 2 ) as month,star from (
        select
        star,
        month
        from app_io_star_rank
        where area_name = #{areaName}
        <if test="month !=null">
            and month &lt;= #{month}
        </if>
        order by month desc limit 6
        ) a
        order by month
    </select>
    <select id="getAreaRankInfo"
            resultType="com.wxwy.intelligentOptimization.moudle.vo.despoilStar.AreaRankInfoVO">
        with tba as (SELECT area_name,
                            ARRAY_AGG(score ORDER BY MONTH)      as score,
                            ARRAY_AGG(star ORDER BY MONTH)       as star,
                            ARRAY_AGG(RANK ORDER BY MONTH)       as rank,
                            ARRAY_AGG(color_card ORDER BY MONTH) as color_card,
                            ARRAY_AGG(MONTH ORDER BY MONTH )     as monthArray
                     FROM (SELECT *
                           FROM "app_io_star_rank"
                           WHERE area_name = #{areaName} AND MONTH &lt;= #{month}
                           ORDER BY MONTH DESC LIMIT 2) A
                     GROUP BY area_name)

        select area_name,
               case when array_length(color_card, 1) = 1 then color_card[1] else color_card[2] end as colorCard,
               case when array_length(star, 1) = 1 then star[1] else star[2] end                   as currentStar,
               case when array_length(monthArray, 1) = 1 then monthArray[1] else monthArray[2] end as month,
	           case when array_length(rank, 1) = 1 then rank[1] else rank[2]
        end
        as currentRank,
	           case when array_length(rank, 1) = 1 then 0 else -(rank[2]-rank[1])
        end
        as  rankUpOrDown,
	           case when array_length(score, 1) = 1 then score[1] else score[2]
        end
        as  currentScore,
	           case when array_length(score, 1) = 1 then 0 else score[2]-score[1]
        end
        as  scoreUpOrDown
        from tba


    </select>
    <select id="getDeductionOfPoints"
            resultType="com.wxwy.intelligentOptimization.moudle.vo.despoilStar.AreaDeductionOfPointsVO">
        with tba as (
            select
                case
                    when appraisal_deduction_of_points != 0 then -appraisal_deduction_of_points
                    else 0 end as appraisalDeductionOfPoints,
                case
                    when out_serve_deduction_of_points != 0 then -out_serve_deduction_of_points
                    else 0 end as outServeDeductionOfPoints,
                case
                    when often_break_deduction_of_points != 0 then -often_break_deduction_of_points
                    else 0 end as oftenBreakDeductionOfPoints,
                case
                    when pressure_drop_deduction_of_points != 0 then -pressure_drop_deduction_of_points
                    else 0 end as pressureDropDeductionOfPoints,
                case
                    when repetition_order_deduction_of_points != 0 then -repetition_order_deduction_of_points
                    else 0 end as repetitionOrderDeductionOfPoints,
                case
                    when poor_benefit_deduction_of_points != 0 then -poor_benefit_deduction_of_points
                    else 0 end as poorBenefitDeductionOfPoints,
                case
                    when four_deduction_of_points != 0 then -four_deduction_of_points
                    else 0 end as fourDeductionOfPoints,
                case
                    when five_deduction_of_points != 0 then -five_deduction_of_points
                    else 0 end as fiveDeductionOfPoints
            from app_io_star_rank
            where month = #{month}
            and area_name = #{areaName}
        )
        <choose>
            <when test="month &lt; 202408">
                select
                '集团测评清单扣罚' as indicatorName,
                appraisalDeductionOfPoints as deductionOfPoints
                from tba
                union all
                select
                '批量退服次数' as indicatorName,
                outServeDeductionOfPoints as deductionOfPoints
                from tba
                union all
                select
                '频繁断站' as indicatorName,
                oftenBreakDeductionOfPoints as deductionOfPoints
                from tba
            </when>
            <when test="month &lt; 202501">
                select
                '批量退服次数' as indicatorName,
                outServeDeductionOfPoints as deductionOfPoints
                from tba
                union all
                select
                '"三超"压降' as indicatorName,
                pressureDropDeductionOfPoints as deductionOfPoints
                from tba
                union all
                select
                '重复工单压降' as indicatorName,
                repetitionOrderDeductionOfPoints as deductionOfPoints
                from tba
                union all
                select
                '低效益站址压降' as indicatorName,
                poorBenefitDeductionOfPoints as deductionOfPoints
                from tba
            </when>
            <otherwise>
                select
                '4G BBU GNSS天馈系统完整性' as indicatorName,
                fourDeductionOfPoints as deductionOfPoints
                from tba
                union all
                select
                '5G BBU GNSS天馈系统完整性' as indicatorName,
                fiveDeductionOfPoints as deductionOfPoints
                from tba
            </otherwise>
        </choose>


    </select>
    <select id="getAreaIndicatorDetailInfo"
            resultType="com.wxwy.intelligentOptimization.moudle.vo.despoilStar.AreaIndicatorDetailVO">
        with tba as (select area_name,
                            array_agg(month order by month )                                                        as "month",
                            array_agg(round(quarter_lead, 2) order by month)                                        as quarter_lead,
                            array_agg(satisfaction_score order by month)                                            as satisfaction_score,
                            array_agg(concat(round(in_deal_rate * 100, 2)::varchar, '%') order by month)            as in_deal_rate,
                            array_agg(concat(round(repetition_rate * 100, 2)::varchar, '%') order by month)         as repetition_rate,
                            array_agg(barrier_score order by month)                                                 as barrier_score,
                            array_agg(concat(round(deal_complaint_rate * 100, 2)::varchar, '%') order by month)     as deal_complaint_rate,
                            array_agg(complaint_score order by month)                                               as complaint_score,
                            array_agg(concat(round(friendly_cover_rate * 100, 2)::varchar, '%') order by month)     as friendly_cover_rate,
                            array_agg(friendly_cover_score order by month)                                          as friendly_cover_score,
                            array_agg(concat(round(bad_cover_rate * 100, 2)::varchar, '%') order by month)          as bad_cover_rate,
                            array_agg(bad_cover_score order by month)                                               as bad_cover_score,
                            array_agg(concat(round(four_high_load_rate * 100, 2)::varchar, '%') order by month)          as four_high_load_rate,
                            array_agg(concat(round(five_high_load_rate * 100, 2)::varchar, '%') order by month)         as five_high_load_rate,
                            array_agg(concat(round(high_load_rate * 100, 2)::varchar, '%') order by month)          as high_load_rate,
                            array_agg(concat(round(two_single_rate * 100, 2)::varchar, '%') order by month)         as two_single_rate,
                            array_agg(high_load_score order by month)                                               as high_load_score,
                            array_agg(concat(round(zero_flow_rate * 100, 2)::varchar, '%') order by month)          as zero_flow_rate,
                            array_agg(zero_score order by month)                                                    as zero_score,
                            array_agg(concat(round(quality_difference_rate * 100, 2)::varchar, '%') order by month) as quality_difference_rate,
                            array_agg(quality_score order by month)                                                    quality_score,
                            array_agg(round(cel_avg_duration, 2) order by month)                                    as cel_avg_duration,
                            array_agg(cel_avg_duration_score order by month)                                        as cel_avg_duration_score,
                            array_agg(concat(round(over_length_rate * 100, 2)::varchar, '%') order by month)        as over_length_rate,
                            array_agg(over_length_score order by month)                                             as over_length_score,
                            array_agg(concat(round(data_full_rate * 100, 2)::varchar, '%') order by month)          as data_full_rate,
                            array_agg(concat(round(data_exact_rate * 100, 2)::varchar, '%') order by month)         as data_exact_rate,
                            array_agg(data_govern_score order by month)                                             as data_govern_score,
                            array_agg(test_kilometre order by month)                                                as test_kilometre,
                            array_agg(base_optimize_num order by month)                                             as base_optimize_num,
                            array_agg(data_test_analyse_score order by month)                                       as data_test_analyse_score,
                            array_agg(concat(round(order_close_rate * 100, 2)::varchar, '%') order by month)        as order_close_rate,
                            array_agg(concat(round(strict_close_rate * 100, 2)::varchar, '%') order by month)       as strict_close_rate,
                            array_agg(close_score order by month)                                                   as close_score,
                            array_agg(concat(round(new_order_close_rate * 100, 2)::varchar, '%') order by month)            as new_order_close_rate,
                            array_agg(concat(round(new_strict_order_close_rate * 100, 2)::varchar, '%') order by month)     as new_strict_order_close_rate,
                            array_agg(concat(round(new_maintain_order_close_rate * 100, 2)::varchar, '%') order by month)   as new_maintain_order_close_rate,
                            array_agg(new_close_score order by month)                                                       as new_close_score,
                            array_agg(concat(round(new_long_break_rate * 100, 2)::varchar, '%') order by month)            as new_long_break_rate,
                            array_agg(concat(round(new_often_break_rate * 100, 2)::varchar, '%') order by month)           as new_often_break_rate,
                            array_agg(base_break_score order by month)                                                     as base_break_score
                     from app_io_star_rank
                     where month IN ( #{lastMonth}, #{currentMonth} )
            and area_name = #{areaName}
        group by area_name)
        select '满意度测评' as indicatorName,
            case when (array_length(quarter_lead, 1) = 1 and month[1] = ${currentMonth}) then quarter_lead[1]::varchar when (array_length(quarter_lead, 1) = 1 and month[1] = ${lastMonth}) then '' else quarter_lead[2]::varchar end currentIndicator,
	        case when (array_length(satisfaction_score,1) = 1 and month[1] = ${currentMonth}) then satisfaction_score[1]::varchar when (array_length(satisfaction_score, 1) = 1 and month[1] = ${lastMonth}) then '' else satisfaction_score[2]::varchar end currentScore,
	        case when (array_length(quarter_lead,1) = 1 and month[1] = ${currentMonth}) then '' else quarter_lead[1]::varchar end lastIndicator,
	        case when (array_length(satisfaction_score,1) = 1 and month[1] = ${currentMonth}) then '' else satisfaction_score[1]::varchar end lastScore,
            ${currentMonth} as currentMonth,
	        ${lastMonth} lastMonth
        from tba
        union all
        select '移动障碍工单处理质量' as indicatorName,
            case when (array_length(in_deal_rate, 1) = 1 and month[1] = ${currentMonth}) then concat(in_deal_rate[1]::varchar, ';', repetition_rate[1]::varchar) when (array_length(in_deal_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(in_deal_rate[2]::varchar, ';', repetition_rate[2]::varchar) end currentIndicator,
            case when (array_length(barrier_score, 1) = 1 and month[1] = ${currentMonth} ) then barrier_score[1]::varchar when (array_length(barrier_score, 1) = 1 and month[1] = ${lastMonth} ) then ''  else barrier_score[2]::varchar end currentScore,
            case when (array_length(in_deal_rate, 1) = 1 and month[1] = ${currentMonth}) then ''  else concat(in_deal_rate[1], ';', repetition_rate[1]) end  lastIndicator,
            case when (array_length(barrier_score, 1) = 1 and month[1] = ${currentMonth}) then '' else barrier_score[1]::varchar end lastScore,
            ${currentMonth} as currentMonth,
	        ${lastMonth} lastMonth
        from tba
	    union all
        select 'TOP栅格投诉处置宰' as indicatorName,
            case when (array_length(deal_complaint_rate, 1) = 1 and month[1] = ${currentMonth}) then deal_complaint_rate[1]::varchar when (array_length(deal_complaint_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else deal_complaint_rate[2]::varchar end currentIndicator,
	        case when (array_length(complaint_score,1) = 1 and month[1] = ${currentMonth}) then complaint_score[1]::varchar when (array_length(complaint_score,1) = 1 and month[1] = ${lastMonth}) then '' else complaint_score[2]::varchar end currentScore,
	        case when (array_length(deal_complaint_rate,1) = 1 and month[1] = ${currentMonth}) then '' else deal_complaint_rate[1]::varchar end lastIndicator,
	        case when (array_length(complaint_score,1) = 1 and month[1] = ${currentMonth}) then '' else complaint_score[1]::varchar end lastScore,
            ${currentMonth} as currentMonth,
	        ${lastMonth} as lastMonth
        from tba
        union all
        select '4/5G竞对友商覆盖率' as indicatorName,
            case when (array_length(friendly_cover_rate, 1) = 1 and month[1] = ${currentMonth}) then friendly_cover_rate[1]::varchar when (array_length(friendly_cover_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else friendly_cover_rate[2]::varchar end currentIndicator,
	        case when (array_length(friendly_cover_score,1) = 1 and month[1] = ${currentMonth}) then friendly_cover_score[1]::varchar when (array_length(friendly_cover_score,1) = 1 and month[1] = ${lastMonth}) then '' else friendly_cover_score[2]::varchar end currentScore,
	        case when (array_length(friendly_cover_rate,1) = 1  and month[1] = ${currentMonth}) then '' else friendly_cover_rate[1]::varchar end lastIndicator,
	        case when (array_length(friendly_cover_score,1) = 1 and month[1] = ${currentMonth}) then '' else friendly_cover_score[1]::varchar end lastScore,
	        ${currentMonth} as currentMonth,
	        ${lastMonth} as lastMonth
        from tba
        union all
        select '4/5G弱覆盖且劣于竞对物业点占比' as indicatorName,
            case when (array_length(high_load_rate, 1) = 1 and month[1] = ${currentMonth}) then bad_cover_rate[1]::varchar  when (array_length(high_load_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else bad_cover_rate[2]::varchar end currentIndicator,
	        case when (array_length(bad_cover_score,1) = 1 and month[1] = ${currentMonth}) then bad_cover_score[1]::varchar  when (array_length(bad_cover_score,1) = 1 and month[1] = ${lastMonth}) then '' else bad_cover_score[2]::varchar end currentScore,
	        case when (array_length(bad_cover_rate,1) = 1  and month[1] = ${currentMonth}) then '' else bad_cover_rate[1]::varchar end lastIndicator,
	        case when (array_length(bad_cover_score,1) = 1 and month[1] = ${currentMonth}) then '' else bad_cover_score[1]::varchar end lastScore,
            ${currentMonth} as currentMonth,
	        ${lastMonth} lastMonth
        from tba
        <choose>
            <when test="currentMonth &lt; 202408">
                union all
                select '4/5G高负荷小区比例' as indicatorName,
                    case when (array_length(high_load_rate, 1) = 1  and month[1] = ${currentMonth} ) then concat(high_load_rate[1]::varchar, ';', two_single_rate[1]::varchar) when (array_length(high_load_rate, 1) = 1  and month[1] = ${lastMonth} ) then '' else concat(high_load_rate[2]::varchar, ';', two_single_rate[2]::varchar) end currentIndicator,
                    case when (array_length(high_load_score, 1) = 1 and month[1] = ${currentMonth} ) then high_load_score[1]::varchar when (array_length(high_load_score, 1) = 1 and month[1] = ${lastMonth} ) then '' else high_load_score[2]::varchar end currentScore,
                    case when (array_length(high_load_rate, 1) = 1  and month[1] = ${currentMonth} ) then '' else concat(high_load_rate[1], ';', two_single_rate[1]) end lastIndicator,
                    case when (array_length(high_load_score, 1) = 1 and month[1] = ${currentMonth} ) then '' else high_load_score[1]::varchar end lastScore,
                    ${currentMonth} as currentMonth,
                    ${lastMonth} lastMonth
                from tba
            </when>
            <when test="currentMonth == 202408">
                union all
                select '4/5G高负荷小区比例' as indicatorName,
                    case when (array_length(four_high_load_rate, 1) = 1 and month[1] = ${currentMonth} ) then concat(four_high_load_rate[1]::varchar, ';', five_high_load_rate[1]::varchar) when (array_length(four_high_load_rate, 1) = 1 and month[1] = ${lastMonth} ) then '' else concat(four_high_load_rate[2]::varchar, ';', five_high_load_rate[2]::varchar) end currentIndicator,
                    case when (array_length(high_load_score, 1) = 1     and month[1] = ${currentMonth} ) then high_load_score[1]::varchar when (array_length(high_load_score, 1) = 1 and month[1] = ${lastMonth} ) then '' else high_load_score[2]::varchar end currentScore,
                    case when (array_length(high_load_rate, 1) = 1      and month[1] = ${currentMonth} ) then '' else concat(high_load_rate[1], ';', two_single_rate[1]) end lastIndicator,
                    case when (array_length(high_load_score, 1) = 1     and month[1] = ${currentMonth} ) then '' else high_load_score[1]::varchar end lastScore,
                    ${currentMonth} as currentMonth,
                    ${lastMonth} as lastMonth
                from tba
            </when>
            <otherwise>
                union all
                select '4/5G高负荷小区比例' as indicatorName,
                    case when (array_length(four_high_load_rate, 1) = 1 and month[1] = ${currentMonth} ) then concat(four_high_load_rate[1]::varchar, ';', five_high_load_rate[1]::varchar) when (array_length(four_high_load_rate, 1) = 1 and month[1] = ${lastMonth} ) then '' else concat(four_high_load_rate[2]::varchar, ';', five_high_load_rate[2]::varchar) end currentIndicator,
                    case when (array_length(high_load_score, 1) = 1     and month[1] = ${currentMonth} ) then high_load_score[1]::varchar when (array_length(high_load_score, 1) = 1     and month[1] = ${currentMonth} ) then '' else high_load_score[2]::varchar end currentScore,
                    case when (array_length(four_high_load_rate, 1) = 1 and month[1] = ${currentMonth} ) then '' else concat(four_high_load_rate[1], ';', five_high_load_rate[1]) end lastIndicator,
                    case when (array_length(high_load_score, 1) = 1     and month[1] = ${currentMonth} ) then '' else high_load_score[1]::varchar end lastScore,
                    ${currentMonth} as currentMonth,
                    ${lastMonth} as  lastMonth
                from tba
            </otherwise>
        </choose>
	    union all
        select '4/5G零流量小区比例' as indicatorName,
            case when (array_length(zero_flow_rate, 1) = 1 and month[1] = ${currentMonth} ) then zero_flow_rate[1]::varchar when (array_length(zero_flow_rate, 1) = 1 and month[1] = ${lastMonth} ) then '' else zero_flow_rate[2]::varchar end currentIndicator,
	        case when (array_length(zero_score,1) = 1      and month[1] = ${currentMonth} ) then zero_score[1]::varchar  when (array_length(zero_score,1) = 1 and month[1] = ${lastMonth} ) then '' else zero_score[2]::varchar end currentScore,
	        case when (array_length(zero_flow_rate,1) = 1  and month[1] = ${currentMonth} ) then '' else zero_flow_rate[1]::varchar end lastIndicator,
	        case when (array_length(zero_score,1) = 1      and month[1] = ${currentMonth} ) then '' else zero_score[1]::varchar end lastScore,
            ${currentMonth} as currentMonth,
	        ${lastMonth} as lastMonth
        from tba
	 	union all
        select '4/5G质差小区比例' as indicatorName,
            case when (array_length(quality_difference_rate, 1) = 1 and month[1] = ${currentMonth}) then quality_difference_rate[1]::varchar when (array_length(quality_difference_rate, 1) = 1 and month[1] = ${lastMonth}) then ''  else quality_difference_rate[2]::varchar end currentIndicator,
	        case when (array_length(quality_score,1) = 1            and month[1] = ${currentMonth}) then quality_score[1]::varchar when (array_length(quality_score,1) = 1  and month[1] = ${lastMonth}) then '' else quality_score[2]::varchar end currentScore,
	        case when (array_length(quality_difference_rate,1) = 1  and month[1] = ${currentMonth}) then '' else quality_difference_rate[1]::varchar end lastIndicator,
	        case when (array_length(quality_score,1) = 1            and month[1] = ${currentMonth}) then '' else quality_score[1]::varchar end lastIndicator,
            ${currentMonth} as currentMonth,
	        ${lastMonth} lastMonth
        from tba
	    union all
        select '4/5G基站AB类小区平均退服时长' as indicatorName,
            case when (array_length(cel_avg_duration, 1) = 1      and month[1] = ${currentMonth} ) then cel_avg_duration[1]::varchar when (array_length(cel_avg_duration, 1) = 1 and month[1] = ${lastMonth} ) then '' else cel_avg_duration[2]::varchar end currentIndicator,
            case when (array_length(cel_avg_duration_score,1) = 1 and month[1] = ${currentMonth} ) then cel_avg_duration_score[1]::varchar when (array_length(cel_avg_duration_score,1) = 1 and month[1] = ${lastMonth} ) then '' else cel_avg_duration_score[2]::varchar end currentScore,
	        case when (array_length(cel_avg_duration,1) = 1       and month[1] = ${currentMonth} ) then '' else cel_avg_duration[1]::varchar end lastIndicator,
	        case when (array_length(cel_avg_duration_score,1) = 1 and month[1] = ${currentMonth} ) then '' else cel_avg_duration_score[1]::varchar end lastScore,
            ${currentMonth} as currentMonth,
	        ${lastMonth} lastMonth
        from tba
        <choose>
            <when test="currentMonth &lt; 202408">
                union all
                select '超长断站率' as indicatorName,
                    case when (array_length(over_length_rate,1) = 1  and month[1] = ${currentMonth} ) then over_length_rate[1]::varchar when (array_length(over_length_rate, 1) = 1  and month[1] = ${lastMonth} ) then '' else over_length_rate[2]::varchar end currentIndicator,
                    case when (array_length(over_length_score,1) = 1 and month[1] = ${currentMonth} ) then over_length_score[1]::varchar when (array_length(over_length_score,1) = 1 and month[1] = ${lastMonth} ) then '' else over_length_score[2]::varchar end currentScore,
                    case when (array_length(over_length_rate,1) = 1  and month[1] = ${currentMonth} ) then '' else over_length_rate[1]::varchar end lastIndicator,
                    case when (array_length(over_length_score,1) = 1 and month[1] = ${currentMonth} ) then '' else over_length_score[1]::varchar end lastScore,
                    ${currentMonth} as currentMonth,
                    ${lastMonth} lastMonth
                from tba
            </when>
            <when test="currentMonth == 202408">
                union all
                select '超长断站率' as indicatorName,
                    '' as currentIndicator,
                    '' as currentScore,
                    case when (array_length(over_length_rate,1) = 1  and month[1] = ${currentMonth} ) then '' else over_length_rate[1]::varchar end lastIndicator,
                    case when (array_length(over_length_score,1) = 1 and month[1] = ${currentMonth} ) then '' else over_length_score[1]::varchar end lastScore,
                    ${currentMonth} as currentMonth,
                    ${lastMonth} lastMonth
                from tba
                union all
                select '基站断站率' as  indicatorName,
                    case when (array_length(new_long_break_rate, 1) = 1 and month[1] = ${currentMonth} ) then concat(new_long_break_rate[1]::varchar, ';', new_often_break_rate[1]::varchar) when (array_length(new_long_break_rate, 1) = 1 and month[1] = ${lastMonth} ) then '' else concat(new_long_break_rate[2]::varchar, ';', new_often_break_rate[2]::varchar) end currentIndicator,
                    case when (array_length(base_break_score, 1) = 1    and month[1] = ${currentMonth} ) then base_break_score[1]::varchar when (array_length(base_break_score, 1) = 1  and  month[1] = ${lastMonth} ) then '' else base_break_score[2]::varchar end currentScore,
                    '' as lastIndicator,
                    '' as lastScore,
                    ${currentMonth} as currentMonth,
                    ${lastMonth} lastMonth
                from tba
            </when>
            <otherwise>
                union all
                select '基站断站率' as  indicatorName,
                    case when (array_length(new_long_break_rate, 1) = 1 and month[1] = ${currentMonth} )  then concat(new_long_break_rate[1]::varchar, ';', new_often_break_rate[1]::varchar) when (array_length(new_long_break_rate, 1) = 1 and  month[1] = ${lastMonth} ) then '' else concat(new_long_break_rate[2]::varchar, ';', new_often_break_rate[2]::varchar) end currentIndicator,
                    case when (array_length(base_break_score, 1) = 1    and month[1] = ${currentMonth} )  then base_break_score[1]::varchar when (array_length(base_break_score, 1) = 1  and  month[1] = ${lastMonth} ) then '' else base_break_score[2]::varchar  end currentScore,
                    case when (array_length(new_long_break_rate, 1) = 1 and month[1] = ${currentMonth} )  then '' else concat(data_full_rate[1], ';', new_often_break_rate[1]) end lastIndicator,
                    case when (array_length(base_break_score, 1) = 1    and month[1] = ${currentMonth} )  then '' else base_break_score[1]::varchar end lastScore,
                    ${currentMonth} as currentMonth,
                    ${lastMonth} lastMonth
                from tba
            </otherwise>
        </choose>
	    union all
        select '基础数据治理' as  indicatorName,
            case when (array_length(data_full_rate, 1) = 1    and month[1] = ${currentMonth} ) then concat(data_full_rate[1]::varchar, ';', data_exact_rate[1]::varchar) when (array_length(data_full_rate, 1) = 1 and month[1] = ${lastMonth} ) then '' else concat(data_full_rate[2]::varchar, ';', data_exact_rate[2]::varchar) end currentIndicator,
            case when (array_length(data_govern_score, 1) = 1 and month[1] = ${currentMonth} ) then data_govern_score[1]::varchar when (array_length(data_govern_score, 1) = 1 and month[1] = ${lastMonth} ) then '' else data_govern_score[2]::varchar end  currentScore,
            case when (array_length(data_full_rate, 1) = 1    and month[1] = ${currentMonth} ) then '' else concat(data_full_rate[1], ';', data_exact_rate[1]) end lastIndicator,
            case when (array_length(data_govern_score, 1) = 1 and month[1] = ${currentMonth} ) then '' else data_govern_score[1]::varchar end lastIndicator,
            ${currentMonth} as currentMonth,
            ${lastMonth} lastMonth
        from tba
	    union all
        select '数据测试分析及基站优化' as    indicatorName,
            case when (array_length(test_kilometre, 1) = 1          and month[1] = ${currentMonth}) then concat(test_kilometre[1]::varchar, ';', base_optimize_num[1]::varchar) when (array_length(test_kilometre, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(test_kilometre[2]::varchar, ';', base_optimize_num[2]::varchar) end currentIndicator,
            case when (array_length(data_test_analyse_score, 1) = 1 and month[1] = ${currentMonth}) then data_test_analyse_score[1]::varchar when (array_length(data_test_analyse_score, 1) = 1 and month[1] = ${lastMonth}) then '' else data_test_analyse_score[2]::varchar end currentScore,
            case when (array_length(test_kilometre, 1) = 1          and month[1] = ${currentMonth}) then '' else concat(test_kilometre[1], ';', base_optimize_num[1]) end lastIndicator,
            case when (array_length(data_test_analyse_score, 1) = 1 and month[1] = ${currentMonth}) then '' else data_test_analyse_score[1]::varchar end lastScore,
            ${currentMonth} as currentMonth,
	        ${lastMonth} lastMonth
        from tba
        <choose>
            <when test="currentMonth &lt; 202408">
                union all
                select '工单闭环率' as indicatorName,
                    case when (array_length(order_close_rate, 1) = 1 and month[1] = ${currentMonth}) then concat(order_close_rate[1]::varchar, ';', strict_close_rate[1]::varchar) when (array_length(order_close_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(order_close_rate[2]::varchar, ';', strict_close_rate[2]::varchar) end  currentIndicator,
                    case when (array_length(close_score, 1) = 1      and month[1] = ${currentMonth}) then close_score[1]::varchar when (array_length(close_score, 1) = 1 and month[1] = ${lastMonth}) then '' else close_score[2]::varchar end currentScore,
                    case when (array_length(order_close_rate, 1) = 1 and month[1] = ${currentMonth}) then '' else concat(order_close_rate[1], ';', strict_close_rate[1]) end lastIndicator,
                    case when (array_length(close_score, 1) = 1      and month[1] = ${currentMonth}) then '' else close_score[1]::varchar end lastScore,
                    ${currentMonth} as currentMonth,
                    ${lastMonth} lastMonth
                from tba
            </when>
            <when test="currentMonth == 202408">
                union all
                select '工单闭环率' as indicatorName,
                    case when (array_length(new_order_close_rate, 1) = 1 and month[1] = ${currentMonth}) then concat(new_order_close_rate[1]::varchar, ';', new_strict_order_close_rate[1]::varchar,';', new_maintain_order_close_rate[1]::varchar) when (array_length(new_order_close_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(new_order_close_rate[2]::varchar, ';', new_strict_order_close_rate[2]::varchar,';', new_maintain_order_close_rate[2]::varchar) end  currentIndicator,
                    case when (array_length(new_close_score, 1) = 1      and month[1] = ${currentMonth}) then new_close_score[1]::varchar when (array_length(new_close_score, 1) = 1 and month[1] = ${lastMonth}) then '' else new_close_score[2]::varchar end currentScore,
                    case when (array_length(order_close_rate, 1) = 1 and month[1] = ${currentMonth}) then '' else concat(order_close_rate[1]::varchar, ';', strict_close_rate[1]::varchar) end   lastIndicator,
                    case when (array_length(close_score, 1) = 1      and month[1] = ${currentMonth}) then '' else close_score[1]::varchar end   lastScore,
                    ${currentMonth} as currentMonth,
                    ${lastMonth} as lastMonth
                from tba
            </when>
            <otherwise>
                union all
                select '工单闭环率' as indicatorName,
                    case when (array_length(new_order_close_rate, 1) = 1 and month[1] = ${currentMonth} ) then concat(new_order_close_rate[1]::varchar, ';', new_strict_order_close_rate[1]::varchar,';', new_maintain_order_close_rate[1]::varchar) when (array_length(new_order_close_rate, 1) = 1 and month[1] = ${lastMonth} ) then '' else concat(new_order_close_rate[2]::varchar, ';', new_strict_order_close_rate[2]::varchar,';', new_maintain_order_close_rate[2]::varchar) end  currentIndicator,
                    case when (array_length(new_close_score, 1) = 1      and month[1] = ${currentMonth} ) then new_close_score[1]::varchar when (array_length(new_close_score, 1) = 1      and month[1] = ${lastMonth} ) then '' else new_close_score[2]::varchar end currentScore,
                    case when (array_length(new_order_close_rate, 1) = 1 and month[1] = ${currentMonth} ) then '' else concat(new_order_close_rate[1], ';', new_strict_order_close_rate[1],';', new_maintain_order_close_rate[1]::varchar) end lastIndicator,
                    case when (array_length(new_close_score, 1) = 1      and month[1] = ${currentMonth} ) then '' else new_close_score[1]::varchar end lastScore,
                    ${currentMonth} as currentMonth,
                    ${lastMonth} as  lastMonth
                from tba
            </otherwise>
        </choose>

    </select>
    <select id="getProblemIndicatorWords" resultType="java.lang.String">
        with tba as (
            SELECT *
            FROM "app_io_star_rank"
            where
            month = #{month} and area_name = #{areaName}
            )
           , tbb as (
        SELECT
            case when satisfaction_score &lt; 20 then '满意度测评' else '' end indicatorName,
            satisfaction_score/20 as rate
        FROM tba
        union all
        SELECT
            case when barrier_score &lt; 10 then '移动障碍工单处理质量' else '' end indicatorName,
            barrier_score/10 as rate
        FROM tba
        union all
        SELECT
            case when complaint_score &lt;5 then 'TOP栅格投诉处置率' else '' end indicatorName,
            complaint_score/5 as rate
        FROM tba
        union all
        SELECT
            case when friendly_cover_score &lt;5 then '4/5G竞对友商覆盖率' else '' end indicatorName,
            friendly_cover_score/5 as rate
        FROM tba
        union all
        SELECT
            case when bad_cover_score &lt;15 then '4/5G弱覆盖且劣于竞对物业点占比' else '' end indicatorName,
            bad_cover_score/15 as rate
        FROM tba
        union all
        SELECT
            case when high_load_score &lt;8 then '4/5G高负荷小区比例' else '' end indicatorName,
            high_load_score/8 as rate
        FROM tba
        union all
        SELECT
            case when zero_score &lt;5 then '4/5G零流量小区比例' else '' end indicatorName,
            zero_score/5 as rate
        FROM tba
        union all
        SELECT
            case when quality_score &lt;7 then '4/5G质差小区比例' else '' end indicatorName,
            quality_score/7 as rate
        FROM tba
        union all
        SELECT
            case when cel_avg_duration_score &lt;10 then '4/5G基站AB类小区平均退服时长' else '' end indicatorName,
            cel_avg_duration_score/10 as rate
        FROM tba
        <choose>
            <when test="month &lt; 202408">
                union all
                SELECT
                case when over_length_score &lt;5 then '超长断站率' else '' end indicatorName,
                over_length_score/5 as rate
                FROM tba
            </when>
            <otherwise>
                union all
                SELECT
                case when base_break_score &lt;5 then '基站断站率' else '' end indicatorName,
                base_break_score/5 as rate
                FROM tba
            </otherwise>
        </choose>

        union all
        SELECT
            case when data_govern_score &lt;5 then '基础数据治理' else '' end indicatorName,
            data_govern_score/5 as rate
        FROM tba
        union all
        SELECT
            case when data_test_analyse_score &lt;10 then '数据测试分析及基站优化' else '' end indicatorName,
            data_test_analyse_score/10 as rate
        FROM tba
        <choose>
            <when test="month &lt; 202408">
                union all
                SELECT
                case when close_score &lt;5 then '工单闭环率' else '' end indicatorName,
                close_score/5 as rate
                FROM tba
            </when>
            <otherwise>
                union all
                SELECT
                case when new_close_score &lt;8 then '工单闭环率' else '' end indicatorName,
                new_close_score/8 as rate
                FROM tba
            </otherwise>
        </choose>
            )
        select indicatorName
        from tbb
        where indicatorName !=''
        order by rate
    </select>
    <select id="getAreaTendencyChart"
            resultType="com.wxwy.intelligentOptimization.moudle.vo.despoilStar.AreaIndicatorTendencyTempVO">
        with tba as (
            select
                area,
                area_name,
                voice_quality,
                internet_quality,
                network_quality_dx,
                network_quality_yd,
                network_quality_lt,
                quarter_lead,
                local_rank,
                satisfaction_score,
                satisfaction_quarter,
                satisfaction_month,
                in_deal_rate,
                repetition_rate,
                in_deal_score,
                repetition_score,
                barrier_score,
                barrier_month,
                deal_complaint_rate,
                complaint_score,
                complaint_month,
                friendly_cover_rate,
                friendly_cover_score,
                bad_cover_rate,
                bad_cover_score,
                cover_month,
                four_high_load_rate,
                five_high_load_rate,
                high_load_rate,
                two_single_rate,
                high_load_rate_score,
                two_single_score,
                high_load_score,
                high_load_month,
                four_zero_flow_rate,
                five_zero_flow_rate,
                zero_flow_rate,
                four_zero_flow_score,
                five_zero_flow_score,
                zero_flow_score,
                zero_score,
                zero_flow_month,
                four_quality_difference_rate,
                five_quality_difference_rate,
                quality_difference_rate,
                four_quality_difference_score,
                five_quality_difference_score,
                quality_difference_score,
                quality_score,
                quality_month,
                cel_avg_duration,
                cel_avg_duration_score,
                maintain_month,
                over_length_rate,
                case when month &lt; 202408 then over_length_score else new_long_break_score end over_length_score,
                over_length_month,
                data_full_rate,
                data_exact_rate,
                data_full_score,
                data_exact_score,
                data_govern_score,
                data_govern_month,
                test_kilometre,
                test_analyse_score,
                base_optimize_num,
                base_optimize_score,
                data_test_analyse_score,
                data_test_analyse_month,
                order_close_rate,
                strict_close_rate,
                order_close_score,
                strict_close_score,
                case when month &lt; 202408 then close_score else new_close_score end close_score,
                order_close_month,
                appraisal_list_deduction,
                appraisal_deduction_of_points,
                appraisal_month,
                out_serve_times_month,
                out_serve_month,
                out_serve_times_quarter,
                out_serve_quarter,
                out_serve_deduction_of_points,
                often_break_rate,
                case when month &lt; 202408 then -often_break_deduction_of_points else new_often_break_score end often_break_score,
                often_break_month,
                score,
                star,
                rank,
                color_card,
                month,
                gmt_create,
                new_long_break_rate,
                new_long_break_score,
                new_often_break_rate,
                new_often_break_score,
                base_break_score,
                base_break_month,
                new_order_close_rate,
                new_strict_order_close_rate,
                new_maintain_order_close_rate,
                new_order_close_score,
                new_strict_order_close_score,
                new_maintain_order_close_score,
                new_close_score,
                new_order_close_month,
                pressure_drop_rate,
                pressure_drop_deduction_of_points,
                pressure_drop_month,
                repetition_order_rate,
                repetition_order_deduction_of_points,
                repetition_order_month,
                poor_benefit_rate,
                poor_benefit_deduction_of_points,
                poor_benefit_month
            from app_io_star_rank
            where month &lt;= #{month} and area_name = #{areaName}
        order by month limit 12
            )
                ,
            tbb as (
        SELECT
            '满意度测评' as indicatorName,
            json_agg(
            json_build_object(
            'score', satisfaction_score,
            'month', month
            ))
            as tendency
        from tba
        union all
        SELECT
            '移动障碍工单处理质量' as indicatorName
                , json_agg(
            json_build_object(
            'score', barrier_score,
            'month', month
            )
            ) as tendency
        from tba
        union all
        SELECT
            'TOP栅格投诉处置率' as indicatorName
                , json_agg(
            json_build_object(
            'score', complaint_score,
            'month', month
            )
            ) as tendency
        from tba
        union all
        SELECT
            '4/5G竞对友商覆盖率' as indicatorName
                , json_agg(
            json_build_object(
            'score', friendly_cover_score,
            'month', month
            )
            ) as tendency
        from tba
        union all
        SELECT
            '4/5G弱覆盖且劣于竞对物业点占比' as indicatorName
                , json_agg(
            json_build_object(
            'score', bad_cover_score,
            'month', month
            )
            ) as tendency
        from tba
        union all
        SELECT
            '4/5G高负荷小区比例' as indicatorName
                , json_agg(
            json_build_object(
            'score', high_load_score,
            'month', month
            )
            ) as tendency
        from tba
        union all
        SELECT
            '4/5G零流量小区比例' as indicatorName
                , json_agg(
            json_build_object(
            'score', zero_score,
            'month', month
            )
            ) as tendency
        from tba
        union all
        SELECT
            '4/5G质差小区比例' as indicatorName
                , json_agg(
            json_build_object(
            'score', quality_score,
            'month', month
            )
            ) as tendency
        from tba
        union all
        SELECT
            '4/5G基站AB类小区平均退服时长' as indicatorName
                , json_agg(
            json_build_object(
            'score', cel_avg_duration_score,
            'month', month
            )
            ) as tendency
        from tba
        union all
        SELECT
            '超长断站率' as indicatorName
                , json_agg(
            json_build_object(
            'score', over_length_score,
            'month', month
            )
            ) as tendency
        from tba
        union all
        SELECT
            '频繁断站率' as indicatorName
                , json_agg(
            json_build_object(
            'score', often_break_score,
            'month', month
            )
            ) as tendency
        from tba
        union all
        SELECT
            '基础数据治理' as indicatorName
                , json_agg(
            json_build_object(
            'score', data_govern_score,
            'month', month
            )
            ) as tendency
        from tba
        union all
        SELECT
            '数据测试分析及基站优化' as indicatorName
                , json_agg(
            json_build_object(
            'score', data_test_analyse_score,
            'month', month
            )
            ) as tendency
        from tba
        union all
        SELECT
            '工单闭环率' as indicatorName
                , json_agg(
            json_build_object(
            'score', close_score,
            'month', month
            )
            ) as tendency
        from tba
            )
                ,
            tbc as (
        SELECT
            area,
            area_name,
            satisfaction_score,
            RANK() OVER (partition by area, month ORDER BY satisfaction_score DESC) AS satisfaction_rank,
            barrier_score,
            RANK() OVER (partition by area, month ORDER BY barrier_score DESC) AS barrier_rank,
            complaint_score,
            RANK() OVER (partition by area, month ORDER BY complaint_score DESC) AS complaint_rank,
            friendly_cover_score,
            RANK() OVER (partition by area, month ORDER BY friendly_cover_score DESC) AS friendly_cover_rank,
            bad_cover_score,
            RANK() OVER (partition by area, month ORDER BY bad_cover_score DESC) AS bad_cover_rank,
            high_load_score,
            RANK() OVER (partition by area, month ORDER BY high_load_score DESC) AS high_load_rank,
            zero_score,
            RANK() OVER (partition by area, month ORDER BY zero_score DESC) AS zero_rank,
            quality_score,
            RANK() OVER (partition by area, month ORDER BY quality_score DESC) AS quality_rank,
            cel_avg_duration_score,
            RANK() OVER (partition by area, month ORDER BY cel_avg_duration_score DESC) AS cel_avg_duration_rank,
            over_length_score,
            RANK() OVER (partition by area, month ORDER BY over_length_score DESC) AS over_length_rank,
            often_break_score,
            RANK() OVER (partition by area, month ORDER BY often_break_score DESC) AS often_break_rank,
            data_govern_score,
            RANK() OVER (partition by area, month ORDER BY data_govern_score DESC) AS data_govern_rank,
            data_test_analyse_score,
            RANK() OVER (partition by area, month ORDER BY data_test_analyse_score DESC) AS data_test_analyse_rank,
            close_score,
            RANK() OVER (partition by area, month ORDER BY close_score DESC) AS close_rank,
            month
        FROM
            (select
            area,
            area_name,
            voice_quality,
            internet_quality,
            network_quality_dx,
            network_quality_yd,
            network_quality_lt,
            quarter_lead,
            local_rank,
            satisfaction_score,
            satisfaction_quarter,
            satisfaction_month,
            in_deal_rate,
            repetition_rate,
            in_deal_score,
            repetition_score,
            barrier_score,
            barrier_month,
            deal_complaint_rate,
            complaint_score,
            complaint_month,
            friendly_cover_rate,
            friendly_cover_score,
            bad_cover_rate,
            bad_cover_score,
            cover_month,
            four_high_load_rate,
            five_high_load_rate,
            high_load_rate,
            two_single_rate,
            high_load_rate_score,
            two_single_score,
            high_load_score,
            high_load_month,
            four_zero_flow_rate,
            five_zero_flow_rate,
            zero_flow_rate,
            four_zero_flow_score,
            five_zero_flow_score,
            zero_flow_score,
            zero_score,
            zero_flow_month,
            four_quality_difference_rate,
            five_quality_difference_rate,
            quality_difference_rate,
            four_quality_difference_score,
            five_quality_difference_score,
            quality_difference_score,
            quality_score,
            quality_month,
            cel_avg_duration,
            cel_avg_duration_score,
            maintain_month,
            over_length_rate,
            case when month &lt; 202408 then over_length_score else new_long_break_score end over_length_score,
            over_length_month,
            data_full_rate,
            data_exact_rate,
            data_full_score,
            data_exact_score,
            data_govern_score,
            data_govern_month,
            test_kilometre,
            test_analyse_score,
            base_optimize_num,
            base_optimize_score,
            data_test_analyse_score,
            data_test_analyse_month,
            order_close_rate,
            strict_close_rate,
            order_close_score,
            strict_close_score,
            case when month &lt; 202408 then close_score else new_close_score end close_score,
            order_close_month,
            appraisal_list_deduction,
            appraisal_deduction_of_points,
            appraisal_month,
            out_serve_times_month,
            out_serve_month,
            out_serve_times_quarter,
            out_serve_quarter,
            out_serve_deduction_of_points,
            often_break_rate,
            case when month &lt; 202408 then -often_break_deduction_of_points else new_often_break_score end often_break_score,
            often_break_month,
            score,
            star,
            rank,
            color_card,
            month,
            gmt_create,
            new_long_break_rate,
            new_long_break_score,
            new_often_break_rate,
            new_often_break_score,
            base_break_score,
            base_break_month,
            new_order_close_rate,
            new_strict_order_close_rate,
            new_maintain_order_close_rate,
            new_order_close_score,
            new_strict_order_close_score,
            new_maintain_order_close_score,
            new_close_score,
            new_order_close_month,
            pressure_drop_rate,
            pressure_drop_deduction_of_points,
            pressure_drop_month,
            repetition_order_rate,
            repetition_order_deduction_of_points,
            repetition_order_month,
            poor_benefit_rate,
            poor_benefit_deduction_of_points,
            poor_benefit_month
            from app_io_star_rank) tb
        WHERE
            MONTH in ( #{lastMonth}
            , #{month})
            )
            , tbd as (
        select
            area_name,
            array_agg(satisfaction_score order by month ) as satisfaction_score,
            array_agg(satisfaction_rank order by month ) as satisfaction_rank,
            array_agg(barrier_score order by month ) as barrier_score,
            array_agg(barrier_rank order by month ) as barrier_rank,
            array_agg(complaint_score order by month ) as complaint_score,
            array_agg(complaint_rank order by month ) as complaint_rank,
            array_agg(friendly_cover_score order by month ) as friendly_cover_score,
            array_agg(friendly_cover_rank order by month ) as friendly_cover_rank,
            array_agg(bad_cover_score order by month ) as bad_cover_score,
            array_agg(bad_cover_rank order by month ) as bad_cover_rank,
            array_agg(high_load_score order by month ) as high_load_score,
            array_agg(high_load_rank order by month ) as high_load_rank,
            array_agg(zero_score order by month ) as zero_score,
            array_agg(zero_rank order by month ) as zero_rank,
            array_agg(quality_score order by month ) as quality_score,
            array_agg(quality_rank order by month ) as quality_rank,
            array_agg(cel_avg_duration_score order by month ) as cel_avg_duration_score,
            array_agg(cel_avg_duration_rank order by month ) as cel_avg_duration_rank,
            array_agg(over_length_score order by month ) as over_length_score,
            array_agg(over_length_rank order by month ) as over_length_rank,
            array_agg(often_break_score order by month ) as often_break_score,
            array_agg(often_break_rank order by month ) as often_break_rank,
            array_agg(data_govern_score order by month ) as data_govern_score,
            array_agg(data_govern_rank order by month ) as data_govern_rank,
            array_agg(data_test_analyse_score order by month ) as data_test_analyse_score,
            array_agg(data_test_analyse_rank order by month ) as data_test_analyse_rank,
            array_agg(close_score order by month ) as close_score,
            array_agg(close_rank order by month ) as close_rank,
            array_agg(month order by month ) as month
        from tbc
        where area_name = #{areaName}
        group by area_name
            )
                ,
            tbe as (
        select
            '满意度测评' as indicatorName,
            case when array_length(satisfaction_score, 1) = 1 then 0 else satisfaction_score[1] end lastMonthScore,
            case when array_length(satisfaction_rank, 1) = 1 then satisfaction_rank[1] else satisfaction_rank[2] end currentMonthRank,
            case when array_length(satisfaction_rank, 1) = 1 then null when (satisfaction_rank[2]-satisfaction_rank[1]) &gt;0 then false when (satisfaction_rank[2]-satisfaction_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
            '移动障碍工单处理质量' as indicatorName,
            case when array_length(barrier_score, 1) = 1 then 0 else barrier_score[1] end lastMonthScore,
            case when array_length(barrier_rank, 1) = 1 then barrier_rank[1] else barrier_rank[2] end currentMonthRank,
            case when array_length(barrier_rank, 1) = 1 then null when (barrier_rank[2]-barrier_rank[1]) &gt;0 then false when (barrier_rank[2]-barrier_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
            'TOP栅格投诉处置率' as indicatorName,
            case when array_length(complaint_score, 1) = 1 then 0 else complaint_score[1] end lastMonthScore,
            case when array_length(complaint_rank, 1) = 1 then complaint_rank[1] else complaint_rank[2] end currentMonthRank,
            case when array_length(complaint_rank, 1) = 1 then null when (complaint_rank[2]-complaint_rank[1]) &gt;0 then false when (complaint_rank[2]-complaint_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
            '4/5G竞对友商覆盖率' as indicatorName,
            case when array_length(friendly_cover_score, 1) = 1 then 0 else friendly_cover_score[1] end lastMonthScore,
            case when array_length(friendly_cover_rank, 1) = 1 then friendly_cover_rank[1] else friendly_cover_rank[2] end currentMonthRank,
            case when array_length(friendly_cover_rank, 1) = 1 then null when (friendly_cover_rank[2]-friendly_cover_rank[1]) &gt;0 then false when (friendly_cover_rank[2]-friendly_cover_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
            '4/5G弱覆盖且劣于竞对物业点占比' as indicatorName,
            case when array_length(bad_cover_score, 1) = 1 then 0 else bad_cover_score[1] end lastMonthScore,
            case when array_length(bad_cover_rank, 1) = 1 then bad_cover_rank[1] else bad_cover_rank[2] end currentMonthRank,
            case when array_length(bad_cover_rank, 1) = 1 then null when (bad_cover_rank[2]-bad_cover_rank[1]) &gt;0 then false when (bad_cover_rank[2]-bad_cover_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
            '4/5G高负荷小区比例' as indicatorName,
            case when array_length(high_load_score, 1) = 1 then 0 else high_load_score[1] end lastMonthScore,
            case when array_length(high_load_rank, 1) = 1 then high_load_rank[1] else high_load_rank[2] end currentMonthRank,
            case when array_length(high_load_rank, 1) = 1 then null when (high_load_rank[2]-high_load_rank[1]) &gt;0 then false when (high_load_rank[2]-high_load_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
            '4/5G零流量小区比例' as indicatorName,
            case when array_length(zero_score, 1) = 1 then 0 else zero_score[1] end lastMonthScore,
            case when array_length(zero_rank, 1) = 1 then zero_rank[1] else zero_rank[2] end currentMonthRank,
            case when array_length(zero_rank, 1) = 1 then null when (zero_rank[2]-zero_rank[1]) &gt;0 then false when (zero_rank[2]-zero_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
            '4/5G质差小区比例' as indicatorName,
            case when array_length(quality_score, 1) = 1 then 0 else quality_score[1] end lastMonthScore,
            case when array_length(quality_rank, 1) = 1 then quality_rank[1] else quality_rank[2] end currentMonthRank,
            case when array_length(quality_rank, 1) = 1 then null when (quality_rank[2]-quality_rank[1]) &gt;0 then false when (quality_rank[2]-quality_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
            '4/5G基站AB类小区平均退服时长' as indicatorName,
            case when array_length(cel_avg_duration_score, 1) = 1 then 0 else cel_avg_duration_score[1] end lastMonthScore,
            case when array_length(cel_avg_duration_rank, 1) = 1 then cel_avg_duration_rank[1] else cel_avg_duration_rank[2] end currentMonthRank,
            case when array_length(cel_avg_duration_rank, 1) = 1 then null when (cel_avg_duration_rank[2]-cel_avg_duration_rank[1]) &gt;0 then false when (cel_avg_duration_rank[2]-cel_avg_duration_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
            '超长断站率' as indicatorName,
            case when array_length(over_length_score, 1) = 1 then 0 else over_length_score[1] end lastMonthScore,
            case when array_length(over_length_rank, 1) = 1 then over_length_rank[1] else over_length_rank[2] end currentMonthRank,
            case when array_length(over_length_rank, 1) = 1 then null when (over_length_rank[2]-over_length_rank[1]) &gt;0 then false when (over_length_rank[2]-over_length_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
            '频繁断站率' as indicatorName,
            case when array_length(often_break_score, 1) = 1 then 0 else often_break_score[1] end lastMonthScore,
            case when array_length(often_break_rank, 1) = 1 then often_break_rank[1] else often_break_rank[2] end currentMonthRank,
            case when array_length(often_break_rank, 1) = 1 then null when (often_break_rank[2]-often_break_rank[1]) &gt;0 then false when (often_break_rank[2]-often_break_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
            '基础数据治理' as indicatorName,
            case when array_length(data_govern_score, 1) = 1 then 0 else data_govern_score[1] end lastMonthScore,
            case when array_length(data_govern_rank, 1) = 1 then data_govern_rank[1] else data_govern_rank[2] end currentMonthRank,
            case when array_length(data_govern_rank, 1) = 1 then null when (data_govern_rank[2]-data_govern_rank[1]) &gt;0 then false when (data_govern_rank[2]-data_govern_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
            '数据测试分析及基站优化' as indicatorName,
            case when array_length(data_test_analyse_score, 1) = 1 then 0 else data_test_analyse_score[1] end lastMonthScore,
            case when array_length(data_test_analyse_rank, 1) = 1 then data_test_analyse_rank[1] else data_test_analyse_rank[2] end currentMonthRank,
            case when array_length(data_test_analyse_rank, 1) = 1 then null when (data_test_analyse_rank[2]-data_test_analyse_rank[1]) &gt;0 then false when (data_test_analyse_rank[2]-data_test_analyse_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
            '工单闭环率' as indicatorName,
            case when array_length(close_score, 1) = 1 then 0 else close_score[1] end lastMonthScore,
            case when array_length(close_rank, 1) = 1 then satisfaction_rank[1] else close_rank[2] end currentMonthRank,
            case when array_length(close_rank, 1) = 1 then null when (close_rank[2]-close_rank[1])>0 then false when (close_rank[2]-close_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
            )
        select e.indicatorName    as indicatorName,
               e.lastMonthScore   as lastMonthScore,
               e.currentMonthRank as currentMonthRank,
               e.lastUpOrDown     as lastUpOrDown,
               b.tendency         as tendency
        from tbe e
                 left join tbb b on e.indicatorName = b.indicatorName
    </select>
    <select id="generateNewRankTable" resultType="com.wxwy.intelligentOptimization.moudle.vo.despoilStar.GenerateStarRankCardVO">
        WITH area as(
        select area,area_name from dim_io_star_area_conf
        ),
        <!-- 满意度测评 -->
        satisfaction AS (
        SELECT
        area,
        area_name,
        voice_quality,
        internet_quality,
        network_quality_dx,
        network_quality_yd,
        network_quality_lt,
        quarter_lead,
        local_rank,
        score,
        quarter,
        MONTH,
        gmt_create
        FROM
        app_io_star_satisfaction
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_satisfaction)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 移动用户故障处理 -->
        move_barrier AS ( SELECT area, area_name, in_deal_rate, repetition_rate, in_deal_score, repetition_score, score,
        MONTH, gmt_create FROM app_io_star_move_barrier WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_move_barrier)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!--TOP栅格投诉处理-->
        deal_complaint AS ( SELECT area, area_name, deal_complaint_rate, score, MONTH, gmt_create FROM
        app_io_star_deal_complaint WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_deal_complaint)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 覆盖 -->
        cover AS (
        SELECT
        area,
        area_name,
        friendly_cover_rate,
        friendly_cover_score,
        bad_cover_rate,
        bad_cover_score,
        ( friendly_cover_score + bad_cover_score ) AS score,
        MONTH,
        gmt_create
        FROM
        app_io_star_cover
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_cover)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>

        ),
        <!-- 高负荷小区比例 -->
        high_load AS (
        SELECT
        area,
        area_name,
        four_high_load_rate,
        five_high_load_rate,
        high_load_rate,
        rate,
        MONTH,
        high_load_score,
        rate_score,
        score,
        gmt_create
        FROM
        app_io_star_high_load
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_high_load)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 零流量小区比例 -->
        zero_flow AS (
        SELECT
        area,
        area_name,
        four_zero_flow_rate,
        five_zero_flow_rate,
        zero_flow_rate,
        four_zero_flow_score,
        five_zero_flow_score,
        zero_flow_score,
        score,
        MONTH,
        gmt_create
        FROM
        app_io_star_zero_flow
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_zero_flow)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 质差小区比例 -->
        quality_difference AS (
        SELECT
        area,
        area_name,
        four_quality_difference_rate,
        five_quality_difference_rate,
        quality_difference_rate,
        four_quality_difference_score,
        five_quality_difference_score,
        quality_difference_score,
        score,
        MONTH,
        gmt_create
        FROM
        app_io_star_quality_difference
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_quality_difference)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 4/5G基站AB类小区平均退服时长 -->
        maintain AS ( SELECT area, area_name, cel_avg_duration, cel_avg_duration_score, MONTH, gmt_create FROM
        app_io_star_maintain WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_maintain)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 基站断站率 -->
        base_break as (
        select
            area,
            area_name,
            long_break_rate,
            often_break_rate,
            long_break_score,
            often_break_score,
            score,
            month,
            gmt_create
        from app_io_star_base_break
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_base_break)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 数据治理 -->
        data_govern AS ( SELECT area, area_name, data_full_rate, data_exact_rate, data_full_score, data_exact_score,
        score, MONTH, gmt_create FROM app_io_star_data_govern WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_data_govern)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 数据测试分析 -->
        data_test AS ( SELECT area, area_name, test_kilometre, test_analyse_score, base_optimize_num,
        base_optimize_score, score, MONTH, gmt_create FROM app_io_star_data_test_analyse WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_data_test_analyse)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 工单闭环率 -->
        new_order_close as (
        select
            area,
            area_name,
            order_close_rate,
            strict_close_rate,
            maintain_close_rate,
            order_close_score,
            strict_close_score,
            maintain_close_score,
            score,
            month,
            gmt_create
        from app_io_star_new_order_close
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_new_order_close)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 批量退服 -->
        out_serve AS ( SELECT area, area_name, out_serve_times_month, MONTH, out_serve_times_quarter,
        deduction_of_points, quarter, gmt_create FROM app_io_star_out_serve WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_out_serve)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 三超压降 -->
        pressure_drop as (
            select
                area,
                area_name,
                pressure_drop_rate,
                deduction_of_points,
                month,
                gmt_create
            from app_io_star_pressure_drop
            WHERE
            <choose>
                <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                    month = (select max(month) from app_io_star_pressure_drop)
                </when>
                <otherwise>
                    MONTH = #{month}
                </otherwise>
            </choose>
        ),
        <!-- 重复工单压降 -->
        repetition_order as (
            select
                area,
                area_name,
                repetition_rate,
                deduction_of_points,
                month,
                gmt_create
            from app_io_star_repetition_order
            WHERE
            <choose>
                <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                    month = (select max(month) from app_io_star_repetition_order)
                </when>
                <otherwise>
                    MONTH = #{month}
                </otherwise>
            </choose>
        ),
        <!-- 低效益站址压降 -->
        poor_benefit as (
            select
                area,
                area_name,
                poor_benefit_rate,
                deduction_of_points,
                month,
                gmt_create
            from app_io_star_poor_benefit
            WHERE
            <choose>
                <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                    month = (select max(month) from app_io_star_repetition_order)
                </when>
                <otherwise>
                    MONTH = #{month}
                </otherwise>
            </choose>
        ),
        lastScore AS ( SELECT area, area_name, score, color_card FROM app_io_star_rank WHERE MONTH = #{lastMonth} ),
        lastScoreAfter AS ( SELECT area, area_name, score, color_card FROM app_io_star_rank WHERE MONTH = #{lastMonthAfter} ),
        RESULT AS (
        SELECT
        area.area AS area,
        area.area_name AS area_name,
        satisfaction.voice_quality AS voice_quality,
        satisfaction.internet_quality AS internet_quality,
        satisfaction.network_quality_dx AS network_quality_dx,
        satisfaction.network_quality_yd AS network_quality_yd,
        satisfaction.network_quality_lt AS network_quality_lt,
        satisfaction.quarter_lead AS quarter_lead,
        satisfaction.local_rank AS local_rank,
        satisfaction.score AS satisfaction_score,
        satisfaction.quarter AS satisfaction_quarter,
        satisfaction.MONTH AS satisfaction_month,
        move_barrier.in_deal_rate AS in_deal_rate,
        move_barrier.repetition_rate AS repetition_rate,
        move_barrier.in_deal_score AS in_deal_score,
        move_barrier.repetition_score AS repetition_score,
        move_barrier.score AS barrier_score,
        move_barrier.MONTH AS barrier_month,
        deal_complaint.deal_complaint_rate AS deal_complaint_rate,
        deal_complaint.score AS complaint_score,
        deal_complaint.MONTH AS complaint_month,
        cover.friendly_cover_rate AS friendly_cover_rate,
        cover.friendly_cover_score AS friendly_cover_score,
        cover.bad_cover_rate AS bad_cover_rate,
        cover.bad_cover_score AS bad_cover_score,
        cover.MONTH AS cover_month,
        high_load.four_high_load_rate AS four_high_load_rate,
        high_load.five_high_load_rate AS five_high_load_rate,
        high_load.high_load_rate AS high_load_rate,
        high_load.rate AS two_single_rate,
        high_load.high_load_score AS high_load_rate_score,
        high_load.rate_score AS two_single_score,
        high_load.score AS high_load_score,
        high_load.MONTH AS high_load_month,
        zero_flow.four_zero_flow_rate AS four_zero_flow_rate,
        zero_flow.five_zero_flow_rate AS five_zero_flow_rate,
        zero_flow.zero_flow_rate AS zero_flow_rate,
        zero_flow.four_zero_flow_score AS four_zero_flow_score,
        zero_flow.five_zero_flow_score AS five_zero_flow_score,
        zero_flow.zero_flow_score AS zero_flow_score,
        zero_flow.score AS zero_score,
        zero_flow.MONTH AS zero_flow_month,
        quality_difference.four_quality_difference_rate AS four_quality_difference_rate,
        quality_difference.five_quality_difference_rate AS five_quality_difference_rate,
        quality_difference.quality_difference_rate AS quality_difference_rate,
        quality_difference.four_quality_difference_score AS four_quality_difference_score,
        quality_difference.five_quality_difference_score AS five_quality_difference_score,
        quality_difference.quality_difference_score AS quality_difference_score,
        quality_difference.score AS quality_score,
        quality_difference.MONTH AS quality_month,
        maintain.cel_avg_duration AS cel_avg_duration,
        maintain.cel_avg_duration_score AS cel_avg_duration_score,
        maintain.MONTH AS maintain_month,
        base_break.long_break_rate as long_break_rate,
        base_break.often_break_rate as often_break_rate,
        base_break.long_break_score as long_break_score,
        base_break.often_break_score as often_break_score,
        base_break.score as base_break_score,
        base_break.month as base_break_month,
        data_govern.data_full_rate AS data_full_rate,
        data_govern.data_exact_rate AS data_exact_rate,
        data_govern.data_full_score AS data_full_score,
        data_govern.data_exact_score AS data_exact_score,
        data_govern.score AS data_govern_score,
        data_govern.MONTH AS data_govern_month,
        data_test.test_kilometre AS test_kilometre,
        data_test.test_analyse_score AS test_analyse_score,
        data_test.base_optimize_num AS base_optimize_num,
        data_test.base_optimize_score AS base_optimize_score,
        data_test.score AS data_test_analyse_score,
        data_test.MONTH AS data_test_analyse_month,
        new_order_close.order_close_rate as new_order_close_rate,
        new_order_close.strict_close_rate as new_strict_close_rate,
        new_order_close.maintain_close_rate as new_maintain_close_rate,
        new_order_close.order_close_score as new_order_close_score,
        new_order_close.strict_close_score as new_strict_close_score,
        new_order_close.maintain_close_score as new_maintain_close_score,
        new_order_close.score as new_close_score ,
        new_order_close.month as new_order_month,
        out_serve.out_serve_times_month AS out_serve_times_month,
        out_serve.MONTH AS out_serve_month,
        out_serve.out_serve_times_quarter AS out_serve_times_quarter,
        out_serve.quarter AS out_serve_quarter,
        out_serve.deduction_of_points AS out_serve_deduction_of_points,
        pressure_drop.pressure_drop_rate as pressure_drop_rate,
        pressure_drop.deduction_of_points as pressure_drop_deduction_of_points,
        pressure_drop.month as pressure_drop_month,
        repetition_order.repetition_rate as repetition_order_rate,
        repetition_order.deduction_of_points as repetition_deduction_of_points,
        repetition_order.month as repetition_month,
        poor_benefit.poor_benefit_rate as poor_benefit_rate,
        poor_benefit.deduction_of_points as poor_benefit_deduction_of_points,
        poor_benefit.month as poor_benefit_month,
        (COALESCE(satisfaction.score,0) + COALESCE(move_barrier.score,0) + COALESCE(deal_complaint.score,0) + COALESCE(cover.score,0) + COALESCE(high_load.score,0) + COALESCE(zero_flow.score,0)
        + COALESCE(quality_difference.score,0) + COALESCE(maintain.cel_avg_duration_score,0) + COALESCE(base_break.score,0) + COALESCE(data_govern.score,0) + COALESCE(data_test.score,0) + COALESCE(new_order_close.score,0)
        - COALESCE(out_serve.deduction_of_points,0) - COALESCE(pressure_drop.deduction_of_points,0) - COALESCE(repetition_order.deduction_of_points,0) - COALESCE(poor_benefit.deduction_of_points,0) ) AS score,
        CASE
        WHEN (
        (
        (
        COALESCE(satisfaction.score,0) + COALESCE(move_barrier.score,0) + COALESCE(deal_complaint.score,0) + COALESCE(cover.score,0) + COALESCE(high_load.score,0) + COALESCE(zero_flow.score,0)
        + COALESCE(quality_difference.score,0) + COALESCE(maintain.cel_avg_duration_score,0) + COALESCE(base_break.score,0) + COALESCE(data_govern.score,0) + COALESCE(data_test.score,0) + COALESCE(new_order_close.score,0)
        - COALESCE(out_serve.deduction_of_points,0) - COALESCE(pressure_drop.deduction_of_points,0) - COALESCE(repetition_order.deduction_of_points,0) - COALESCE(poor_benefit.deduction_of_points,0)
        ) / 10
        ) :: INT
        ) > 10 THEN
        10 ELSE (
        (
        COALESCE(satisfaction.score,0) + COALESCE(move_barrier.score,0) + COALESCE(deal_complaint.score,0) + COALESCE(cover.score,0) + COALESCE(high_load.score,0) + COALESCE(zero_flow.score,0)
        + COALESCE(quality_difference.score,0) + COALESCE(maintain.cel_avg_duration_score,0) + COALESCE(base_break.score,0) + COALESCE(data_govern.score,0) + COALESCE(data_test.score,0) + COALESCE(new_order_close.score,0)
        - COALESCE(out_serve.deduction_of_points,0) - COALESCE(pressure_drop.deduction_of_points,0) - COALESCE(repetition_order.deduction_of_points,0) - COALESCE(poor_benefit.deduction_of_points,0)
        ) / 10
        ) :: INT
        END star,
        lastScore.score AS lastScore,
        lastScore.color_card AS lastColorCard,
        lastScoreAfter.score AS lastScoreAfter,
        lastScoreAfter.color_card AS lastColorCardAfter
        FROM area
        left join satisfaction on area.area = satisfaction.area
        and area.area_name = satisfaction.area_name
        LEFT JOIN move_barrier ON area.area = move_barrier.area
        AND area.area_name = move_barrier.area_name
        LEFT JOIN deal_complaint ON area.area = deal_complaint.area
        AND area.area_name = deal_complaint.area_name
        LEFT JOIN cover ON area.area = cover.area
        AND area.area_name = cover.area_name
        LEFT JOIN high_load ON area.area = high_load.area
        AND area.area_name = high_load.area_name
        LEFT JOIN zero_flow ON area.area = zero_flow.area
        AND area.area_name = zero_flow.area_name
        LEFT JOIN quality_difference ON area.area = quality_difference.area
        AND area.area_name = quality_difference.area_name
        LEFT JOIN maintain ON area.area = maintain.area
        AND area.area_name = maintain.area_name
        LEFT JOIN base_break ON area.area = base_break.area
        AND area.area_name = base_break.area_name
        LEFT JOIN data_govern ON area.area = data_govern.area
        AND area.area_name = data_govern.area_name
        LEFT JOIN data_test ON area.area = data_test.area
        AND area.area_name = data_test.area_name
        LEFT JOIN new_order_close ON area.area = new_order_close.area
        AND area.area_name = new_order_close.area_name
        LEFT JOIN out_serve ON area.area = out_serve.area
        AND area.area_name = out_serve.area_name
        LEFT JOIN pressure_drop ON area.area = pressure_drop.area
        AND area.area_name = pressure_drop.area_name
        LEFT JOIN repetition_order ON area.area = repetition_order.area
        AND area.area_name = repetition_order.area_name
        LEFT JOIN poor_benefit ON area.area = poor_benefit.area
        AND area.area_name = poor_benefit.area_name
        LEFT JOIN lastScore ON area.area = lastScore.area
        AND area.area_name = lastScore.area_name
        LEFT JOIN lastScoreAfter ON area.area = lastScoreAfter.area
        AND area.area_name = lastScoreAfter.area_name
        ) SELECT RESULT
        .area AS area,
        RESULT.area_name AS areaName,
        RESULT.voice_quality AS voiceQuality,
        RESULT.internet_quality AS internetQuality,
        RESULT.network_quality_dx AS networkQualityDx,
        RESULT.network_quality_yd AS networkQualityYd,
        RESULT.network_quality_lt AS networkQualityLt,
        RESULT.quarter_lead AS quarterLead,
        RESULT.local_rank AS localRank,
        RESULT.satisfaction_score AS satisfactionScore,
        RESULT.satisfaction_quarter AS satisfactionQuarter,
        RESULT.satisfaction_month AS satisfactionMonth,
        RESULT.in_deal_rate AS inDealRate,
        RESULT.repetition_rate AS repetitionRate,
        RESULT.in_deal_score AS inDealScore,
        RESULT.repetition_score AS repetitionScore,
        RESULT.barrier_score AS barrierScore,
        RESULT.barrier_month AS barrierMonth,
        RESULT.deal_complaint_rate AS dealComplaintRate,
        RESULT.complaint_score AS complaintScore,
        RESULT.complaint_month AS complaintMonth,
        RESULT.friendly_cover_rate AS friendlyCoverRate,
        RESULT.friendly_cover_score AS friendlyCoverScore,
        RESULT.bad_cover_rate AS badCoverRate,
        RESULT.bad_cover_score AS badCoverScore,
        RESULT.cover_month AS coverMonth,
        RESULT.four_high_load_rate AS fourHighLoadRate,
        RESULT.five_high_load_rate AS fiveHighLoadRate,
        RESULT.high_load_rate AS highLoadRate,
        RESULT.two_single_rate AS twoSingleRate,
        RESULT.high_load_rate_score AS highLoadRateScore,
        RESULT.two_single_score AS twoSingleScore,
        RESULT.high_load_score AS highLoadScore,
        RESULT.high_load_month AS highLoadMonth,
        RESULT.four_zero_flow_rate AS fourZeroFlowRate,
        RESULT.five_zero_flow_rate AS fiveZeroFlowRate,
        RESULT.zero_flow_rate AS zeroFlowRate,
        RESULT.four_zero_flow_score AS fourZeroFlowScore,
        RESULT.five_zero_flow_score AS fiveZeroFlowScore,
        RESULT.zero_flow_score AS zeroFlowScore,
        RESULT.zero_score AS zeroScore,
        RESULT.zero_flow_month AS zeroFlowMonth,
        RESULT.four_quality_difference_rate AS fourQualityDifferenceRate,
        RESULT.five_quality_difference_rate AS fiveQualityDifferenceRate,
        RESULT.quality_difference_rate AS qualityDifferenceRate,
        RESULT.four_quality_difference_score AS fourQualityDifferenceScore,
        RESULT.five_quality_difference_score AS fiveQualityDifferenceScore,
        RESULT.quality_difference_score AS qualityDifferenceScore,
        RESULT.quality_score AS qualityScore,
        RESULT.quality_month AS qualityMonth,
        RESULT.cel_avg_duration AS celAvgDuration,
        RESULT.cel_avg_duration_score AS celAvgDurationScore,
        RESULT.maintain_month AS maintainMonth,
        RESULT.long_break_rate as newLongBreakRate,
        RESULT.often_break_rate as newOftenBreakRate,
        RESULT.long_break_score as newLongBreakScore,
        RESULT.often_break_score as newOftenBreakScore,
        RESULT.base_break_score as baseBreakScore,
        RESULT.base_break_month as baseBreakMonth,
        RESULT.data_full_rate AS dataFullRate,
        RESULT.data_exact_rate AS dataExactRate,
        RESULT.data_full_score AS dataFullScore,
        RESULT.data_exact_score AS dataExactScore,
        RESULT.data_govern_score AS dataGovernScore,
        RESULT.data_govern_month AS dataGovernMonth,
        RESULT.test_kilometre AS testKilometre,
        RESULT.test_analyse_score AS testAnalyseScore,
        RESULT.base_optimize_num AS baseOptimizeNum,
        RESULT.base_optimize_score AS baseOptimizeScore,
        RESULT.data_test_analyse_score AS dataTestAnalyseScore,
        RESULT.data_test_analyse_month AS dataTestAnalyseMonth,
        RESULT.new_order_close_rate AS newOrderCloseRate,
        RESULT.new_strict_close_rate AS newStrictOrderCloseRate,
        RESULT.new_maintain_close_rate AS newMaintainOrderCloseRate,
        RESULT.new_order_close_score AS newOrderCloseScore,
        RESULT.new_strict_close_score AS newStrictOrderCloseScore,
        RESULT.new_maintain_close_score AS newMaintainOrderCloseScore,
        RESULT.new_close_score AS newCloseScore,
        RESULT.new_order_month AS newOrderCloseMonth,
        RESULT.out_serve_times_month AS outServeTimesMonth,
        RESULT.out_serve_month AS outServeMonth,
        RESULT.out_serve_times_quarter AS outServeTimesQuarter,
        RESULT.out_serve_quarter AS outServeQuarter,
        RESULT.out_serve_deduction_of_points AS outServeDeductionOfPoints,
        RESULT.pressure_drop_rate AS pressureDropRate,
        RESULT.pressure_drop_deduction_of_points AS pressureDropDeductionOfPoints,
        RESULT.pressure_drop_month AS pressureDropMonth,
        RESULT.repetition_order_rate AS repetitionOrderRate,
        RESULT.repetition_deduction_of_points AS repetitionOrderDeductionOfPoints,
        RESULT.repetition_month AS repetitionOrderMonth,
        RESULT.poor_benefit_rate AS poorBenefitRate,
        RESULT.poor_benefit_deduction_of_points AS poorBenefitDeductionOfPoints,
        RESULT.poor_benefit_month AS poorBenefitMonth,
        RESULT.score AS score,
        RESULT.star AS star,
        RANK ( ) OVER ( PARTITION BY area ORDER BY star DESC ) AS RANK,
        RESULT.lastScore AS lastScore,
        RESULT.lastColorCard AS lastColorCard,
        ( RESULT.score - RESULT.lastScore ) AS lastScoreUpOrDown,
        RESULT.lastScoreAfter AS lastScoreAfter,
        RESULT.lastColorCardAfter AS lastColorCardAfter,
        ( RESULT.lastScore - RESULT.lastScoreAfter ) AS lastScoreAfterUpOrDown,
        ${month} AS MONTH
        FROM
        RESULT
    </select>
    <select id="indicatorOfMyWorkSpace"
            resultType="com.wxwy.intelligentOptimization.moudle.vo.despoilStar.WorkSpaceVO">
        with tba as (
            select
                *
            from app_io_star_rank
            <where>
                month = (select max(month) from app_io_star_rank)
                <if test="areaName!='重庆市' or areaName != ''">
                    and area_name = #{areaName}
                </if>
            </where>
        )
        select
            '满意度测评' as indicatorName,
            round(quarter_lead,2)::varchar as indicatorValue,
            false as color,
            '移动网络质量满意度测评领先值=本季度电信移动网络质量满意度-max(本季度移动、联通移动网络质量满意度)' as indicatorDescribe
        from tba
        union all
        select
            '移动用户故障处理' as indicatorName,
            concat(concat(round(in_deal_rate * 100, 2)::varchar, '%'),';',concat(round(in_response_rate * 100, 2)::varchar, '%'),';',concat(round(repetition_rate * 100, 2)::varchar, '%'),';',concat(round(move_barrier_favorable_rate * 100, 2)::varchar, '%')) as indicatorValue,
            false as color,
            '1、响应及时率=响应及时工单量/工单总量；
             2、处理及时率=处理及时工单量/工单总量*100%；
             3、重复申诉率=重复申诉工单量/工单总量*100%，重复申诉工单为同一用户一个月内在同一地点反馈同一问题；
             4、10分好评率=评测中用户反馈为“10分” / 参评量。' as indicatorDescribe
        from tba
        union all
        select
            'TOP栅格处置率' as indicatorName,
            concat(round(deal_complaint_rate * 100, 2)::varchar, '%') as indicatorValue,
            false as color,
            '栅格投诉处置率=已解决的融合派单数量/融合派单总数量*100%' as indicatorDescribe
        from tba
        union all
        select
            '4/5G高负荷小区比例' as indicatorName,
            concat(concat(round(four_high_load_rate * 100, 2)::varchar, '%'),';',concat(round(five_high_load_rate * 100, 2)::varchar, '%')) as indicatorValue,
            false as color,
            '1、4G高负荷小区比例（不含800M)=月高负荷小区数量/小区总量，4G高负荷小区数量=一月内有10天及以上出现过小区自忙时上行或下行PRB负荷≥70%或RRC连接用户数＞=200（1.8G/2.1G,20M带宽）、RRC连接用户数＞=150（1.8G,15M带宽）的小区计为月粒度的PRB高负荷小区。
             2、5G高负荷小区比例=月高负荷小区数量/小区总量。
             承建区：5G高负荷小区数量=一月内有18天及以上出现过小区自忙时上行或下行PRB负荷≥70%的小区计为月粒度的PRB高负荷小区。
             非承建区：月度5G高负荷小区数量=每周7天有4天及以上满足集团容量管理办法规则（详细规则请见该表格最后），且连续4个自然周内出现2周及以上的小区。' as indicatorDescribe
        from tba
        union all
        select
            '4/5G质差小区比例' as indicatorName,
            concat(concat(round(four_quality_difference_rate * 100, 2)::varchar, '%'),';',concat(round(five_quality_difference_rate * 100, 2)::varchar, '%')) as indicatorValue,
            false as color,
            '1、4G质差小区比例=（低速率小区+低接入小区+高掉线小区）/小区总数；
        低速率：用户下行平均速率低于&lt;8Mbps（20M带宽）,5.5Mbps（15M带宽，其他带宽门限可折算）,提取小区级每天自忙时分子分母按月汇总(SUM分子/SUM分母)后计算吞吐率；
        低接入：无线接入成功率&lt;98%；
        高掉线： E-RAB掉线率&gt;2%;
        2、5G质差小区比例=（低速率小区+低接入小区+高掉线小区）/小区总数
        低速率：用户下行平均速率低于&lt;40Mbps（NR3.5G）,20Mbps（NR2.1G40M带宽，其他带宽门限可折算）；
        低接入：无线接入成功率&lt;98%；
        高掉线： UE上下文掉线率>2%' as indicatorDescribe
        from tba
        union all
        select
            '4/5G弱覆盖且劣于竞对场景点占比' as indicatorName,
            concat(concat(round(four_weak_cover_rate * 100, 2)::varchar, '%'),';',concat(round(five_weak_cover_rate * 100, 2)::varchar, '%')) as indicatorValue,
            false as color,
            '4G弱覆盖且劣于竞对场景点占比=（电信采样点>有效采样点门限&amp;电信覆盖率&lt;90%）且（移动采样点>有效采样点门限&amp;电信覆盖率劣于移动5pp）场景点数量/电信采样点&gt;有效采样点的场景点数量
        5G弱覆盖且劣于竞对场景点占比=（电信采样点>有效采样点门限&amp;电信覆盖率&lt;85%）且（移动采样点&gt;有效采样点门限&amp;电信覆盖率劣于移动5pp）场景点数量/电信采样点&gt;有效采样点门限的场景点数量；（剔除住宅小区）
        有效采样点门限规则：主城和一类县区1000个，其他县区500个。' as indicatorDescribe
        from tba
        union all
        select
            '重点场景SINR质差楼宇比例' as indicatorName,
            concat(concat(round(four_key_scene_quality_rate * 100, 2)::varchar, '%'),';',round(pressure_drop_value,2)) as indicatorValue,
            false as color,
            '重点场景SINR质差楼宇占比=（楼宇SINR&lt;-3的比例）&gt;15%且非弱覆盖（4G覆盖率&gt;90%）楼宇数/有效楼宇数；
        有效楼宇数=月度MR采样点&gt;80个楼宇数；
        考核范围：信通院6000+本地4308十大重点场景并集，落在十大场景Polygon范围内的楼宇合集。' as indicatorDescribe
        from tba
        union all
        select
            '工单闭环率' as indicatorName,
            concat(concat(round(order_close_rate * 100, 2)::varchar, '%'),';',concat(round(strict_close_rate * 100, 2)::varchar, '%'),';',concat(round(new_maintain_order_close_rate * 100, 2)::varchar, '%')) as indicatorValue,
            false as color,
            '1、工单闭环率=工单闭环数/派单总数*100%；
             2、最严工单闭环率=最严工单闭环数/最严工单总数*100%
             3、维护工单处置闭环率=无线运营系统维护工单闭环数/派单总数*100%' as indicatorDescribe
        from tba
        union all
        select
            '4/5G基站AB类小区平均退服时长' as indicatorName,
            concat(cel_avg_duration) as indicatorValue,
            false as color,
            '每天4/5G高价值小区平均业务中断时长=（4G+5G高价值小区退服总时长）/（4G+5G高价值小区总数量）' as indicatorDescribe
        from tba
        union all
        select
            '“三超”故障' as indicatorName,
            concat(fault_out_serve_times_month,';',concat(round(over_length_rate * 100, 2)::varchar, '%'),';',concat(round(fault_often_break_rate * 100, 2)::varchar, '%')) as indicatorValue,
            false as color,
            '批量退服次数：5分钟内批量退服小区>=30个或基站>=10个计为1次；
             基站超长断站率=超长断站数/（设备总数），4/5G(包含皮基站）断站时长超过2天、告警屏蔽小区(包括告警调测状态)，判断为超长断站。
             基站频繁断站率=超频断站数/设备数；4/5G基站（包含皮基站）一个月内断站次数>=35次定义为超频断站。' as indicatorDescribe
        from tba
        union all
        select
            '低效益站址压降' as indicatorName,
            concat(concat(round(new_poor_benefit_reach * 100,2)::varchar,'%'),';',concat(round(new_poor_benefit_average * 100,2),'%')) as indicatorValue,
            false as color,
            '低效益站址压降：低效益站址比例压降超10%。
             T0为24年1月至24年11月各分公司低效益平均值，T1为25年1月至25年11月各分公司低效益平均值。' as indicatorDescribe
        from tba
        union all
        select
            '基础数据' as indicatorName,
            concat(concat(round(data_full_rate * 100, 2)::varchar, '%'),';',concat(round(data_exact_rate * 100, 2)::varchar, '%')) as indicatorValue,
            false as color,
             '基础数据完整率：基础数据治理完整率方面的考核网元有站址表、室分表和天线表等重要网元的完整率，其中站址表考核占比为50%，室分和天线表考核分别占比分别为25%；每个网元里面包含一系列的必填字段，所有必填字段完成填报则此网元完整，如维护单位填写。本次考核包含电信华为、电信中兴、4G皮基站和5G小站数据；联通基础数据待联通站址自动生成后按需纳入考核。
        基础数据准确率：准确率主要考核小区经纬度、天线方位角是否接反、铁塔站址编码匹配率、乡镇准确率。小区经纬度占比50%，天线方位角是否接反和铁塔站址编码匹配率占比分别为15%，乡镇准确率占比为20%。4G小区经纬度误差范围为1KM，5G小区经纬度误差范围为1KM；分母为已稽查的小区数目，分子为经纬度超过误差范围的小区数目。本次考核包含电信华为、电信中兴、4G皮基站和5G小站数据；联通基础数据待联通站址自动生成后按需纳入考核。'  as indicatorDescribe
        from tba
    </select>
    <select id="generateNewRankTableTwo"
            resultType="com.wxwy.intelligentOptimization.moudle.vo.despoilStar.GenerateStarRankCardVO">
        WITH area as(
        select area,builder,area_name from dim_io_star_area_conf
        ),
        <!-- 质差小区比例 -->
        quality_difference AS (
        SELECT
        area,
        area_name,
        four_quality_difference_rate,
        five_quality_difference_rate,
        quality_difference_rate,
        four_quality_difference_score,
        five_quality_difference_score,
        quality_difference_score,
        score,
        MONTH,
        gmt_create
        FROM
        app_io_star_quality_difference
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_quality_difference)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 数据治理 -->
        data_govern AS ( SELECT area, area_name, data_full_rate, data_exact_rate, data_full_score, data_exact_score,
        score, MONTH, gmt_create FROM app_io_star_data_govern WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_data_govern)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 4/5G基站AB类小区平均退服时长 -->
        maintain AS ( SELECT area, area_name, cel_avg_duration, cel_avg_duration_score, MONTH, gmt_create FROM
        app_io_star_maintain
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_maintain)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 高负荷小区比例 -->
        high_load AS (
        SELECT
        area,
        area_name,
        four_high_load_rate,
        five_high_load_rate,
        MONTH,
        four_high_load_score,
        five_high_load_score,
        score,
        gmt_create
        FROM
        app_io_star_high_load
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_high_load)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!--TOP栅格投诉处理-->
        deal_complaint AS (
        SELECT
            area,
            area_name,
            deal_complaint_rate,
            score,
            MONTH,
            gmt_create
        FROM
        app_io_star_deal_complaint
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_deal_complaint)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 满意度测评 -->
        satisfaction AS (
        SELECT
            area,
            area_name,
            quarter_lead,
            local_rank,
            score,
            quarter,
            MONTH,
            gmt_create
        FROM
        app_io_star_satisfaction
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_satisfaction)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 移动用户故障处理(十分好评率) -->
        move_barrier_favorable AS (
        SELECT
            area,
            area_name,
            favorable_rate,
            favorable_score,
            month,
            gmt_create
        FROM
        app_io_star_move_barrier_favorable_rate
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_move_barrier_favorable_rate)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- “三超”故障(批量退服) -->
        falut_out_serve AS (
        SELECT
        area,
        area_name,
        out_serve_times_month,
        out_serve_times_quarter,
        score,
        gmt_create,
        month
        FROM
        app_io_star_fault_out_serve
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_fault_out_serve)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- “三超”故障(频繁断站) -->
        fault_often_break AS (
        SELECT
            area,
            area_name,
            often_break_rate,
            score,
            month,
            gmt_create
        FROM
        app_io_star_fault_often_break
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_fault_often_break)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- “三超”故障(超长断站率) -->
        over_length AS (
        SELECT
        area,
        area_name,
        over_length_rate,
        score,
        month,
        gmt_create
        FROM
        app_io_star_over_length
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_over_length)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 重点场景SINR质差比例 -->
        key_scene_quality_difference AS (
        SELECT
            area,
            area_name,
            four_key_scene_quality_rate,
            pressure_drop_value,
            four_key_scene_quality_score,
            pressure_drop_value_score,
            score,
            month,
            gmt_create
        FROM app_io_star_key_scene_quality_difference
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_key_scene_quality_difference)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 工单闭环率(维护) -->
        main_tain_order_close AS (
        SELECT
        area,
        area_name,
        maintain_close_rate,
        maintain_close_score,
        month,
        gmt_create
        FROM app_io_star_maintain_order_close WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_maintain_order_close)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 工单闭环率(普通、最严) -->
        order_close AS (
        SELECT
        area,
        area_name,
        order_close_rate,
        strict_close_rate,
        order_close_score,
        strict_close_score,
        score,
        month,
        gmt_create
        FROM app_io_star_order_close WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_order_close)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- BBU GNSS天馈系统不稳定率 -->
        feedback_system_instability AS (
        SELECT
            area,
            area_name,
            four_instability_rate,
            four_deduction_of_points,
            five_instability_rate,
            five_deduction_of_points,
            month,
            gmt_create
        FROM app_io_star_feedback_system_instability WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_feedback_system_instability)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 45G弱覆盖且劣于竞对物业点占比 -->
        weak_cover AS (
        SELECT
        area,
        area_name,
        four_weak_cover_rate,
        five_weak_cover_rate,
        four_weak_cover_score,
        five_weak_cover_score,
        score,
        month,
        gmt_create
        FROM
        app_io_star_weak_cover
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_weak_cover)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 低效益站址压降(2025) -->
        new_poor_benefit AS (
        SELECT
            area,
            area_name,
            poor_benefit_average,
            poor_benefit_reach,
            score,
            month,
            gmt_create
        FROM
        app_io_star_new_poor_benefit
        WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_new_poor_benefit)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        <!-- 移动用户故障处理(响应、处理、重复申告) -->
        new_move_barrier AS (
        SELECT
            area,
            area_name,
            in_deal_rate,
            repetition_rate,
            in_deal_score,
            repetition_score,
            in_response_rate,
            in_response_score,
            score,
            month,
            gmt_create
        FROM app_io_star_new_move_barrier WHERE
        <choose>
            <when test="@org.apache.commons.lang.BooleanUtils@isTrue(flag)">
                month = (select max(month) from app_io_star_move_barrier)
            </when>
            <otherwise>
                MONTH = #{month}
            </otherwise>
        </choose>
        ),
        lastScore AS ( SELECT area, area_name, score, color_card FROM app_io_star_rank WHERE MONTH = #{lastMonth} ),
        lastScoreAfter AS ( SELECT area, area_name, score, color_card FROM app_io_star_rank WHERE MONTH = #{lastMonthAfter} ),
        RESULT AS (
        SELECT
        area.area AS area,
        area.builder AS builder,
        area.area_name AS area_name,
        quality_difference.four_quality_difference_rate AS four_quality_difference_rate,
        quality_difference.five_quality_difference_rate AS five_quality_difference_rate,
        quality_difference.quality_difference_rate AS quality_difference_rate,
        quality_difference.four_quality_difference_score AS four_quality_difference_score,
        quality_difference.five_quality_difference_score AS five_quality_difference_score,
        quality_difference.quality_difference_score AS quality_difference_score,
        quality_difference.score AS quality_score,
        quality_difference.MONTH AS quality_month,
        data_govern.data_full_rate AS data_full_rate,
        data_govern.data_exact_rate AS data_exact_rate,
        data_govern.data_full_score AS data_full_score,
        data_govern.data_exact_score AS data_exact_score,
        data_govern.score AS data_govern_score,
        data_govern.MONTH AS data_govern_month,
        maintain.cel_avg_duration AS cel_avg_duration,
        maintain.cel_avg_duration_score AS cel_avg_duration_score,
        maintain.MONTH AS maintain_month,
        high_load.four_high_load_rate AS four_high_load_rate,
        high_load.five_high_load_rate AS five_high_load_rate,
        high_load.four_high_load_score AS four_high_load_score,
        high_load.five_high_load_score AS five_high_load_score,
        high_load.score AS high_load_score,
        high_load.MONTH AS high_load_month,
        deal_complaint.deal_complaint_rate AS deal_complaint_rate,
        deal_complaint.score AS complaint_score,
        deal_complaint.month as complaint_month,
        satisfaction.quarter_lead AS quarter_lead,
        satisfaction.local_rank AS local_rank,
        satisfaction.score AS satisfaction_score,
        satisfaction.MONTH AS satisfaction_month,
        move_barrier_favorable.favorable_rate as  move_barrier_favorable_rate,
        move_barrier_favorable.favorable_score as move_barrier_favorable_score,
        move_barrier_favorable.month as move_barrier_favorable_month,
        falut_out_serve.out_serve_times_month as fault_out_serve_times_month ,
        falut_out_serve.out_serve_times_quarter as fault_out_serve_times_quarter,
        falut_out_serve.score as fault_out_serve_score,
        falut_out_serve.month as fault_out_serve_month,
        fault_often_break.often_break_rate as fault_often_break_rate,
        fault_often_break.score as fault_often_break_score,
        fault_often_break.month as fault_often_break_month,
        over_length.over_length_rate as over_length_rate,
        over_length.score as over_length_score,
        over_length.month as over_length_month,
        key_scene_quality_difference.four_key_scene_quality_rate as four_key_scene_quality_rate,
        key_scene_quality_difference.pressure_drop_value as pressure_drop_value,
        key_scene_quality_difference.four_key_scene_quality_score as four_key_scene_quality_score,
        key_scene_quality_difference.pressure_drop_value_score as pressure_drop_value_score,
        key_scene_quality_difference.score as key_scene_quality_difference_score,
        key_scene_quality_difference.month as key_scene_quality_difference_month,
        main_tain_order_close.maintain_close_rate as maintain_close_rate,
        main_tain_order_close.maintain_close_score as maintain_close_score,
        main_tain_order_close.month as maintain_close_month,
        order_close.order_close_rate as order_close_rate,
        order_close.strict_close_rate as strict_close_rate,
        order_close.order_close_score as order_close_score,
        order_close.strict_close_score as strict_close_score,
        order_close.score as close_score,
        order_close.month as close_month,
        feedback_system_instability.four_instability_rate as four_instability_rate,
        feedback_system_instability.four_deduction_of_points as four_deduction_of_points,
        feedback_system_instability.five_instability_rate as five_instability_rate,
        feedback_system_instability.five_deduction_of_points as five_deduction_of_points,
        feedback_system_instability.month as feedback_system_instability_month,
        weak_cover.four_weak_cover_rate as four_weak_cover_rate,
        weak_cover.five_weak_cover_rate as five_weak_cover_rate,
        weak_cover.four_weak_cover_score as four_weak_cover_score,
        weak_cover.five_weak_cover_score as five_weak_cover_score,
        weak_cover.score as weak_cover_score,
        weak_cover.month as weak_cover_month,
        new_poor_benefit.poor_benefit_average as poor_benefit_average,
        new_poor_benefit.poor_benefit_reach as poor_benefit_reach,
        new_poor_benefit.score as new_poor_benefit_score,
        new_poor_benefit.month as new_poor_benefit_month,
        new_move_barrier.in_deal_rate as in_deal_rate,
        new_move_barrier.repetition_rate as repetition_rate,
        new_move_barrier.in_deal_score as in_deal_score,
        new_move_barrier.repetition_score as repetition_score,
        new_move_barrier.in_response_rate as in_response_rate,
        new_move_barrier.in_response_score as in_response_score,
        new_move_barrier.score as new_move_barrier_score,
        new_move_barrier.month as new_move_barrier_month,

        (COALESCE(quality_difference.score,0) + COALESCE(data_govern.score,0) + COALESCE(maintain.cel_avg_duration_score,0) + COALESCE(high_load.score,0) + COALESCE(deal_complaint.score,0) +
        COALESCE(satisfaction.score,0) + COALESCE(move_barrier_favorable.favorable_score,0) + COALESCE(falut_out_serve.score,0) + COALESCE(fault_often_break.score,0) + COALESCE(over_length.score,0) +
        COALESCE(key_scene_quality_difference.score,0) + COALESCE(main_tain_order_close.maintain_close_score,0) + COALESCE(order_close.score,0) + COALESCE(weak_cover.score,0) + COALESCE(new_poor_benefit.score,0) +
        COALESCE(new_move_barrier.score,0) - COALESCE(feedback_system_instability.four_deduction_of_points,0) - COALESCE(feedback_system_instability.five_deduction_of_points,0)
        ) AS score,

        CASE
        WHEN (
        (
        (
        COALESCE(quality_difference.score,0) + COALESCE(data_govern.score,0) + COALESCE(maintain.cel_avg_duration_score,0) + COALESCE(high_load.score,0) + COALESCE(deal_complaint.score,0) +
        COALESCE(satisfaction.score,0) + COALESCE(move_barrier_favorable.favorable_score,0) + COALESCE(falut_out_serve.score,0) + COALESCE(fault_often_break.score,0) + COALESCE(over_length.score,0) +
        COALESCE(key_scene_quality_difference.score,0) + COALESCE(main_tain_order_close.maintain_close_score,0) + COALESCE(order_close.score,0) + COALESCE(weak_cover.score,0) + COALESCE(new_poor_benefit.score,0) +
        COALESCE(new_move_barrier.score,0) - COALESCE(feedback_system_instability.four_deduction_of_points,0) - COALESCE(feedback_system_instability.five_deduction_of_points,0)
        ) / 10
        ) :: INT
        ) > 10 THEN
        10 ELSE (
        (
        COALESCE(quality_difference.score,0) + COALESCE(data_govern.score,0) + COALESCE(maintain.cel_avg_duration_score,0) + COALESCE(high_load.score,0) + COALESCE(deal_complaint.score,0) +
        COALESCE(satisfaction.score,0) + COALESCE(move_barrier_favorable.favorable_score,0) + COALESCE(falut_out_serve.score,0) + COALESCE(fault_often_break.score,0) + COALESCE(over_length.score,0) +
        COALESCE(key_scene_quality_difference.score,0) + COALESCE(main_tain_order_close.maintain_close_score,0) + COALESCE(order_close.score,0) + COALESCE(weak_cover.score,0) + COALESCE(new_poor_benefit.score,0) +
        COALESCE(new_move_barrier.score,0) - COALESCE(feedback_system_instability.four_deduction_of_points,0) - COALESCE(feedback_system_instability.five_deduction_of_points,0)
        ) / 10
        ) :: INT
        END star,
        lastScore.score AS lastScore,
        lastScore.color_card AS lastColorCard,
        lastScoreAfter.score AS lastScoreAfter,
        lastScoreAfter.color_card AS lastColorCardAfter
        FROM area
        left join quality_difference on area.area = quality_difference.area
        and area.area_name = quality_difference.area_name
        LEFT JOIN data_govern ON area.area = data_govern.area
        AND area.area_name = data_govern.area_name
        LEFT JOIN maintain ON area.area = maintain.area
        AND area.area_name = maintain.area_name
        LEFT JOIN high_load ON area.area = high_load.area
        AND area.area_name = high_load.area_name
        LEFT JOIN deal_complaint ON area.area = deal_complaint.area
        AND area.area_name = deal_complaint.area_name
        LEFT JOIN satisfaction ON area.area = satisfaction.area
        AND area.area_name = satisfaction.area_name
        LEFT JOIN move_barrier_favorable ON area.area = move_barrier_favorable.area
        AND area.area_name = move_barrier_favorable.area_name
        LEFT JOIN falut_out_serve ON area.area = falut_out_serve.area
        AND area.area_name = falut_out_serve.area_name
        LEFT JOIN fault_often_break ON area.area = fault_often_break.area
        AND area.area_name = fault_often_break.area_name
        LEFT JOIN over_length ON area.area = over_length.area
        AND area.area_name = over_length.area_name
        LEFT JOIN key_scene_quality_difference ON area.area = key_scene_quality_difference.area
        AND area.area_name = key_scene_quality_difference.area_name
        LEFT JOIN main_tain_order_close ON area.area = main_tain_order_close.area
        AND area.area_name = main_tain_order_close.area_name
        LEFT JOIN order_close ON area.area = order_close.area
        AND area.area_name = order_close.area_name
        LEFT JOIN feedback_system_instability ON area.area = feedback_system_instability.area
        AND area.area_name = feedback_system_instability.area_name
        LEFT JOIN weak_cover ON area.area = weak_cover.area
        AND area.area_name = weak_cover.area_name
        LEFT JOIN new_poor_benefit ON area.area = new_poor_benefit.area
        AND area.area_name = new_poor_benefit.area_name
        LEFT JOIN new_move_barrier ON area.area = new_move_barrier.area
        AND area.area_name = new_move_barrier.area_name
        LEFT JOIN lastScore ON area.area = lastScore.area
        AND area.area_name = lastScore.area_name
        LEFT JOIN lastScoreAfter ON area.area = lastScoreAfter.area
        AND area.area_name = lastScoreAfter.area_name
        ) SELECT
        RESULT.area AS area,
        RESULT.builder AS builder,
        RESULT.area_name AS areaName,
        RESULT.four_quality_difference_rate AS fourQualityDifferenceRate,
        RESULT.five_quality_difference_rate AS fiveQualityDifferenceRate,
        RESULT.quality_difference_rate AS qualityDifferenceRate,
        RESULT.four_quality_difference_score AS fourQualityDifferenceScore,
        RESULT.five_quality_difference_score AS fiveQualityDifferenceScore,
        RESULT.quality_difference_score AS qualityDifferenceScore,
        RESULT.quality_score AS qualityScore,
        RESULT.quality_month AS qualityMonth,
        RESULT.data_full_rate AS dataFullRate,
        RESULT.data_exact_rate AS dataExactRate,
        RESULT.data_full_score AS dataFullScore,
        RESULT.data_exact_score AS dataExactScore,
        RESULT.data_govern_score AS dataGovernScore,
        RESULT.data_govern_month AS dataGovernMonth,
        RESULT.cel_avg_duration AS celAvgDuration,
        RESULT.cel_avg_duration_score AS celAvgDurationScore,
        RESULT.maintain_month AS maintainMonth,
        RESULT.four_high_load_rate AS fourHighLoadRate,
        RESULT.five_high_load_rate AS fiveHighLoadRate,
        RESULT.four_high_load_score AS highLoadRateScore,
        RESULT.five_high_load_score AS twoSingleScore,
        RESULT.high_load_score AS highLoadScore,
        RESULT.high_load_month AS highLoadMonth,
        RESULT.deal_complaint_rate AS dealComplaintRate,
        RESULT.complaint_score AS complaintScore,
        RESULT.complaint_month AS complaintMonth,
        RESULT.quarter_lead AS quarterLead,
        RESULT.local_rank AS localRank,
        RESULT.satisfaction_score AS satisfactionScore,
        RESULT.satisfaction_month AS satisfactionMonth,
        RESULT.move_barrier_favorable_rate AS moveBarrierFavorableRate,
        RESULT.move_barrier_favorable_score AS moveBarrierFavorableScore,
        RESULT.move_barrier_favorable_month AS moveBarrierFavorableMonth,
        RESULT.fault_out_serve_times_month AS faultOutServeTimesMonth,
        RESULT.fault_out_serve_times_quarter AS faultOutServeTimesQuarter,
        RESULT.fault_out_serve_score AS faultOutServeScore,
        RESULT.fault_out_serve_month AS faultOutServeMonth,
        RESULT.fault_often_break_rate AS faultOftenBreakRate,
        RESULT.fault_often_break_score AS faultOftenBreakScore,
        RESULT.fault_often_break_month AS faultOftenBreakMonth,
        RESULT.over_length_rate AS overLengthRate,
        RESULT.over_length_score AS overLengthScore,
        RESULT.over_length_month AS overLengthMonth,
        RESULT.four_key_scene_quality_rate AS fourKeySceneQualityRate,
        RESULT.pressure_drop_value AS pressureDropValue,
        RESULT.four_key_scene_quality_score AS fourKeySceneQualityScore,
        RESULT.pressure_drop_value_score AS pressureDropValueScore,
        RESULT.key_scene_quality_difference_score AS keySceneQualityDifferenceScore,
        RESULT.key_scene_quality_difference_month AS keySceneQualityDifferenceMonth,
        RESULT.maintain_close_rate AS newMaintainOrderCloseRate,
        RESULT.maintain_close_score AS newMaintainOrderCloseScore,
        RESULT.maintain_close_month as newOrderCloseMonth,
        RESULT.order_close_rate as orderCloseRate,
        RESULT.strict_close_rate as strictCloseRate,
        RESULT.order_close_score as orderCloseScore,
        RESULT.strict_close_score as strictCloseScore,
        RESULT.close_score as closeScore,
        RESULT.close_month AS orderCloseMonth,
        RESULT.four_instability_rate AS fourInstabilityRate,
        RESULT.four_deduction_of_points AS fourDeductionOfPoints,
        RESULT.five_instability_rate AS fiveInstabilityRate,
        RESULT.five_deduction_of_points AS fiveDeductionOfPoints,
        RESULT.feedback_system_instability_month AS feedbackSystemInstabilityMonth,
        RESULT.four_weak_cover_rate AS fourWeakCoverRate,
        RESULT.five_weak_cover_rate AS fiveWeakCoverRate,
        RESULT.four_weak_cover_score AS fourWeakCoverScore,
        RESULT.five_weak_cover_score AS fiveWeakCoverScore,
        RESULT.weak_cover_score AS weakCoverScore,
        RESULT.weak_cover_month AS weakCoverMonth,
        RESULT.poor_benefit_average AS poorBenefitAverage,
        RESULT.poor_benefit_reach AS poorBenefitReach,
        RESULT.new_poor_benefit_score AS newPoorBenefitScore,
        RESULT.new_poor_benefit_month AS newPoorBenefitMonth,
        RESULT.in_deal_rate AS inDealRate,
        RESULT.repetition_rate AS repetitionRate,
        RESULT.in_deal_score AS inDealScore,
        RESULT.repetition_score AS repetitionScore,
        RESULT.in_response_rate AS inResponseRate,
        RESULT.in_response_score AS inResponseScore,
        RESULT.new_move_barrier_score AS barrierScore,
        RESULT.new_move_barrier_month AS barrierMonth,
        RESULT.score AS score,
        RESULT.star AS star,
        RANK ( ) OVER ( PARTITION BY area ORDER BY star DESC ) AS RANK,
        RESULT.lastScore AS lastScore,
        RESULT.lastColorCard AS lastColorCard,
        ( RESULT.score - RESULT.lastScore ) AS lastScoreUpOrDown,
        RESULT.lastScoreAfter AS lastScoreAfter,
        RESULT.lastColorCardAfter AS lastColorCardAfter,
        ( RESULT.lastScore - RESULT.lastScoreAfter ) AS lastScoreAfterUpOrDown,
        ${month} AS MONTH
        FROM
        RESULT
    </select>
    <select id="selectIndicatorDetailInfo" resultType="java.util.Map">
        select
               distinct
        ${baseSql},
        month::varchar as month
        from app_io_star_rank
        <where>
            month between #{start} and #{end}
            and area_name = #{areaName}
            order by month
        </where>
    </select>
    <select id="getTableTitle" resultType="java.util.LinkedHashMap">
        SELECT
            a.attname AS field,
            d.description AS title
        FROM
            pg_catalog.pg_attribute a
                LEFT JOIN
            pg_catalog.pg_description d ON (a.attrelid = d.objoid AND a.attnum = d.objsubid)
        WHERE
            a.attrelid = 'wxyyzc.app_io_star_rank'::regclass
            AND a.attnum > 0
            AND NOT a.attisdropped
            and a.attname in
            <foreach collection="keyList" separator="," close=")" open="(" index="index" item="item">
                #{item}
            </foreach>
        ORDER BY
            a.attnum
    </select>
    <select id="downLoadDetailTwoInfo"
            resultType="com.wxwy.intelligentOptimization.moudle.vo.despoilStar.AppIoStarRankAllVO">
        select area,
        area_name,
        voice_quality,
        internet_quality,
        network_quality_dx,
        network_quality_yd,
        network_quality_lt,
        quarter_lead,
        local_rank,
        satisfaction_score,
        satisfaction_quarter,
        satisfaction_month,
        in_deal_rate,
        repetition_rate,
        in_deal_score,
        repetition_score,
        (barrier_score+move_barrier_favorable_score) as barrier_score,
        barrier_month,
        deal_complaint_rate,
        complaint_score,
        complaint_month,
        friendly_cover_rate,
        friendly_cover_score,
        bad_cover_rate,
        bad_cover_score,
        cover_month,
        four_high_load_rate,
        five_high_load_rate,
        high_load_rate,
        two_single_rate,
        high_load_rate_score,
        two_single_score,
        high_load_score,
        high_load_month,
        four_zero_flow_rate,
        five_zero_flow_rate,
        zero_flow_rate,
        four_zero_flow_score,
        five_zero_flow_score,
        zero_flow_score,
        zero_score,
        zero_flow_month,
        four_quality_difference_rate,
        five_quality_difference_rate,
        quality_difference_rate,
        four_quality_difference_score,
        five_quality_difference_score,
        quality_difference_score,
        quality_score,
        quality_month,
        cel_avg_duration,
        cel_avg_duration_score,
        maintain_month,
        over_length_rate,
        over_length_score,
        over_length_month,
        data_full_rate,
        data_exact_rate,
        data_full_score,
        data_exact_score,
        data_govern_score,
        data_govern_month,
        test_kilometre,
        test_analyse_score,
        base_optimize_num,
        base_optimize_score,
        data_test_analyse_score,
        data_test_analyse_month,
        order_close_rate,
        strict_close_rate,
        order_close_score,
        strict_close_score,
        (close_score+new_maintain_order_close_score) as close_score,
        order_close_month,
        appraisal_list_deduction,
        appraisal_deduction_of_points,
        appraisal_month,
        out_serve_times_month,
        out_serve_month,
        out_serve_times_quarter,
        out_serve_quarter,
        out_serve_deduction_of_points,
        often_break_rate,
        often_break_deduction_of_points,
        often_break_month,
        score,
        star,
        rank,
        color_card,
        month,
        gmt_create,
        new_long_break_rate,
        new_long_break_score,
        new_often_break_rate,
        new_often_break_score,
        base_break_score,
        base_break_month,
        new_order_close_rate,
        new_strict_order_close_rate,
        new_maintain_order_close_rate,
        new_order_close_score,
        new_strict_order_close_score,
        new_maintain_order_close_score,
        new_close_score,
        new_order_close_month,
        pressure_drop_rate,
        pressure_drop_deduction_of_points,
        pressure_drop_month,
        repetition_order_rate,
        repetition_order_deduction_of_points,
        repetition_order_month,
        poor_benefit_rate,
        poor_benefit_deduction_of_points,
        poor_benefit_month,
        builder,
        move_barrier_favorable_rate,
        move_barrier_favorable_score,
        move_barrier_favorable_month,
        fault_out_serve_times_month,
        fault_out_serve_times_quarter,
        fault_out_serve_times_score,
        fault_out_serve_month,
        fault_often_break_rate,
        fault_often_break_score,
        fault_often_break_month,
        (fault_out_serve_times_score+fault_often_break_score+over_length_score) as three_fault_score,
        four_key_scene_quality_rate,
        pressure_drop_value,
        four_key_scene_quality_score,
        pressure_drop_value_score,
        key_scene_quality_score,
        key_scene_quality_month,
        four_weak_cover_rate,
        five_weak_cover_rate,
        four_weak_cover_score,
        five_weak_cover_score,
        weak_cover_score,
        weak_cover_month,
        four_instability_rate,
        four_deduction_of_points,
        five_instability_rate,
        five_deduction_of_points,
        feedback_system_instability_month,
        new_poor_benefit_average,
        new_poor_benefit_reach,
        new_poor_benefit_score,
        new_poor_benefit_month,
        in_response_rate,
        in_response_score
        from app_io_star_rank
        where month = #{month}
        <if test="areaName!=null and areaName != ''">
            and area_name = #{areaName}
        </if>
    </select>
    <select id="indicatorTopNew" resultType="com.wxwy.intelligentOptimization.moudle.vo.IndicatorTopVO">
        with tba as (SELECT * FROM "app_io_star_rank" where month = #{month}),
        result as (
        select
        '45G质差小区比例' as indicatorName,
        count (*) as num,
        string_agg(area_name, '、') as areaNameList
        from tba
        where quality_score = 0
        union all
        select
        '基础数据治理' as indicatorName,
        count (*) as num,
        string_agg(area_name, '、') as areaNameList
        from tba
        where data_govern_score = 0
        union all
        select
        '45G基站AB类小区平均退服时长' as indicatorName,
        count (*) as num,
        string_agg(area_name, '、') as areaNameList
        from tba
        where cel_avg_duration_score = 0
        union all
        select
        '45G高负荷小区比例' as indicatorName,
        count (*) as num,
        string_agg(area_name, '、') as areaNameList
        from tba
        where high_load_score = 0
        union all
        select
        'TOP栅格投诉处置率' as indicatorName,
        count (*) as num,
        string_agg(area_name, '、') as areaNameList
        from tba
        where complaint_score = 0
        union all
        select
        '满意度测评' as indicatorName,
        count (*) as num,
        string_agg(area_name, '、') as areaNameList
        from tba
        where satisfaction_score = 0
        union all
        select
            '移动用户故障处理(十分好评率)' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where move_barrier_favorable_score = 0
        union all
        select
            '“三超”故障(批量退服)' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where fault_out_serve_times_score = 0
        union all
        select
            '“三超”故障(频繁断站)' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where fault_often_break_score = 0
        union all
        select
            '“三超”故障(超长断站率)' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where over_length_score = 0
        union all
        select
            '重点场景SINR质差比例' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where key_scene_quality_score = 0
        union all
        select
            '工单闭环率(维护)' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where new_close_score = 0
        union all
        select
            '工单闭环率(普通、最严)' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where close_score = 0
        union all
        select
            '45G弱覆盖且劣于竞对物业点占比' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where weak_cover_score = 0
        union all
        select
            '低效益站址压降(2025)' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where new_poor_benefit_score = 0
        union all
        select
            '移动用户故障处理(响应、处理、重复申告)' as indicatorName,
            count (*) as num,
            string_agg(area_name, '、') as areaNameList
        from tba
        where barrier_score = 0
        )
        select rank() over(order by num desc) as sort, num,
        indicatorName,
        areaNameList
        from (
        select indicatorName,
        num,
        areaNameList
        from result
        order by num desc limit 3) a
    </select>
    <select id="getAreaIndicatorDetailInfoNew"
            resultType="com.wxwy.intelligentOptimization.moudle.vo.despoilStar.AreaIndicatorDetailVO">
        with tba as (select area_name,
        array_agg(month order by month )                                                        as "month",
        array_agg(concat(round(four_quality_difference_rate * 100, 2)::varchar, '%') order by month)                        as four_quality_difference_rate,
        array_agg(concat(round(five_quality_difference_rate * 100, 2)::varchar, '%') order by month)                        as five_quality_difference_rate,
        array_agg(quality_score order by month)                                                 as quality_score,
        array_agg(concat(round(data_full_rate * 100, 2)::varchar, '%') order by month)          as data_full_rate,
        array_agg(concat(round(data_exact_rate * 100, 2)::varchar, '%') order by month)         as data_exact_rate,
        array_agg(data_govern_score order by month)                                             as data_govern_score,
        array_agg(round(cel_avg_duration, 2) order by month)                                    as cel_avg_duration,
        array_agg(cel_avg_duration_score order by month)                                        as cel_avg_duration_score,
        array_agg(concat(round(four_high_load_rate * 100, 2)::varchar, '%') order by month)     as four_high_load_rate,
        array_agg(concat(round(five_high_load_rate * 100, 2)::varchar, '%') order by month)     as five_high_load_rate,
        array_agg(high_load_score order by month)                                               as high_load_score,
        array_agg(concat(round(deal_complaint_rate * 100, 2)::varchar, '%') order by month)     as deal_complaint_rate,
        array_agg(complaint_score order by month)                                               as complaint_score,
        array_agg(round(quarter_lead, 2) order by month)                                        as quarter_lead,
        array_agg(satisfaction_score order by month)                                            as satisfaction_score,
        array_agg(concat(round(move_barrier_favorable_rate * 100, 2)::varchar, '%') order by month)            as move_barrier_favorable_rate,
        array_agg(move_barrier_favorable_score order by month)                                                 as move_barrier_favorable_score,
        array_agg(fault_out_serve_times_month order by month)                                                as fault_out_serve_times_month,
        array_agg(fault_out_serve_times_quarter order by month)                                             as fault_out_serve_times_quarter,
        array_agg(fault_out_serve_times_score order by month)                                       as fault_out_serve_times_score,
        array_agg(concat(round(fault_often_break_rate * 100, 2)::varchar, '%') order by month)            as fault_often_break_rate,
        array_agg(fault_often_break_score order by month)                                                 as fault_often_break_score,
        array_agg(concat(round(over_length_rate * 100, 2)::varchar, '%') order by month)        as over_length_rate,
        array_agg(over_length_score order by month)                                             as over_length_score,
        array_agg(concat(round(four_key_scene_quality_rate * 100, 2)::varchar, '%') order by month)            as four_key_scene_quality_rate,
        array_agg(concat(round(pressure_drop_value * 100 ,2)::varchar,'%')order by month)                        as pressure_drop_value,
        array_agg(key_scene_quality_score order by month)                                             as key_scene_quality_score,
        array_agg(concat(round(new_maintain_order_close_rate * 100, 2)::varchar, '%') order by month)            as new_maintain_order_close_rate,
        array_agg(new_maintain_order_close_score order by month)                                                 as new_maintain_order_close_score,
        array_agg(concat(round(order_close_rate * 100, 2)::varchar, '%') order by month)     as order_close_rate,
        array_agg(concat(round(strict_close_rate * 100, 2)::varchar, '%') order by month)     as strict_close_rate,
        array_agg(close_score order by month)                                          as close_score,
        array_agg(concat(round(four_weak_cover_rate * 100, 2)::varchar, '%') order by month)     as four_weak_cover_rate,
        array_agg(concat(round(five_weak_cover_rate * 100, 2)::varchar, '%') order by month)     as five_weak_cover_rate,
        array_agg(weak_cover_score order by month)                                          as weak_cover_score,
        array_agg(new_poor_benefit_average order by month)                                                as new_poor_benefit_average,
        array_agg(new_poor_benefit_reach order by month)                                             as new_poor_benefit_reach,
        array_agg(new_poor_benefit_score order by month)                                       as new_poor_benefit_score,
        array_agg(concat(round(in_deal_rate * 100, 2)::varchar, '%') order by month)          as in_deal_rate,
        array_agg(concat(round(in_response_rate * 100, 2)::varchar, '%') order by month)         as in_response_rate,
        array_agg(concat(round(repetition_rate * 100, 2)::varchar, '%') order by month)         as repetition_rate,
        array_agg(barrier_score order by month)                                             as barrier_score
        from app_io_star_rank
        where month IN ( #{lastMonth}, #{currentMonth} )
        and area_name = #{areaName}
        group by area_name)
        select '质差小区比例' as indicatorName,
               case when (array_length(four_quality_difference_rate, 1) = 1 and month[1] = ${currentMonth}) then concat(four_quality_difference_rate[1]::varchar, ';', five_quality_difference_rate[1]::varchar) when (array_length(five_quality_difference_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(four_quality_difference_rate[2]::varchar, ';', five_quality_difference_rate[2]::varchar) end currentIndicator,
               case when (array_length(quality_score, 1) = 1 and month[1] = ${currentMonth} ) then quality_score[1]::varchar when (array_length(quality_score, 1) = 1 and month[1] = ${lastMonth} ) then ''  else quality_score[2]::varchar end currentScore,
               case when (array_length(four_quality_difference_rate, 1) = 1 and month[1] = ${currentMonth}) then ''  else concat(four_quality_difference_rate[1], ';', five_quality_difference_rate[1]) end  lastIndicator,
               case when (array_length(quality_score, 1) = 1 and month[1] = ${currentMonth}) then '' else quality_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '数据治理' as indicatorName,
        case when (array_length(data_full_rate, 1) = 1 and month[1] = ${currentMonth}) then concat(data_full_rate[1]::varchar, ';', data_exact_rate[1]::varchar) when (array_length(data_full_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(data_full_rate[2]::varchar, ';', data_exact_rate[2]::varchar) end currentIndicator,
        case when (array_length(data_govern_score, 1) = 1 and month[1] = ${currentMonth} ) then data_govern_score[1]::varchar when (array_length(data_govern_score, 1) = 1 and month[1] = ${lastMonth} ) then ''  else data_govern_score[2]::varchar end currentScore,
        case when (array_length(data_full_rate, 1) = 1 and month[1] = ${currentMonth}) then ''  else concat(data_full_rate[1], ';', data_exact_rate[1]) end  lastIndicator,
        case when (array_length(data_govern_score, 1) = 1 and month[1] = ${currentMonth}) then '' else data_govern_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '4/5G基站AB类小区平均退服时长' as indicatorName,
            case when (array_length(cel_avg_duration, 1) = 1      and month[1] = ${currentMonth} ) then cel_avg_duration[1]::varchar when (array_length(cel_avg_duration, 1) = 1 and month[1] = ${lastMonth} ) then '' else cel_avg_duration[2]::varchar end currentIndicator,
            case when (array_length(cel_avg_duration_score,1) = 1 and month[1] = ${currentMonth} ) then cel_avg_duration_score[1]::varchar when (array_length(cel_avg_duration_score,1) = 1 and month[1] = ${lastMonth} ) then '' else cel_avg_duration_score[2]::varchar end currentScore,
            case when (array_length(cel_avg_duration,1) = 1       and month[1] = ${currentMonth} ) then '' else cel_avg_duration[1]::varchar end lastIndicator,
            case when (array_length(cel_avg_duration_score,1) = 1 and month[1] = ${currentMonth} ) then '' else cel_avg_duration_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '高负荷小区比例' as indicatorName,
               case when (array_length(four_high_load_rate, 1) = 1 and month[1] = ${currentMonth}) then concat(four_high_load_rate[1]::varchar, ';', five_high_load_rate[1]::varchar) when (array_length(four_high_load_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(four_high_load_rate[2]::varchar, ';', five_high_load_rate[2]::varchar) end currentIndicator,
               case when (array_length(high_load_score, 1) = 1 and month[1] = ${currentMonth} ) then high_load_score[1]::varchar when (array_length(high_load_score, 1) = 1 and month[1] = ${lastMonth} ) then ''  else high_load_score[2]::varchar end currentScore,
               case when (array_length(four_high_load_rate, 1) = 1 and month[1] = ${currentMonth}) then ''  else concat(four_high_load_rate[1], ';', five_high_load_rate[1]) end  lastIndicator,
               case when (array_length(high_load_score, 1) = 1 and month[1] = ${currentMonth}) then '' else high_load_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all

        select 'TOP栅格投诉处理' as indicatorName,
               case when (array_length(deal_complaint_rate, 1) = 1      and month[1] = ${currentMonth} ) then deal_complaint_rate[1]::varchar when (array_length(deal_complaint_rate, 1) = 1 and month[1] = ${lastMonth} ) then '' else deal_complaint_rate[2]::varchar end currentIndicator,
            case when (array_length(complaint_score,1) = 1 and month[1] = ${currentMonth} ) then complaint_score[1]::varchar when (array_length(complaint_score,1) = 1 and month[1] = ${lastMonth} ) then '' else complaint_score[2]::varchar end currentScore,
            case when (array_length(deal_complaint_rate,1) = 1       and month[1] = ${currentMonth} ) then '' else deal_complaint_rate[1]::varchar end lastIndicator,
            case when (array_length(complaint_score,1) = 1 and month[1] = ${currentMonth} ) then '' else complaint_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '满意度测评' as indicatorName,
               case when (array_length(quarter_lead, 1) = 1 and month[1] = ${currentMonth}) then quarter_lead[1]::varchar when (array_length(quarter_lead, 1) = 1 and month[1] = ${lastMonth}) then '' else quarter_lead[2]::varchar end currentIndicator,
            case when (array_length(satisfaction_score,1) = 1 and month[1] = ${currentMonth}) then satisfaction_score[1]::varchar when (array_length(satisfaction_score, 1) = 1 and month[1] = ${lastMonth}) then '' else satisfaction_score[2]::varchar end currentScore,
	        case when (array_length(quarter_lead,1) = 1 and month[1] = ${currentMonth}) then '' else quarter_lead[1]::varchar end lastIndicator,
	        case when (array_length(satisfaction_score,1) = 1 and month[1] = ${currentMonth}) then '' else satisfaction_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '移动用户故障处理(十分好评率)' as indicatorName,
               case when (array_length(move_barrier_favorable_rate, 1) = 1 and month[1] = ${currentMonth}) then move_barrier_favorable_rate[1]::varchar when (array_length(move_barrier_favorable_rate, 1) = 1 and month[1] = ${lastMonth}) then ''  else move_barrier_favorable_rate[2]::varchar end currentIndicator,
            case when (array_length(move_barrier_favorable_score,1) = 1            and month[1] = ${currentMonth}) then move_barrier_favorable_score[1]::varchar when (array_length(move_barrier_favorable_score,1) = 1  and month[1] = ${lastMonth}) then '' else move_barrier_favorable_score[2]::varchar end currentScore,
        case when (array_length(move_barrier_favorable_rate,1) = 1  and month[1] = ${currentMonth}) then '' else move_barrier_favorable_rate[1]::varchar end lastIndicator,
        case when (array_length(move_barrier_favorable_score,1) = 1            and month[1] = ${currentMonth}) then '' else move_barrier_favorable_score[1]::varchar end lastIndicator,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all

        select '“三超”故障(批量退服)' as indicatorName,
               case when (array_length(fault_out_serve_times_month, 1) = 1 and month[1] = ${currentMonth}) then concat(fault_out_serve_times_month[1]::varchar, ';', fault_out_serve_times_quarter[1]::varchar) when (array_length(fault_out_serve_times_month, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(fault_out_serve_times_month[2]::varchar, ';', fault_out_serve_times_quarter[2]::varchar) end currentIndicator,
               case when (array_length(fault_out_serve_times_score, 1) = 1 and month[1] = ${currentMonth} ) then fault_out_serve_times_score[1]::varchar when (array_length(fault_out_serve_times_score, 1) = 1 and month[1] = ${lastMonth} ) then ''  else fault_out_serve_times_score[2]::varchar end currentScore,
            case when (array_length(fault_out_serve_times_month, 1) = 1 and month[1] = ${currentMonth}) then ''  else concat(fault_out_serve_times_month[1], ';', fault_out_serve_times_quarter[1]) end  lastIndicator,
        case when (array_length(fault_out_serve_times_score, 1) = 1 and month[1] = ${currentMonth}) then '' else fault_out_serve_times_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '“三超”故障(频繁断站)' as indicatorName,
        case when (array_length(fault_often_break_rate, 1) = 1      and month[1] = ${currentMonth} ) then fault_often_break_rate[1]::varchar when (array_length(fault_often_break_rate, 1) = 1 and month[1] = ${lastMonth} ) then '' else fault_often_break_rate[2]::varchar end currentIndicator,
        case when (array_length(fault_often_break_score,1) = 1 and month[1] = ${currentMonth} ) then fault_often_break_score[1]::varchar when (array_length(fault_often_break_score,1) = 1 and month[1] = ${lastMonth} ) then '' else fault_often_break_score[2]::varchar end currentScore,
        case when (array_length(fault_often_break_rate,1) = 1       and month[1] = ${currentMonth} ) then '' else fault_often_break_rate[1]::varchar end lastIndicator,
        case when (array_length(fault_often_break_score,1) = 1 and month[1] = ${currentMonth} ) then '' else fault_often_break_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '“三超”故障(超长断站率)' as indicatorName,
               case when (array_length(over_length_rate, 1) = 1      and month[1] = ${currentMonth} ) then over_length_rate[1]::varchar when (array_length(over_length_rate, 1) = 1 and month[1] = ${lastMonth} ) then '' else over_length_rate[2]::varchar end currentIndicator,
            case when (array_length(over_length_score,1) = 1 and month[1] = ${currentMonth} ) then over_length_score[1]::varchar when (array_length(over_length_score,1) = 1 and month[1] = ${lastMonth} ) then '' else over_length_score[2]::varchar end currentScore,
        case when (array_length(over_length_rate,1) = 1       and month[1] = ${currentMonth} ) then '' else over_length_rate[1]::varchar end lastIndicator,
        case when (array_length(over_length_score,1) = 1 and month[1] = ${currentMonth} ) then '' else over_length_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '重点场景SINR质差比例' as indicatorName,
               case when (array_length(four_key_scene_quality_rate, 1) = 1 and month[1] = ${currentMonth}) then concat(four_key_scene_quality_rate[1]::varchar, ';', pressure_drop_value[1]::varchar) when (array_length(four_key_scene_quality_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(four_key_scene_quality_rate[2]::varchar, ';', pressure_drop_value[2]::varchar) end currentIndicator,
               case when (array_length(key_scene_quality_score, 1) = 1 and month[1] = ${currentMonth} ) then key_scene_quality_score[1]::varchar when (array_length(key_scene_quality_score, 1) = 1 and month[1] = ${lastMonth} ) then ''  else key_scene_quality_score[2]::varchar end currentScore,
            case when (array_length(four_key_scene_quality_rate, 1) = 1 and month[1] = ${currentMonth}) then ''  else concat(four_key_scene_quality_rate[1], ';', pressure_drop_value[1]) end  lastIndicator,
        case when (array_length(key_scene_quality_score, 1) = 1 and month[1] = ${currentMonth}) then '' else key_scene_quality_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all

        select '工单闭环率(维护)' as indicatorName,
               case when (array_length(new_maintain_order_close_rate, 1) = 1      and month[1] = ${currentMonth} ) then new_maintain_order_close_rate[1]::varchar when (array_length(new_maintain_order_close_rate, 1) = 1 and month[1] = ${lastMonth} ) then '' else new_maintain_order_close_rate[2]::varchar end currentIndicator,
            case when (array_length(new_maintain_order_close_score,1) = 1 and month[1] = ${currentMonth} ) then new_maintain_order_close_score[1]::varchar when (array_length(new_maintain_order_close_score,1) = 1 and month[1] = ${lastMonth} ) then '' else new_maintain_order_close_score[2]::varchar end currentScore,
        case when (array_length(new_maintain_order_close_rate,1) = 1       and month[1] = ${currentMonth} ) then '' else new_maintain_order_close_rate[1]::varchar end lastIndicator,
        case when (array_length(new_maintain_order_close_score,1) = 1 and month[1] = ${currentMonth} ) then '' else new_maintain_order_close_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba

        union all
        select '工单闭环率(普通、最严)' as    indicatorName,
               case when (array_length(order_close_rate, 1) = 1          and month[1] = ${currentMonth}) then concat(order_close_rate[1]::varchar, ';', strict_close_rate[1]::varchar) when (array_length(order_close_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(order_close_rate[2]::varchar, ';', strict_close_rate[2]::varchar) end currentIndicator,
               case when (array_length(close_score, 1) = 1 and month[1] = ${currentMonth}) then close_score[1]::varchar when (array_length(close_score, 1) = 1 and month[1] = ${lastMonth}) then '' else close_score[2]::varchar end currentScore,
            case when (array_length(order_close_rate, 1) = 1          and month[1] = ${currentMonth}) then '' else concat(order_close_rate[1], ';', strict_close_rate[1]) end lastIndicator,
        case when (array_length(close_score, 1) = 1 and month[1] = ${currentMonth}) then '' else close_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '45G弱覆盖且劣于竞对物业点占比' as    indicatorName,
               case when (array_length(four_weak_cover_rate, 1) = 1          and month[1] = ${currentMonth}) then concat(four_weak_cover_rate[1]::varchar, ';', five_weak_cover_rate[1]::varchar) when (array_length(four_weak_cover_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(four_weak_cover_rate[2]::varchar, ';', five_weak_cover_rate[2]::varchar) end currentIndicator,
               case when (array_length(weak_cover_score, 1) = 1 and month[1] = ${currentMonth}) then weak_cover_score[1]::varchar when (array_length(weak_cover_score, 1) = 1 and month[1] = ${lastMonth}) then '' else weak_cover_score[2]::varchar end currentScore,
            case when (array_length(four_weak_cover_rate, 1) = 1          and month[1] = ${currentMonth}) then '' else concat(four_weak_cover_rate[1], ';', five_weak_cover_rate[1]) end lastIndicator,
        case when (array_length(weak_cover_score, 1) = 1 and month[1] = ${currentMonth}) then '' else weak_cover_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '低效益站址压降(2025)' as    indicatorName,
               case when (array_length(new_poor_benefit_average, 1) = 1          and month[1] = ${currentMonth}) then concat(new_poor_benefit_average[1]::varchar, ';', new_poor_benefit_reach[1]::varchar) when (array_length(new_poor_benefit_average, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(new_poor_benefit_average[2]::varchar, ';', new_poor_benefit_reach[2]::varchar) end currentIndicator,
               case when (array_length(new_poor_benefit_score, 1) = 1 and month[1] = ${currentMonth}) then new_poor_benefit_score[1]::varchar when (array_length(new_poor_benefit_score, 1) = 1 and month[1] = ${lastMonth}) then '' else new_poor_benefit_score[2]::varchar end currentScore,
            case when (array_length(new_poor_benefit_average, 1) = 1          and month[1] = ${currentMonth}) then '' else concat(new_poor_benefit_average[1], ';', new_poor_benefit_reach[1]) end lastIndicator,
        case when (array_length(new_poor_benefit_score, 1) = 1 and month[1] = ${currentMonth}) then '' else new_poor_benefit_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '移动用户故障处理(响应、处理、重复申告)' as    indicatorName,
            case when (array_length(in_deal_rate, 1) = 1  and month[1] = ${currentMonth}) then concat(in_deal_rate[1]::varchar, ';', in_response_rate[1]::varchar, ';' ,repetition_rate[1]::varchar) when (array_length(in_deal_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(in_deal_rate[2]::varchar, ';', in_response_rate[2]::varchar,';',repetition_rate[2]::varchar) end currentIndicator,
            case when (array_length(barrier_score, 1) = 1 and month[1] = ${currentMonth}) then barrier_score[1]::varchar when (array_length(barrier_score, 1) = 1 and month[1] = ${lastMonth}) then '' else barrier_score[2]::varchar end currentScore,
            case when (array_length(in_deal_rate, 1) = 1  and month[1] = ${currentMonth}) then '' else concat(in_deal_rate[1], ';', in_response_rate[1] , ';', repetition_rate[1]) end lastIndicator,
            case when (array_length(barrier_score, 1) = 1 and month[1] = ${currentMonth}) then '' else barrier_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
    </select>
    <select id="downLoadDetailThreeInfo"
            resultType="com.wxwy.intelligentOptimization.moudle.vo.despoilStar.AppIoStarRankTwoVO">
        select
            area,
            builder,
            area_name as areaName,
            quarter_lead as  quarterLead,
            local_rank as  localRank,
            satisfaction_score as  satisfactionScore,
            in_response_rate as  inResponseRate,
            in_deal_rate as  inDealRate,
            repetition_rate as  repetitionRate,
            move_barrier_favorable_rate as  moveBarrierFavorableRate,
            in_response_score as  inResponseScore,
            in_deal_score as  inDealScore,
            repetition_score as  repetitionScore,
            move_barrier_favorable_score as  moveBarrierFavorableScore,
            barrier_score as  barrierScore,
            deal_complaint_rate as  dealComplaintRate,
            complaint_score as  complaintScore,
            four_high_load_rate as  fourHighLoadRate,
            five_high_load_rate as  fiveHighLoadRate,
            high_load_rate_score as  highLoadRateScore,
            two_single_score as  twoSingleScore,
            high_load_score as  highLoadScore,
            four_quality_difference_rate as  fourQualityDifferenceRate,
            five_quality_difference_rate as  fiveQualityDifferenceRate,
            four_quality_difference_score as  fourQualityDifferenceScore,
            five_quality_difference_score as  fiveQualityDifferenceScore,
            quality_score as  qualityScore,
            four_weak_cover_rate as  fourWeakCoverRate,
            five_weak_cover_rate as  fiveWeakCoverRate,
            weak_cover_score as  weakCoverScore,
            four_key_scene_quality_rate as  fourKeySceneQualityRate,
            pressure_drop_value as  pressureDropValue,
            key_scene_quality_score as  keySceneQualityDifferenceScore,
            order_close_rate as  orderCloseRate,
            strict_close_rate as  strictCloseRate,
            new_maintain_order_close_rate as  newMaintainOrderCloseRate,
            order_close_score as  orderCloseScore,
            strict_close_score as  strictCloseScore,
            new_maintain_order_close_score as  newMaintainOrderCloseScore,
            new_close_score as  newCloseScore,
            cel_avg_duration as  celAvgDuration,
            cel_avg_duration_score as  celAvgDurationScore,
            fault_out_serve_times_month as  faultOutServeTimesMonth,
            fault_out_serve_times_quarter as  faultOutServeTimesQuarter,
            fault_out_serve_times_score as  faultOutServeTimesScore,
            over_length_rate as  overLengthRate,
            over_length_score as  overLengthScore,
            fault_often_break_rate as  faultOftenBreakRate,
            fault_often_break_score as  faultOftenBreakScore,
            three_fault_score as  threeFaultScore,
            new_poor_benefit_average as  newPoorBenefitAverage,
            new_poor_benefit_reach as  newPoorBenefitReach,
            new_poor_benefit_score as  newPoorBenefitScore,
            data_full_rate as  dataFullRate,
            data_exact_rate as  dataExactRate,
            data_full_score as  dataFullScore,
            data_exact_score as  dataExactScore,
            data_govern_score as  dataGovernScore,
            four_deduction_of_points as  fourDeductionOfPoints,
            five_deduction_of_points as  fiveDeductionOfPoints,
            score,
            star,
            rank,
            color_card as colorCard,
            month
        from app_io_star_rank
        <where>
            month = #{month}
            <if test="areaName != null and areaName !=''">
                and area_name = #{areaName}
            </if>
        </where>

    </select>
    <select id="getProblemIndicatorWordsNew" resultType="java.lang.String">
        with tba as (
        SELECT *
        FROM "app_io_star_rank"
        where
        month = #{month} and area_name = #{areaName}
        )
        , tbb as (
        SELECT
        case when satisfaction_score &lt; 10 then '满意度测评' else '' end indicatorName,
        satisfaction_score/10 as rate
        FROM tba
        union all
        SELECT
        case when barrier_score &lt; 10 then '移动障碍工单处理质量' else '' end indicatorName,
        barrier_score/10 as rate
        FROM tba
        union all
        SELECT
        case when complaint_score &lt;5 then 'TOP栅格投诉处置率' else '' end indicatorName,
        complaint_score/5 as rate
        FROM tba
        union all
        SELECT
            case when high_load_score &lt;10 then '4/5G高负荷小区比例' else '' end indicatorName,
            high_load_score/10 as rate
        FROM tba
        union all
        SELECT
            case when quality_score &lt;10 then '4/5G质差小区比例' else '' end indicatorName,
            quality_score/10 as rate
        FROM tba
        union all
        SELECT
            case when weak_cover_score &lt;10 then '4/5G弱覆盖且劣于竞对场景点占比' else '' end indicatorName,
            weak_cover_score/10 as rate
        FROM tba
        union all
        SELECT
            case when key_scene_quality_score &lt;10 then '重点场景SINR质差楼宇比例' else '' end indicatorName,
            key_scene_quality_score/10 as rate
        FROM tba
        union all
        SELECT
            case when new_close_score &lt;10 then '工单闭环率' else '' end indicatorName,
            new_close_score/10 as rate
        FROM tba
        union all
        SELECT
            case when cel_avg_duration_score &lt;5 then '4/5G基站AB类小区平均退服时长' else '' end indicatorName,
            cel_avg_duration_score/5 as rate
        FROM tba
        union all
        SELECT
            case when three_fault_score &lt;10 then '“三超”故障' else '' end indicatorName,
            three_fault_score/10 as rate
        FROM tba
        union all
        SELECT
            case when new_poor_benefit_score &lt;10 then '低效益站址压降' else '' end indicatorName,
            new_poor_benefit_score/10 as rate
        FROM tba
        union all
        SELECT
            case when data_govern_score &lt;10 then '基础数据' else '' end indicatorName,
            data_govern_score/10 as rate
        FROM tba
        )
        select indicatorName
        from tbb
        where indicatorName !=''
        order by rate
    </select>
    <select id="getAreaTendencyChartNew"
            resultType="com.wxwy.intelligentOptimization.moudle.vo.despoilStar.AreaIndicatorTendencyTempVO">
        with tba as (
            select
                area,
                area_name,
                voice_quality,
                internet_quality,
                network_quality_dx,
                network_quality_yd,
                network_quality_lt,
                quarter_lead,
                local_rank,
                satisfaction_score,
                satisfaction_quarter,
                satisfaction_month,
                in_deal_rate,
                repetition_rate,
                in_deal_score,
                repetition_score,
                barrier_score,
                barrier_month,
                deal_complaint_rate,
                complaint_score,
                complaint_month,
                friendly_cover_rate,
                friendly_cover_score,
                bad_cover_rate,
                bad_cover_score,
                cover_month,
                four_high_load_rate,
                five_high_load_rate,
                high_load_rate,
                two_single_rate,
                high_load_rate_score,
                two_single_score,
                high_load_score,
                high_load_month,
                four_zero_flow_rate,
                five_zero_flow_rate,
                zero_flow_rate,
                four_zero_flow_score,
                five_zero_flow_score,
                zero_flow_score,
                zero_score,
                zero_flow_month,
                four_quality_difference_rate,
                five_quality_difference_rate,
                quality_difference_rate,
                four_quality_difference_score,
                five_quality_difference_score,
                quality_difference_score,
                quality_score,
                quality_month,
                cel_avg_duration,
                cel_avg_duration_score,
                maintain_month,
                over_length_rate,
                over_length_score,
                over_length_month,
                data_full_rate,
                data_exact_rate,
                data_full_score,
                data_exact_score,
                data_govern_score,
                data_govern_month,
                test_kilometre,
                test_analyse_score,
                base_optimize_num,
                base_optimize_score,
                data_test_analyse_score,
                data_test_analyse_month,
                order_close_rate,
                strict_close_rate,
                order_close_score,
                strict_close_score,
                close_score,
                order_close_month,
                appraisal_list_deduction,
                appraisal_deduction_of_points,
                appraisal_month,
                out_serve_times_month,
                out_serve_month,
                out_serve_times_quarter,
                out_serve_quarter,
                out_serve_deduction_of_points,
                often_break_rate,
                often_break_deduction_of_points,
                often_break_month,
                score,
                star,
                rank,
                color_card,
                month,
                gmt_create,
                new_long_break_rate,
                new_long_break_score,
                new_often_break_rate,
                new_often_break_score,
                base_break_score,
                base_break_month,
                new_order_close_rate,
                new_strict_order_close_rate,
                new_maintain_order_close_rate,
                new_order_close_score,
                new_strict_order_close_score,
                new_maintain_order_close_score,
                new_close_score,
                new_order_close_month,
                pressure_drop_rate,
                pressure_drop_deduction_of_points,
                pressure_drop_month,
                repetition_order_rate,
                repetition_order_deduction_of_points,
                repetition_order_month,
                poor_benefit_rate,
                poor_benefit_deduction_of_points,
                poor_benefit_month,
                builder,
                move_barrier_favorable_rate,
                move_barrier_favorable_score,
                move_barrier_favorable_month,
                fault_out_serve_times_month,
                fault_out_serve_times_quarter,
                fault_out_serve_times_score,
                fault_out_serve_month,
                fault_often_break_rate,
                fault_often_break_score,
                fault_often_break_month,
                four_key_scene_quality_rate,
                pressure_drop_value,
                four_key_scene_quality_score,
                pressure_drop_value_score,
                key_scene_quality_score,
                key_scene_quality_month,
                four_weak_cover_rate,
                five_weak_cover_rate,
                four_weak_cover_score,
                five_weak_cover_score,
                weak_cover_score,
                weak_cover_month,
                four_instability_rate,
                four_deduction_of_points,
                five_instability_rate,
                five_deduction_of_points,
                feedback_system_instability_month,
                new_poor_benefit_average,
                new_poor_benefit_reach,
                new_poor_benefit_score,
                new_poor_benefit_month,
                in_response_rate,
                in_response_score
            from app_io_star_rank
            where month &lt;= #{month} and area_name = #{areaName}
        order by month limit 12
        )
        ,
        tbb as (
        SELECT
        '满意度测评' as indicatorName,
        json_agg(
        json_build_object(
        'score', satisfaction_score,
        'month', month
        ))
        as tendency
        from tba
        union all
        SELECT
        '移动障碍工单处理质量' as indicatorName
        , json_agg(
        json_build_object(
        'score', barrier_score,
        'month', month
        )
        ) as tendency
        from tba
        union all
        SELECT
        'TOP栅格投诉处置率' as indicatorName
        , json_agg(
        json_build_object(
        'score', complaint_score,
        'month', month
        )
        ) as tendency
        from tba
        union all
        SELECT
        '4/5G高负荷小区比例' as indicatorName
        , json_agg(
        json_build_object(
        'score', high_load_score,
        'month', month
        )
        ) as tendency
        from tba
        union all
        SELECT
        '4/5G质差小区比例' as indicatorName
        , json_agg(
        json_build_object(
        'score', quality_score,
        'month', month
        )
        ) as tendency
        from tba
        union all
        SELECT
        '4/5G弱覆盖且劣于竞对场景点占比' as indicatorName
        , json_agg(
        json_build_object(
        'score', weak_cover_score,
        'month', month
        )
        ) as tendency
        from tba
        union all
        SELECT
        '重点场景SINR质差楼宇比例' as indicatorName
        , json_agg(
        json_build_object(
        'score', key_scene_quality_score,
        'month', month
        )
        ) as tendency
        from tba
        union all
        SELECT
        '工单闭环率' as indicatorName
        , json_agg(
        json_build_object(
        'score', new_close_score,
        'month', month
        )
        ) as tendency
        from tba
        union all
        SELECT
        '4/5G基站AB类小区平均退服时长' as indicatorName
        , json_agg(
        json_build_object(
        'score', cel_avg_duration_score,
        'month', month
        )
        ) as tendency
        from tba
        union all
        SELECT
        '“三超”故障(批量退服)' as indicatorName
        , json_agg(
        json_build_object(
        'score', fault_out_serve_times_score,
        'month', month
        )
        ) as tendency
        from tba
        union all
        SELECT
        '“三超”故障(超长断站率)' as indicatorName
        , json_agg(
        json_build_object(
        'score', over_length_score,
        'month', month
        )
        ) as tendency
        from tba
        union all
        SELECT
            '“三超”故障(频繁断站率)' as indicatorName
            , json_agg(
            json_build_object(
            'score', fault_often_break_score,
            'month', month
            )
            ) as tendency
        from tba
        union all
        SELECT
        '低效益站址压降' as indicatorName
        , json_agg(
        json_build_object(
        'score', new_poor_benefit_score,
        'month', month
        )
        ) as tendency
        from tba
        union all
        SELECT
        '基础数据治理' as indicatorName
        , json_agg(
        json_build_object(
        'score', data_govern_score,
        'month', month
        )
        ) as tendency
        from tba
        )
        ,
        tbc as (
        SELECT
        area,
        area_name,
        satisfaction_score,
        RANK() OVER (partition by area, month ORDER BY satisfaction_score DESC) AS satisfaction_rank,
        barrier_score,
        RANK() OVER (partition by area, month ORDER BY barrier_score DESC) AS barrier_rank,
        complaint_score,
        RANK() OVER (partition by area, month ORDER BY complaint_score DESC) AS complaint_rank,
        high_load_score,
        RANK() OVER (partition by area, month ORDER BY high_load_score DESC) AS high_load_rank,
        quality_score,
        RANK() OVER (partition by area, month ORDER BY quality_score DESC) AS quality_rank,
        weak_cover_score,
        RANK() OVER (partition by area, month ORDER BY weak_cover_score DESC) AS weak_cover_rank,
        key_scene_quality_score,
        RANK() OVER (partition by area, month ORDER BY key_scene_quality_score DESC) AS key_scene_quality_rank,
        new_close_score,
        RANK() OVER (partition by area, month ORDER BY new_close_score DESC) AS new_close_rank,
        cel_avg_duration_score,
        RANK() OVER (partition by area, month ORDER BY cel_avg_duration_score DESC) AS cel_avg_duration_rank,
        fault_out_serve_times_score,
        RANK() OVER (partition by area, month ORDER BY fault_out_serve_times_score DESC) AS fault_out_serve_times_rank,
        over_length_score,
        RANK() OVER (partition by area, month ORDER BY over_length_score DESC) AS over_length_rank,
        fault_often_break_score,
        RANK() OVER (partition by area, month ORDER BY fault_often_break_score DESC) AS fault_often_break_score_rank,
        new_poor_benefit_score,
        RANK() OVER (partition by area, month ORDER BY new_poor_benefit_score DESC) AS new_poor_benefit_rank,
        data_govern_score,
        RANK() OVER (partition by area, month ORDER BY data_govern_score DESC) AS data_govern_rank,
        month
        FROM
        (select
            area,
            area_name,
            voice_quality,
            internet_quality,
            network_quality_dx,
            network_quality_yd,
            network_quality_lt,
            quarter_lead,
            local_rank,
            satisfaction_score,
            satisfaction_quarter,
            satisfaction_month,
            in_deal_rate,
            repetition_rate,
            in_deal_score,
            repetition_score,
            barrier_score,
            barrier_month,
            deal_complaint_rate,
            complaint_score,
            complaint_month,
            friendly_cover_rate,
            friendly_cover_score,
            bad_cover_rate,
            bad_cover_score,
            cover_month,
            four_high_load_rate,
            five_high_load_rate,
            high_load_rate,
            two_single_rate,
            high_load_rate_score,
            two_single_score,
            high_load_score,
            high_load_month,
            four_zero_flow_rate,
            five_zero_flow_rate,
            zero_flow_rate,
            four_zero_flow_score,
            five_zero_flow_score,
            zero_flow_score,
            zero_score,
            zero_flow_month,
            four_quality_difference_rate,
            five_quality_difference_rate,
            quality_difference_rate,
            four_quality_difference_score,
            five_quality_difference_score,
            quality_difference_score,
            quality_score,
            quality_month,
            cel_avg_duration,
            cel_avg_duration_score,
            maintain_month,
            over_length_rate,
            over_length_score,
            over_length_month,
            data_full_rate,
            data_exact_rate,
            data_full_score,
            data_exact_score,
            data_govern_score,
            data_govern_month,
            test_kilometre,
            test_analyse_score,
            base_optimize_num,
            base_optimize_score,
            data_test_analyse_score,
            data_test_analyse_month,
            order_close_rate,
            strict_close_rate,
            order_close_score,
            strict_close_score,
            close_score,
            order_close_month,
            appraisal_list_deduction,
            appraisal_deduction_of_points,
            appraisal_month,
            out_serve_times_month,
            out_serve_month,
            out_serve_times_quarter,
            out_serve_quarter,
            out_serve_deduction_of_points,
            often_break_rate,
            often_break_deduction_of_points,
            often_break_month,
            score,
            star,
            rank,
            color_card,
            month,
            gmt_create,
            new_long_break_rate,
            new_long_break_score,
            new_often_break_rate,
            new_often_break_score,
            base_break_score,
            base_break_month,
            new_order_close_rate,
            new_strict_order_close_rate,
            new_maintain_order_close_rate,
            new_order_close_score,
            new_strict_order_close_score,
            new_maintain_order_close_score,
            new_close_score,
            new_order_close_month,
            pressure_drop_rate,
            pressure_drop_deduction_of_points,
            pressure_drop_month,
            repetition_order_rate,
            repetition_order_deduction_of_points,
            repetition_order_month,
            poor_benefit_rate,
            poor_benefit_deduction_of_points,
            poor_benefit_month,
            builder,
            move_barrier_favorable_rate,
            move_barrier_favorable_score,
            move_barrier_favorable_month,
            fault_out_serve_times_month,
            fault_out_serve_times_quarter,
            fault_out_serve_times_score,
            fault_out_serve_month,
            fault_often_break_rate,
            fault_often_break_score,
            fault_often_break_month,
            four_key_scene_quality_rate,
            pressure_drop_value,
            four_key_scene_quality_score,
            pressure_drop_value_score,
            key_scene_quality_score,
            key_scene_quality_month,
            four_weak_cover_rate,
            five_weak_cover_rate,
            four_weak_cover_score,
            five_weak_cover_score,
            weak_cover_score,
            weak_cover_month,
            four_instability_rate,
            four_deduction_of_points,
            five_instability_rate,
            five_deduction_of_points,
            feedback_system_instability_month,
            new_poor_benefit_average,
            new_poor_benefit_reach,
            new_poor_benefit_score,
            new_poor_benefit_month,
            in_response_rate,
            in_response_score
        from app_io_star_rank) tb
        WHERE
        MONTH in ( #{lastMonth}
        , #{month})
        )
        , tbd as (
        select
        area_name,
        array_agg(satisfaction_score order by month ) as satisfaction_score,
        array_agg(satisfaction_rank order by month ) as satisfaction_rank,
        array_agg(barrier_score order by month ) as barrier_score,
        array_agg(barrier_rank order by month ) as barrier_rank,
        array_agg(complaint_score order by month ) as complaint_score,
        array_agg(complaint_rank order by month ) as complaint_rank,
        array_agg(high_load_score order by month ) as high_load_score,
        array_agg(high_load_rank order by month ) as high_load_rank,
        array_agg(quality_score order by month ) as quality_score,
        array_agg(quality_rank order by month ) as quality_rank,
        array_agg(weak_cover_score order by month ) as weak_cover_score,
        array_agg(weak_cover_rank order by month ) as weak_cover_rank,
        array_agg(key_scene_quality_score order by month ) as key_scene_quality_score,
        array_agg(key_scene_quality_rank order by month ) as key_scene_quality_rank,
        array_agg(new_close_score order by month ) as new_close_score,
        array_agg(new_close_rank order by month ) as new_close_rank,
        array_agg(cel_avg_duration_score order by month ) as cel_avg_duration_score,
        array_agg(cel_avg_duration_rank order by month ) as cel_avg_duration_rank,
        array_agg(fault_out_serve_times_score order by month ) as fault_out_serve_times_score,
        array_agg(fault_out_serve_times_rank order by month ) as fault_out_serve_times_rank,
        array_agg(over_length_score order by month ) as over_length_score,
        array_agg(over_length_rank order by month ) as over_length_rank,
        array_agg(fault_often_break_score order by month ) as fault_often_break_score,
        array_agg(fault_often_break_score_rank order by month ) as fault_often_break_score_rank,
        array_agg(new_poor_benefit_score order by month ) as new_poor_benefit_score,
        array_agg(new_poor_benefit_rank order by month ) as new_poor_benefit_rank,
        array_agg(data_govern_score order by month ) as data_govern_score,
        array_agg(data_govern_rank order by month ) as data_govern_rank,
        array_agg(month order by month ) as month
        from tbc
        where area_name = #{areaName}
        group by area_name
        )
        ,
        tbe as (
        select
        '满意度测评' as indicatorName,
        case when array_length(satisfaction_score, 1) = 1 then 0 else satisfaction_score[1] end lastMonthScore,
        case when array_length(satisfaction_rank, 1) = 1 then satisfaction_rank[1] else satisfaction_rank[2] end currentMonthRank,
        case when array_length(satisfaction_rank, 1) = 1 then null when (satisfaction_rank[2]-satisfaction_rank[1]) &gt;0 then false when (satisfaction_rank[2]-satisfaction_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
        '移动障碍工单处理质量' as indicatorName,
        case when array_length(barrier_score, 1) = 1 then 0 else barrier_score[1] end lastMonthScore,
        case when array_length(barrier_rank, 1) = 1 then barrier_rank[1] else barrier_rank[2] end currentMonthRank,
        case when array_length(barrier_rank, 1) = 1 then null when (barrier_rank[2]-barrier_rank[1]) &gt;0 then false when (barrier_rank[2]-barrier_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
        'TOP栅格投诉处置率' as indicatorName,
        case when array_length(complaint_score, 1) = 1 then 0 else complaint_score[1] end lastMonthScore,
        case when array_length(complaint_rank, 1) = 1 then complaint_rank[1] else complaint_rank[2] end currentMonthRank,
        case when array_length(complaint_rank, 1) = 1 then null when (complaint_rank[2]-complaint_rank[1]) &gt;0 then false when (complaint_rank[2]-complaint_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
        '4/5G高负荷小区比例' as indicatorName,
        case when array_length(high_load_score, 1) = 1 then 0 else high_load_score[1] end lastMonthScore,
        case when array_length(high_load_rank, 1) = 1 then high_load_rank[1] else high_load_rank[2] end currentMonthRank,
        case when array_length(high_load_rank, 1) = 1 then null when (high_load_rank[2]-high_load_rank[1]) &gt;0 then false when (high_load_rank[2]-high_load_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
        '4/5G质差小区比例' as indicatorName,
        case when array_length(quality_score, 1) = 1 then 0 else quality_score[1] end lastMonthScore,
        case when array_length(quality_rank, 1) = 1 then quality_rank[1] else quality_rank[2] end currentMonthRank,
        case when array_length(quality_rank, 1) = 1 then null when (quality_rank[2]-quality_rank[1]) &gt;0 then false when (quality_rank[2]-quality_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
        '4/5G弱覆盖且劣于竞对场景点占比' as indicatorName,
        case when array_length(weak_cover_score, 1) = 1 then 0 else weak_cover_score[1] end lastMonthScore,
        case when array_length(weak_cover_rank, 1) = 1 then weak_cover_rank[1] else weak_cover_rank[2] end currentMonthRank,
        case when array_length(weak_cover_rank, 1) = 1 then null when (weak_cover_rank[2]-weak_cover_rank[1]) &gt;0 then false when (weak_cover_rank[2]-weak_cover_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
        '重点场景SINR质差楼宇比例' as indicatorName,
        case when array_length(key_scene_quality_score, 1) = 1 then 0 else key_scene_quality_score[1] end lastMonthScore,
        case when array_length(key_scene_quality_rank, 1) = 1 then key_scene_quality_rank[1] else key_scene_quality_rank[2] end currentMonthRank,
        case when array_length(key_scene_quality_rank, 1) = 1 then null when (key_scene_quality_rank[2]-key_scene_quality_rank[1]) &gt;0 then false when (key_scene_quality_rank[2]-key_scene_quality_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
        '工单闭环率' as indicatorName,
        case when array_length(new_close_score, 1) = 1 then 0 else new_close_score[1] end lastMonthScore,
        case when array_length(new_close_rank, 1) = 1 then new_close_rank[1] else new_close_rank[2] end currentMonthRank,
        case when array_length(new_close_rank, 1) = 1 then null when (new_close_rank[2]-new_close_rank[1]) &gt;0 then false when (new_close_rank[2]-new_close_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
        '4/5G基站AB类小区平均退服时长' as indicatorName,
        case when array_length(cel_avg_duration_score, 1) = 1 then 0 else cel_avg_duration_score[1] end lastMonthScore,
        case when array_length(cel_avg_duration_rank, 1) = 1 then cel_avg_duration_rank[1] else cel_avg_duration_rank[2] end currentMonthRank,
        case when array_length(cel_avg_duration_rank, 1) = 1 then null when (cel_avg_duration_rank[2]-cel_avg_duration_rank[1]) &gt;0 then false when (cel_avg_duration_rank[2]-cel_avg_duration_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
        '“三超”故障(批量退服)' as indicatorName,
        case when array_length(fault_out_serve_times_score, 1) = 1 then 0 else fault_out_serve_times_score[1] end lastMonthScore,
        case when array_length(fault_out_serve_times_rank, 1) = 1 then fault_out_serve_times_rank[1] else fault_out_serve_times_rank[2] end currentMonthRank,
        case when array_length(fault_out_serve_times_rank, 1) = 1 then null when (fault_out_serve_times_rank[2]-fault_out_serve_times_rank[1]) &gt;0 then false when (fault_out_serve_times_rank[2]-fault_out_serve_times_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
        '“三超”故障(超长断站率)' as indicatorName,
        case when array_length(over_length_score, 1) = 1 then 0 else over_length_score[1] end lastMonthScore,
        case when array_length(over_length_rank, 1) = 1 then over_length_rank[1] else over_length_rank[2] end currentMonthRank,
        case when array_length(over_length_rank, 1) = 1 then null when (over_length_rank[2]-over_length_rank[1]) &gt;0 then false when (over_length_rank[2]-over_length_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
        '“三超”故障(频繁断站率)' as indicatorName,
        case when array_length(fault_often_break_score, 1) = 1 then 0 else fault_often_break_score[1] end lastMonthScore,
        case when array_length(fault_often_break_score_rank, 1) = 1 then fault_often_break_score_rank[1] else fault_often_break_score_rank[2] end currentMonthRank,
        case when array_length(fault_often_break_score_rank, 1) = 1 then null when (fault_often_break_score_rank[2]-fault_often_break_score_rank[1]) &gt;0 then false when (fault_often_break_score_rank[2]-fault_often_break_score_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
        '低效益站址压降' as indicatorName,
        case when array_length(new_poor_benefit_score, 1) = 1 then 0 else new_poor_benefit_score[1] end lastMonthScore,
        case when array_length(new_poor_benefit_rank, 1) = 1 then new_poor_benefit_rank[1] else new_poor_benefit_rank[2] end currentMonthRank,
        case when array_length(new_poor_benefit_rank, 1) = 1 then null when (new_poor_benefit_rank[2]-new_poor_benefit_rank[1]) &gt;0 then false when (new_poor_benefit_rank[2]-new_poor_benefit_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        union all
        select
        '基础数据治理' as indicatorName,
        case when array_length(data_govern_score, 1) = 1 then 0 else data_govern_score[1] end lastMonthScore,
        case when array_length(data_govern_rank, 1) = 1 then data_govern_rank[1] else data_govern_rank[2] end currentMonthRank,
        case when array_length(data_govern_rank, 1) = 1 then null when (data_govern_rank[2]-data_govern_rank[1])>0 then false when (data_govern_rank[2]-data_govern_rank[1]) &lt;0 then true else null end lastUpOrDown
        from tbd
        )
        select e.indicatorName    as indicatorName,
               e.lastMonthScore   as lastMonthScore,
               e.currentMonthRank as currentMonthRank,
               e.lastUpOrDown     as lastUpOrDown,
               b.tendency         as tendency
        from tbe e
        left join tbb b on e.indicatorName = b.indicatorName
    </select>
    <select id="getAreaIndicatorDetailInfoNewSecond"
            resultType="com.wxwy.intelligentOptimization.moudle.vo.despoilStar.AreaIndicatorDetailVO">
        with tba as (select area_name,
                            array_agg(month order by month )                                                        as "month",
                            array_agg(concat(round(four_quality_difference_rate * 100, 2)::varchar, '%') order by month)                        as four_quality_difference_rate,
                            array_agg(concat(round(five_quality_difference_rate * 100, 2)::varchar, '%') order by month)                        as five_quality_difference_rate,
                            array_agg(round(quality_score,0) order by month)                                                 as quality_score,
                            array_agg(concat(round(data_full_rate * 100, 2)::varchar, '%') order by month)          as data_full_rate,
                            array_agg(concat(round(data_exact_rate * 100, 2)::varchar, '%') order by month)         as data_exact_rate,
                            array_agg(round(data_govern_score,0) order by month)                                             as data_govern_score,
                            array_agg(round(cel_avg_duration, 2) order by month)                                    as cel_avg_duration,
                            array_agg(round(cel_avg_duration_score,0) order by month)                                        as cel_avg_duration_score,
                            array_agg(concat(round(four_high_load_rate * 100, 2)::varchar, '%') order by month)     as four_high_load_rate,
                            array_agg(concat(round(five_high_load_rate * 100, 2)::varchar, '%') order by month)     as five_high_load_rate,
                            array_agg(round(high_load_score,0) order by month)                                               as high_load_score,
                            array_agg(concat(round(deal_complaint_rate * 100, 2)::varchar, '%') order by month)     as deal_complaint_rate,
                            array_agg(round(complaint_score,0) order by month)                                               as complaint_score,
                            array_agg(round(quarter_lead, 2) order by month)                                        as quarter_lead,
                            array_agg(round(satisfaction_score,0) order by month)                                            as satisfaction_score,
                            array_agg(concat(round(move_barrier_favorable_rate * 100, 2)::varchar, '%') order by month)            as move_barrier_favorable_rate,
                            array_agg(round(move_barrier_favorable_score,0) order by month)                                                 as move_barrier_favorable_score,
                            array_agg(fault_out_serve_times_month order by month)                                                as fault_out_serve_times_month,
                            array_agg(fault_out_serve_times_quarter order by month)                                             as fault_out_serve_times_quarter,
                            array_agg(round(fault_out_serve_times_score,0) order by month)                                       as fault_out_serve_times_score,
                            array_agg(concat(round(fault_often_break_rate * 100, 2)::varchar, '%') order by month)            as fault_often_break_rate,
                            array_agg(round(fault_often_break_score,0) order by month)                                                 as fault_often_break_score,
                            array_agg(concat(round(over_length_rate * 100, 2)::varchar, '%') order by month)        as over_length_rate,
                            array_agg(round(over_length_score,0) order by month)                                             as over_length_score,
                            array_agg(concat(round(four_key_scene_quality_rate * 100, 2)::varchar, '%') order by month)            as four_key_scene_quality_rate,
                            array_agg(concat(round(pressure_drop_value * 100 ,2)::varchar,'%')order by month)                        as pressure_drop_value,
                            array_agg(round(key_scene_quality_score,0) order by month)                                             as key_scene_quality_score,
                            array_agg(concat(round(new_maintain_order_close_rate * 100, 2)::varchar, '%') order by month)            as new_maintain_order_close_rate,
                            array_agg(round(new_maintain_order_close_score,0) order by month)                                                 as new_maintain_order_close_score,
                            array_agg(concat(round(order_close_rate * 100, 2)::varchar, '%') order by month)     as order_close_rate,
                            array_agg(concat(round(strict_close_rate * 100, 2)::varchar, '%') order by month)     as strict_close_rate,
                            array_agg(round((order_close_score + strict_close_score),0) order by month)                                          as close_score,
                            array_agg(concat(round(four_weak_cover_rate * 100, 2)::varchar, '%') order by month)     as four_weak_cover_rate,
                            array_agg(concat(round(five_weak_cover_rate * 100, 2)::varchar, '%') order by month)     as five_weak_cover_rate,
                            array_agg(round(weak_cover_score,0) order by month)                                          as weak_cover_score,
                            array_agg(concat(round(new_poor_benefit_average * 100,2),'%') order by month)                                                as new_poor_benefit_average,
                            array_agg(concat(round(new_poor_benefit_reach*100,2 ),'%')order by month)                                             as new_poor_benefit_reach,
                            array_agg(round(new_poor_benefit_score,0) order by month)                                       as new_poor_benefit_score,
                            array_agg(concat(round(in_deal_rate * 100, 2)::varchar, '%') order by month)          as in_deal_rate,
                            array_agg(concat(round(in_response_rate * 100, 2)::varchar, '%') order by month)         as in_response_rate,
                            array_agg(concat(round(repetition_rate * 100, 2)::varchar, '%') order by month)         as repetition_rate,
                            array_agg(round(barrier_score,0) order by month)                                             as barrier_score
                     from app_io_star_rank
                     where month IN ( #{lastMonth}, #{currentMonth} )
            and area_name = #{areaName}
        group by area_name)
        select '质差小区比例' as indicatorName,
               case when (array_length(four_quality_difference_rate, 1) = 1 and month[1] = ${currentMonth}) then concat(four_quality_difference_rate[1]::varchar, ';', five_quality_difference_rate[1]::varchar) when (array_length(five_quality_difference_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(four_quality_difference_rate[2]::varchar, ';', five_quality_difference_rate[2]::varchar) end currentIndicator,
               case when (array_length(quality_score, 1) = 1 and month[1] = ${currentMonth} ) then quality_score[1]::varchar when (array_length(quality_score, 1) = 1 and month[1] = ${lastMonth} ) then ''  else quality_score[2]::varchar end currentScore,
            case when (array_length(four_quality_difference_rate, 1) = 1 and month[1] = ${currentMonth}) then ''  else concat(four_quality_difference_rate[1], ';', five_quality_difference_rate[1]) end  lastIndicator,
               case when (array_length(quality_score, 1) = 1 and month[1] = ${currentMonth}) then '' else quality_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '数据治理' as indicatorName,
               case when (array_length(data_full_rate, 1) = 1 and month[1] = ${currentMonth}) then concat(data_full_rate[1]::varchar, ';', data_exact_rate[1]::varchar) when (array_length(data_full_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(data_full_rate[2]::varchar, ';', data_exact_rate[2]::varchar) end currentIndicator,
               case when (array_length(data_govern_score, 1) = 1 and month[1] = ${currentMonth} ) then data_govern_score[1]::varchar when (array_length(data_govern_score, 1) = 1 and month[1] = ${lastMonth} ) then ''  else data_govern_score[2]::varchar end currentScore,
            case when (array_length(data_full_rate, 1) = 1 and month[1] = ${currentMonth}) then ''  else concat(data_full_rate[1], ';', data_exact_rate[1]) end  lastIndicator,
        case when (array_length(data_govern_score, 1) = 1 and month[1] = ${currentMonth}) then '' else data_govern_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '4/5G基站AB类小区平均退服时长' as indicatorName,
               case when (array_length(cel_avg_duration, 1) = 1      and month[1] = ${currentMonth} ) then cel_avg_duration[1]::varchar when (array_length(cel_avg_duration, 1) = 1 and month[1] = ${lastMonth} ) then '' else cel_avg_duration[2]::varchar end currentIndicator,
            case when (array_length(cel_avg_duration_score,1) = 1 and month[1] = ${currentMonth} ) then cel_avg_duration_score[1]::varchar when (array_length(cel_avg_duration_score,1) = 1 and month[1] = ${lastMonth} ) then '' else cel_avg_duration_score[2]::varchar end currentScore,
            case when (array_length(cel_avg_duration,1) = 1       and month[1] = ${currentMonth} ) then '' else cel_avg_duration[1]::varchar end lastIndicator,
            case when (array_length(cel_avg_duration_score,1) = 1 and month[1] = ${currentMonth} ) then '' else cel_avg_duration_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '高负荷小区比例' as indicatorName,
               case when (array_length(four_high_load_rate, 1) = 1 and month[1] = ${currentMonth}) then concat(four_high_load_rate[1]::varchar, ';', five_high_load_rate[1]::varchar) when (array_length(four_high_load_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(four_high_load_rate[2]::varchar, ';', five_high_load_rate[2]::varchar) end currentIndicator,
               case when (array_length(high_load_score, 1) = 1 and month[1] = ${currentMonth} ) then high_load_score[1]::varchar when (array_length(high_load_score, 1) = 1 and month[1] = ${lastMonth} ) then ''  else high_load_score[2]::varchar end currentScore,
            case when (array_length(four_high_load_rate, 1) = 1 and month[1] = ${currentMonth}) then ''  else concat(four_high_load_rate[1], ';', five_high_load_rate[1]) end  lastIndicator,
               case when (array_length(high_load_score, 1) = 1 and month[1] = ${currentMonth}) then '' else high_load_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all

        select 'TOP栅格投诉处理' as indicatorName,
               case when (array_length(deal_complaint_rate, 1) = 1      and month[1] = ${currentMonth} ) then deal_complaint_rate[1]::varchar when (array_length(deal_complaint_rate, 1) = 1 and month[1] = ${lastMonth} ) then '' else deal_complaint_rate[2]::varchar end currentIndicator,
            case when (array_length(complaint_score,1) = 1 and month[1] = ${currentMonth} ) then complaint_score[1]::varchar when (array_length(complaint_score,1) = 1 and month[1] = ${lastMonth} ) then '' else complaint_score[2]::varchar end currentScore,
            case when (array_length(deal_complaint_rate,1) = 1       and month[1] = ${currentMonth} ) then '' else deal_complaint_rate[1]::varchar end lastIndicator,
            case when (array_length(complaint_score,1) = 1 and month[1] = ${currentMonth} ) then '' else complaint_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '满意度测评' as indicatorName,
               case when (array_length(quarter_lead, 1) = 1 and month[1] = ${currentMonth}) then quarter_lead[1]::varchar when (array_length(quarter_lead, 1) = 1 and month[1] = ${lastMonth}) then '' else quarter_lead[2]::varchar end currentIndicator,
            case when (array_length(satisfaction_score,1) = 1 and month[1] = ${currentMonth}) then satisfaction_score[1]::varchar when (array_length(satisfaction_score, 1) = 1 and month[1] = ${lastMonth}) then '' else satisfaction_score[2]::varchar end currentScore,
	        case when (array_length(quarter_lead,1) = 1 and month[1] = ${currentMonth}) then '' else quarter_lead[1]::varchar end lastIndicator,
	        case when (array_length(satisfaction_score,1) = 1 and month[1] = ${currentMonth}) then '' else satisfaction_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '移动用户故障处理(十分好评率)' as indicatorName,
               case when (array_length(move_barrier_favorable_rate, 1) = 1 and month[1] = ${currentMonth}) then move_barrier_favorable_rate[1]::varchar when (array_length(move_barrier_favorable_rate, 1) = 1 and month[1] = ${lastMonth}) then ''  else move_barrier_favorable_rate[2]::varchar end currentIndicator,
            case when (array_length(move_barrier_favorable_score,1) = 1            and month[1] = ${currentMonth}) then move_barrier_favorable_score[1]::varchar when (array_length(move_barrier_favorable_score,1) = 1  and month[1] = ${lastMonth}) then '' else move_barrier_favorable_score[2]::varchar end currentScore,
        case when (array_length(move_barrier_favorable_rate,1) = 1  and month[1] = ${currentMonth}) then '' else move_barrier_favorable_rate[1]::varchar end lastIndicator,
        case when (array_length(move_barrier_favorable_score,1) = 1            and month[1] = ${currentMonth}) then '' else move_barrier_favorable_score[1]::varchar end lastIndicator,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all

        select '“三超”故障(批量退服)' as indicatorName,
               case when (array_length(fault_out_serve_times_month, 1) = 1 and month[1] = ${currentMonth}) then concat(fault_out_serve_times_month[1]::varchar, ';', fault_out_serve_times_quarter[1]::varchar) when (array_length(fault_out_serve_times_month, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(fault_out_serve_times_month[2]::varchar, ';', fault_out_serve_times_quarter[2]::varchar) end currentIndicator,
               case when (array_length(fault_out_serve_times_score, 1) = 1 and month[1] = ${currentMonth} ) then fault_out_serve_times_score[1]::varchar when (array_length(fault_out_serve_times_score, 1) = 1 and month[1] = ${lastMonth} ) then ''  else fault_out_serve_times_score[2]::varchar end currentScore,
            case when (array_length(fault_out_serve_times_month, 1) = 1 and month[1] = ${currentMonth}) then ''  else concat(fault_out_serve_times_month[1], ';', fault_out_serve_times_quarter[1]) end  lastIndicator,
        case when (array_length(fault_out_serve_times_score, 1) = 1 and month[1] = ${currentMonth}) then '' else fault_out_serve_times_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '“三超”故障(频繁断站)' as indicatorName,
               case when (array_length(fault_often_break_rate, 1) = 1      and month[1] = ${currentMonth} ) then fault_often_break_rate[1]::varchar when (array_length(fault_often_break_rate, 1) = 1 and month[1] = ${lastMonth} ) then '' else fault_often_break_rate[2]::varchar end currentIndicator,
            case when (array_length(fault_often_break_score,1) = 1 and month[1] = ${currentMonth} ) then fault_often_break_score[1]::varchar when (array_length(fault_often_break_score,1) = 1 and month[1] = ${lastMonth} ) then '' else fault_often_break_score[2]::varchar end currentScore,
        case when (array_length(fault_often_break_rate,1) = 1       and month[1] = ${currentMonth} ) then '' else fault_often_break_rate[1]::varchar end lastIndicator,
        case when (array_length(fault_often_break_score,1) = 1 and month[1] = ${currentMonth} ) then '' else fault_often_break_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '“三超”故障(超长断站率)' as indicatorName,
               case when (array_length(over_length_rate, 1) = 1      and month[1] = ${currentMonth} ) then over_length_rate[1]::varchar when (array_length(over_length_rate, 1) = 1 and month[1] = ${lastMonth} ) then '' else over_length_rate[2]::varchar end currentIndicator,
            case when (array_length(over_length_score,1) = 1 and month[1] = ${currentMonth} ) then over_length_score[1]::varchar when (array_length(over_length_score,1) = 1 and month[1] = ${lastMonth} ) then '' else over_length_score[2]::varchar end currentScore,
        case when (array_length(over_length_rate,1) = 1       and month[1] = ${currentMonth} ) then '' else over_length_rate[1]::varchar end lastIndicator,
        case when (array_length(over_length_score,1) = 1 and month[1] = ${currentMonth} ) then '' else over_length_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '重点场景SINR质差比例' as indicatorName,
               case when (array_length(four_key_scene_quality_rate, 1) = 1 and month[1] = ${currentMonth}) then concat(four_key_scene_quality_rate[1]::varchar, ';', pressure_drop_value[1]::varchar) when (array_length(four_key_scene_quality_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(four_key_scene_quality_rate[2]::varchar, ';', pressure_drop_value[2]::varchar) end currentIndicator,
               case when (array_length(key_scene_quality_score, 1) = 1 and month[1] = ${currentMonth} ) then key_scene_quality_score[1]::varchar when (array_length(key_scene_quality_score, 1) = 1 and month[1] = ${lastMonth} ) then ''  else key_scene_quality_score[2]::varchar end currentScore,
            case when (array_length(four_key_scene_quality_rate, 1) = 1 and month[1] = ${currentMonth}) then ''  else concat(four_key_scene_quality_rate[1], ';', pressure_drop_value[1]) end  lastIndicator,
        case when (array_length(key_scene_quality_score, 1) = 1 and month[1] = ${currentMonth}) then '' else key_scene_quality_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all

        select '工单闭环率(维护)' as indicatorName,
               case when (array_length(new_maintain_order_close_rate, 1) = 1      and month[1] = ${currentMonth} ) then new_maintain_order_close_rate[1]::varchar when (array_length(new_maintain_order_close_rate, 1) = 1 and month[1] = ${lastMonth} ) then '' else new_maintain_order_close_rate[2]::varchar end currentIndicator,
            case when (array_length(new_maintain_order_close_score,1) = 1 and month[1] = ${currentMonth} ) then new_maintain_order_close_score[1]::varchar when (array_length(new_maintain_order_close_score,1) = 1 and month[1] = ${lastMonth} ) then '' else new_maintain_order_close_score[2]::varchar end currentScore,
        case when (array_length(new_maintain_order_close_rate,1) = 1       and month[1] = ${currentMonth} ) then '' else new_maintain_order_close_rate[1]::varchar end lastIndicator,
        case when (array_length(new_maintain_order_close_score,1) = 1 and month[1] = ${currentMonth} ) then '' else new_maintain_order_close_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba

        union all
        select '工单闭环率(普通、最严)' as    indicatorName,
               case when (array_length(order_close_rate, 1) = 1          and month[1] = ${currentMonth}) then concat(order_close_rate[1]::varchar, ';', strict_close_rate[1]::varchar) when (array_length(order_close_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(order_close_rate[2]::varchar, ';', strict_close_rate[2]::varchar) end currentIndicator,
               case when (array_length(close_score, 1) = 1 and month[1] = ${currentMonth}) then close_score[1]::varchar when (array_length(close_score, 1) = 1 and month[1] = ${lastMonth}) then '' else close_score[2]::varchar end currentScore,
            case when (array_length(order_close_rate, 1) = 1          and month[1] = ${currentMonth}) then '' else concat(order_close_rate[1], ';', strict_close_rate[1]) end lastIndicator,
        case when (array_length(close_score, 1) = 1 and month[1] = ${currentMonth}) then '' else close_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '45G弱覆盖且劣于竞对物业点占比' as    indicatorName,
               case when (array_length(four_weak_cover_rate, 1) = 1          and month[1] = ${currentMonth}) then concat(four_weak_cover_rate[1]::varchar, ';', five_weak_cover_rate[1]::varchar) when (array_length(four_weak_cover_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(four_weak_cover_rate[2]::varchar, ';', five_weak_cover_rate[2]::varchar) end currentIndicator,
               case when (array_length(weak_cover_score, 1) = 1 and month[1] = ${currentMonth}) then weak_cover_score[1]::varchar when (array_length(weak_cover_score, 1) = 1 and month[1] = ${lastMonth}) then '' else weak_cover_score[2]::varchar end currentScore,
            case when (array_length(four_weak_cover_rate, 1) = 1          and month[1] = ${currentMonth}) then '' else concat(four_weak_cover_rate[1], ';', five_weak_cover_rate[1]) end lastIndicator,
        case when (array_length(weak_cover_score, 1) = 1 and month[1] = ${currentMonth}) then '' else weak_cover_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '低效益站址压降(2025)' as    indicatorName,
               case when (array_length(new_poor_benefit_average, 1) = 1          and month[1] = ${currentMonth}) then concat(new_poor_benefit_average[1]::varchar, ';', new_poor_benefit_reach[1]::varchar) when (array_length(new_poor_benefit_average, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(new_poor_benefit_average[2]::varchar, ';', new_poor_benefit_reach[2]::varchar) end currentIndicator,
               case when (array_length(new_poor_benefit_score, 1) = 1 and month[1] = ${currentMonth}) then new_poor_benefit_score[1]::varchar when (array_length(new_poor_benefit_score, 1) = 1 and month[1] = ${lastMonth}) then '' else new_poor_benefit_score[2]::varchar end currentScore,
            case when (array_length(new_poor_benefit_average, 1) = 1          and month[1] = ${currentMonth}) then '' else concat(new_poor_benefit_average[1], ';', new_poor_benefit_reach[1]) end lastIndicator,
        case when (array_length(new_poor_benefit_score, 1) = 1 and month[1] = ${currentMonth}) then '' else new_poor_benefit_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
        union all
        select '移动用户故障处理(响应、处理、重复申告)' as    indicatorName,
               case when (array_length(in_deal_rate, 1) = 1  and month[1] = ${currentMonth}) then concat(in_deal_rate[1]::varchar, ';', in_response_rate[1]::varchar, ';' ,repetition_rate[1]::varchar) when (array_length(in_deal_rate, 1) = 1 and month[1] = ${lastMonth}) then '' else concat(in_deal_rate[2]::varchar, ';', in_response_rate[2]::varchar,';',repetition_rate[2]::varchar) end currentIndicator,
               case when (array_length(barrier_score, 1) = 1 and month[1] = ${currentMonth}) then barrier_score[1]::varchar when (array_length(barrier_score, 1) = 1 and month[1] = ${lastMonth}) then '' else barrier_score[2]::varchar end currentScore,
            case when (array_length(in_deal_rate, 1) = 1  and month[1] = ${currentMonth}) then '' else concat(in_deal_rate[1], ';', in_response_rate[1] , ';', repetition_rate[1]) end lastIndicator,
            case when (array_length(barrier_score, 1) = 1 and month[1] = ${currentMonth}) then '' else barrier_score[1]::varchar end lastScore,
        ${currentMonth} as currentMonth,
        ${lastMonth} lastMonth
        from tba
    </select>


</mapper>
